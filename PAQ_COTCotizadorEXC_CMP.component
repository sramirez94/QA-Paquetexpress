<!--
  @description       : 
  @author            : ChangeMeIn@UserSettingsUnder.SFDoc
  @group             : 
  @last modified on  : 09-21-2020
  @last modified by  : ChangeMeIn@UserSettingsUnder.SFDoc
  Modifications Log 
  Ver   Date         Author                               Modification
  1.0   09-17-2020   ChangeMeIn@UserSettingsUnder.SFDoc   Initial Version
-->
<apex:component controller="PAQ_CotizadorNacional_CTR">
    <div ng-controller="EXCController as EXC">
        <div class="row" ng-show="EX.step1">
            <div class="col-md-12 col-sm-12">
                <!-- Costos -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <a data-toggle="collapse" href="#Guide"><h3 class="panel-title">GUÍA DE ARRANQUE</h3></a>
                    </div>
                    <div id="Guide" class="panel-collapse collapse in">
                        <div class="panel-body">
                            <!--header-->
                            <div class="row">
                                <div class="col-sm-4 col-md-4 right">
                                    <div class="row">
                                        <div class="col-sm-8 col-md-8">
                                            <div class="alert alert-danger" role="alert" ng-show="validateKG(EX.fltMaxG)">
                                                <span> El peso debe ser un número mayor a 1</span>
                                            </div>
                                        </div>
                                        <div class="col-sm-4 col-md-4">
                                            <input type="number" class="custom-control-input rouded-med" ng-model="EX.fltMaxG" min="1" ng-class="{missing: validateKG(EX.fltMaxG), valid: !validateKG(EX.fltMaxG)}"/>
                                            <label class="custom-control-label" >Kg</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-3 col-md-3 left">
                                    <button type="button" class="btn btn-primary" ng-click="addBlock(EX.fltMaxG)">
                                        <span class="glyphicon glyphicon-plus"></span>
                                    </button>
                                    <label>Añadir más bloques de arranque</label>
                                </div>
                                <div class="col-sm- col-md-1 ">
                                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#ModalServicesEX"  >
                                        Servicios
                                    </button>
                                </div>
                                <div class="col-md-1 col-sm-1">
                                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#EXModalDestiny"  >
                                        Destinos
                                    </button>
                                </div>
                            </div>
                            <!-- Costo base y excedente -->
                            <div class="row">
                                <!--left-->
                                <div class="col-sm-9 col-md-9">
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                            <th colspan="15" class="center">COSTO BASE</th>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <th width="16%" class="thead-light verticalTH">Peso báscula kg</th>
                                                <td class="center" contenteditable="true" ng-repeat="(keyBlock, block) in EX.mapBlock" ng-bind="EX.mapBlock[keyBlock].fltMaxW | number" ng-blur="setValue('fltMaxW', keyRange, $event, keyBlock)"></td>
                                            </tr>
                                            <tr>
                                                <th width="16%" class="thead-light verticalTH">Volumen m3</th>
                                                <td class="center" contenteditable="true" ng-repeat="(keyBlock, block) in EX.mapBlock" ng-bind="EX.mapBlock[keyBlock].fltVolW | number:4" ng-blur="setValue('fltMaxV', keyRange, $event, keyBlock)"></td>
                                            </tr>
                                            <tr>
                                                <th width="16%" class="thead-light verticalTH">Kg volumétrico</th>
                                                <td class="center" ng-repeat="(keyBlock, block) in EX.mapBlock" ng-bind="EX.mapBlock[keyBlock].fltVolWeight | number:1"></td>
                                            </tr>
                                            <tr>
                                                <th width="16%" class="thead-light verticalTH">Remover</th>
                                                <td class="center" ng-repeat="(keyBlock, block) in EX.mapBlock">
                                                    <button type="button" class="btn btn-primary" ng-click="removeBlock(keyBlock)">
                                                        <span class="glyphicon glyphicon-minus"></span>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <br/>
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                            <tr>
                                                <th width="16%" class="center"> Kilómetros  </th>
                                                <th class="center" ng-repeat="(keyBlock, block) in EX.mapBlock" > Costo propuesto </th>
                                            </tr>
                                            <tr>
                                                <th width="16%" class="center"></th>
                                                <th class="center" ng-repeat="(keyBlock, block) in EX.mapBlock" > <input type="checkbox" ng-model="block.blnSameCost" ng-click="replicate('base', block.blnSameCost, keyBlock)"/>  </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                                <td class="verticalTH" ng-bind="strRange"></td>
                                                <td class="center" contenteditable="true" ng-repeat="(keyBlock, block) in EX.mapBlock" ng-bind="block.ranges[keyRange].fltCost | currency" ng-blur="setValue('fltCost', keyRange, $event, keyBlock)"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <br/>
                                </div>
                                <!--right-->
                                <div class="col-sm-3 col-md-3">
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                            <th colspan="2" class="center">COSTO EXCEDENTE</th>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <th class="thead-light" width="50%">Peso báscula kg</th>
                                                <td class="center">1</td>
                                            </tr>
                                            <tr>
                                                <th class="thead-light" width="50%">Volumen m3</th>
                                                <td class="center">0.005</td>
                                            </tr>
                                            <tr>
                                                <th class="thead-light" width="50%">Kg volumétrico</th>
                                                <td class="center">1</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <br/><br/>
                                    <br/><br/>
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                            <tr>
                                                <th class="center"> Kilómetros  </th>
                                                <th class="center"> Costo por kg</th>
                                                <th class="center"> Costo por m3</th>
                                            </tr>
                                            <tr>
                                                <th class="center"></th>
                                                <th class="center"><input type="checkbox" ng-model="EX.blnSameAddCost" ng-click="replicate('Add', EX.blnSameAddCost)"/></th>
                                                <th class="center"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                                <td ng-bind="strRange" width="33%"></td>
                                                <td class="center" contenteditable="true" ng-bind="EX.mapService['Add'].ranges[keyRange].fltCostWeight | currency" ng-blur="setValue('fltCostWeight', keyRange, $event, 'Add')"></td>
                                                <td class="center" ng-bind="EX.mapService['Add'].ranges[keyRange].fltCostVol | currency"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!-- Costo adicional -->
                            <div class="row">
                                <!-- left -->
                                <div class="col-sm-4 col-md-4">
                                    <br/>
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                            <tr>
                                                <th class="center" colspan="2" data-toggle="collapse" data-target="#zpCost">
                                                    <a href="#zpCost"> Zona Plus </a>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="zpCost" class="collapse">
                                            <tr>
                                                <th class="center"> Costo adicional </th>
                                                <th class="center"> Forma </th>
                                            </tr>
                                            <tr>
                                                <td width="20%" class="center">
                                                    EAD Zona plus
                                                </td>
                                                <td width="40%" class="center">
                                                    <select class="select" style="width: 70%" disabled="true">
                                                        <option value="B"> Por Bulto </option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th class="center thead-light"> Kilómetros  </th>
                                                <th class="center thead-light" > Costo propuesto</th>
                                            </tr>
                                            <tr>
                                                <td width="40%"> Replicar</td>
                                                <td class="center" width="60%"><input type="checkbox" ng-model="EX.mapService['ZP'].blnSameCost" ng-click="replicate('ZP', EX.mapService['ZP'].blnSameCost)"/> </td>
                                            </tr>
                                            <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                                <td width="40%" ng-bind="strRange"></td>
                                                <td width="60%" class="center" contenteditable="true" ng-bind="EX.mapService['ZP'].ranges[keyRange].fltCost | currency" ng-blur="setValue('fltCostRange', keyRange, $event, 'ZP')"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- center -->
                                <div class="col-sm-4 col-md-4">
                                    <br/>
                                    <table class="table table-striped table-bordered" ng-show="EX.blnACK">
                                        <thead class="thead-light">
                                            <tr>
                                                <th class="center"> Tipo Acuse </th>
                                                <th class="center"> Forma </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        <tr >
                                            <td width="20%" class="center">
                                                <select ng-options="option.label for option in EX.mapService['ACK'].optOption.aviableOptions" class="select" ng-model="EX.mapService['ACK'].optOption.model" ng-required="true" ng-change="setACK(EX.mapService['ACK'].optOption.model)"></select>
                                            </td>
                                            <td width="40%" class="center">
                                                <select ng-options="option.label for option in  EX.mapService['ACK'].optForma.aviableOptions" class="select" ng-model="EX.mapService['ACK'].optForma.model" ng-required="true" style="width: 70%" ng-change="setACKmode(EX.mapService['ACK'].optForma.model)"></select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th class="center thead-light"> Kilómetros  </th>
                                            <th class="center thead-light" > Costo propuesto</th>
                                        </tr>
                                        <tr>
                                            <td width="40%"> Replicar</td>
                                            <td class="center" width="60%"><input type="checkbox" ng-model="EX.mapService['ACK'].blnSameCost"  ng-click="replicate('ACK', EX.mapService['ACK'].blnSameCost)"/> </td>
                                        </tr>
                                        <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                            <td width="40%" ng-bind="strRange"></td>
                                            <td width="60%" class="center" contenteditable="true" ng-bind="EX.mapService['ACK'].ranges[keyRange].fltCost | currency" ng-blur="setValue('fltCostRange', keyRange, $event, 'ACK')"></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!-- right -->
                                <div class="col-sm-4 col-md-4">
                                    <br/>
                                    <table class="table table-striped table-bordered" ng-show="false">
                                    <!--<table class="table table-striped table-bordered" ng-show="EX.blnACK && isACK('G')">-->
                                        <tbody>
                                            <tr>
                                                <th class="thead-light" width="70%">Promedio de envíos con acuse</th>
                                                <td class="center" contenteditable="true" ng-bind="EX.mapService['ACK'].fltAVGDeliveryByACK | percentage" ng-blur="setValue('AVGDeliveryACK', null, $event, 'ACK')"></td>
                                            </tr>
                                            <tr>
                                                <th class="thead-light" width="70%">Paquetes promedio por guía
                                                </th>
                                                <td class="center" contenteditable="true" ng-bind="EX.mapService['ACK'].fltAVGPackByDay | number" ng-blur="setValue('AVGPack', null, $event, 'ACK')"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <br/>
                                    <div class="row">
                                        <div class="col-sm-6 col-md-6 bold right">BULTOS</div>
                                        <div class="col-sm-6 col-md-6" ng-bind="EX.TOTAL['PAQUETES'] | number" ></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-6 col-md-6 bold right">TOTAL NORMAL</div>
                                        <div class="col-sm-6 col-md-6" ng-bind="EX.TOTAL['NORMAL'] | currency" ></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-6 col-md-6 bold right">TOTAL PROPUESTO</div>
                                        <div class="col-sm-6 col-md-6" ng-bind="EX.TOTAL['PROPUESTA'] | currency" ></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-6 col-md-6 bold right">DESCUENTO GLOBAL</div>
                                        <div class="col-sm-6 col-md-6" ng-bind="EX.TOTAL['DESCUENTO'] | percentage:2" ></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Frecuencia -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <a data-toggle="collapse" href="#Frecc"><h3 class="panel-title">FRECUENCIA ENVÍOS</h3></a>
                    </div>
                    <div id="Frecc" class="panel-collapse collapse in">
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-sm-12 col-md-12" ng-show="EX.hasOverWBlocks">
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                            <tr>
                                                <th colspan="12" class="center" data-toggle="collapse" data-target="#PAQT6Table">
                                                    <a href="#PAQT6Table">COBERTURA PAQUETEXPRESS</a>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="PAQT6Table" class="collapse in" >
                                            <tr>
                                                <th class="center"> Kilómetros  </th>
                                                <th class="center" ng-repeat="(keyFee, frecc) in EX.mapFrecc" ng-bind="keyFee" ng-show="isFrecc(keyFee)"></th>
                                                <th class="center">PAQUETES</th>
                                                <th class="center">FRECUENCIA</th>
                                            </tr>
                                            <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                                <td class="verticalTH" ng-bind="strRange"></td>
                                                <td class="center" width="7%" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFrecc"  ng-bind="frecc.ranges[keyRange].intFrecuency | number" ng-blur="setValue('intFrecuency', keyRange, $event, keyFee)" ng-show="isFrecc(keyFee)"></td>
                                                <td class="center thead-light" width="7%" ng-bind="EX.mapRanges[keyRange]['PAQ'].intQTotal | number"></td>
                                                <td class="center thead-light" width="7%" contenteditable="true" ng-bind="EX.mapRanges[keyRange]['PAQ'].fltFrecc | percentage:2" ng-blur="setValue('fltFreccRange', keyRange, $event, keyFee)"></td>
                                            </tr>
                                            <tr>
                                                <td class="thead-light">Total</td>
                                                <td class="center thead-light" ng-repeat="(keyFee, frecc) in EX.mapFrecc"  ng-bind="frecc.intQTotal | number" ng-show="isFrecc(keyFee)" ></td>
                                                <td class="center thead-light" contenteditable="true" ng-bind="EX.mapFrecc.intQTotal | number" ng-blur="setValue('intQTotal', keyRange, $event, keyFee)"></td>
                                                <td class="center" ng-bind="EX.mapFrecc.fltFTotal | percentage:2"></td>
                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td class="center thead-light" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFrecc" ng-bind="frecc.fltFrecc | percentage:2" ng-show="isFrecc(keyFee)" ng-blur="setValue('fltFreccFee', keyRange, $event, keyFee)"></td>
                                                <td class="center" ng-bind="EX.mapFrecc.fltFEETotal | percentage:2" ></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-sm-9 col-md-9" ng-hide="EX.hasOverWBlocks">
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                        <tr>
                                            <th colspan="12" class="center" data-toggle="collapse" data-target="#PAQT7Table">
                                                <a href="#PAQT7Table">COBERTURA PAQUETEXPRESS</a>
                                            </th>
                                        </tr>
                                        </thead>
                                        <tbody id="PAQT7Table" class="collapse in" >
                                        <tr>
                                            <th class="center"> Kilómetros  </th>
                                            <th class="center" ng-repeat="(keyFee, frecc) in EX.mapFrecc" ng-bind="keyFee" ng-show="isFrecc(keyFee)"></th>
                                            <th class="center">PAQUETES</th>
                                            <th class="center">FRECUENCIA</th>
                                        </tr>
                                        <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                            <td class="verticalTH" ng-bind="strRange"></td>
                                            <td class="center" width="7%" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFrecc"  ng-bind="frecc.ranges[keyRange].intFrecuency | number" ng-blur="setValue('intFrecuency', keyRange, $event, keyFee)" ng-show="isFrecc(keyFee)"></td>
                                            <td class="center thead-light" width="7%" ng-bind="EX.mapRanges[keyRange]['PAQ'].intQTotal | number"></td>
                                            <td class="center thead-light" width="7%" contenteditable="true" ng-bind="EX.mapRanges[keyRange]['PAQ'].fltFrecc | percentage:2" ng-blur="setValue('fltFreccRange', keyRange, $event, keyFee)"></td>
                                        </tr>
                                        <tr>
                                            <td class="thead-light">Total</td>
                                            <td class="center thead-light" ng-repeat="(keyFee, frecc) in EX.mapFrecc"  ng-bind="frecc.intQTotal | number" ng-show="isFrecc(keyFee)" ></td>
                                            <td class="center thead-light" contenteditable="true" ng-bind="EX.mapFrecc.intQTotal | number" ng-blur="setValue('intQTotal', keyRange, $event, keyFee)"></td>
                                            <td class="center" ng-bind="EX.mapFrecc.fltFTotal | percentage:2"></td>
                                        </tr>
                                        <tr>
                                            <td></td>
                                            <td class="center thead-light" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFrecc" ng-bind="frecc.fltFrecc | percentage:2" ng-show="isFrecc(keyFee)" ng-blur="setValue('fltFreccFee', keyRange, $event, keyFee)"></td>
                                            <td class="center" ng-bind="EX.mapFrecc.fltFEETotal | percentage:2" ></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-sm-3 col-md-3" ng-hide="EX.hasOverWBlocks">
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                            <tr>
                                                <th colspan="12" class="center" data-toggle="collapse" data-target="#T7Table">
                                                    <a href="#T7Table"> T7 </a>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="T7Table">
                                            <tr class="thead-light">
                                                <th class="center"> Kilómetros  </th>
                                                <th class="center"> Peso <input type="checkbox" ng-model="EX.mapFrecc['T7'].blnSameWeight" ng-click="replicate('AVGWeight', EX.mapFrecc['T7'].blnSameWeight, 'T7')"/></th>
                                                <th class="center"> Volumen <input type="checkbox" ng-model="EX.mapFrecc['T7'].blnSameVol" ng-click="replicate('AVGVol', EX.mapFrecc['T7'].blnSameVol, 'T7')"/> </th>
                                            </tr>
                                            <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                                <td ng-bind="strRange" width="33%"></td>
                                                <td class="center" contenteditable="true" ng-bind="EX.mapFrecc['T7'].ranges[keyRange].fltAVGWeight | number:2" ng-blur="setValue('fltAVGWeight', keyRange, $event, 'T7')"></td>
                                                <td class="center" contenteditable="true" ng-bind="EX.mapFrecc['T7'].ranges[keyRange].fltAVGVol | number:2" ng-blur="setValue('fltAVGVol', keyRange, $event, 'T7')"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="row" ng-show="EX.hasOverWBlocks">
                                <!--left-->
                                <div class="col-sm-4 col-md-4">
                                        <table class="table table-striped table-bordered">
                                            <thead class="thead-light">
                                            <tr>
                                                <th colspan="12" class="center" data-toggle="collapse" data-target="#OWFrecc">
                                                    <a href="#OWFrecc">FRECUENCIA T7</a>
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody id="OWFrecc" class="collapse in" >
                                                <tr>
                                                    <th></th>
                                                    <th class="center" ng-repeat="(keyOW, oWBlock) in EX.OWFrecc" ng-bind="oWBlock.strName" ng-show="oWBlock.strName != undefined"></th>
                                                </tr>
                                                <tr>
                                                    <th class="center" width="25%"> Kilómetros  </th>
                                                    <th class="center" ng-repeat="(keyOW, oWBlock) in EX.OWFrecc" ng-show="oWBlock.strName != undefined">
                                                        <input type="checkbox" ng-model="oWBlock.blnSameFrecc" ng-click="replicate('OWFrecc', oWBlock.blnSameFrecc, keyOW)"/>
                                                    </th>
                                                </tr>
                                                <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                                    <td class="verticalTH" ng-bind="strRange"></td>
                                                    <td class="center" contenteditable="true" ng-repeat="(keyOW, oWBlock) in EX.OWFrecc"  ng-bind="oWBlock.ranges[keyRange].intFrecuency | number" ng-blur="setValue('intFrecuencyOW', keyRange, $event, keyOW)" ng-show="oWBlock.strName != undefined"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                <!--left-->
                                <div class="col-sm-8 col-md-8">
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                        <tr>
                                            <th colspan="12" class="center" data-toggle="collapse" data-target="#OWDimensions">
                                                <a href="#OWDimensions">DIMENSIONES PROMEDIO T7</a>
                                            </th>
                                        </tr>

                                        </thead>
                                        <tbody id="OWDimensions" class="collapse in" >
                                        <tr class="thead-light">
                                            <th></th>
                                            <th class="center" ng-repeat="(keyOW, oWBlock) in EX.OWFrecc" ng-bind="oWBlock.strName" ng-show="oWBlock.strName"></th>
                                        </tr>
                                        <tr>
                                            <th class="center" width="20%"> Kilómetros  </th>
                                            <td class="center" ng-repeat="(keyOW, oWBlock) in EX.OWFrecc" ng-show="oWBlock.strName">
                                                <table width="100%">
                                                    <tr>
                                                        <th class="center">Peso <input type="checkbox" ng-model="oWBlock.blnSameWeight" ng-click="replicate('AVGWeightOW', oWBlock.blnSameWeight, keyOW)"/></th>
                                                        <th class="center">Vol <input type="checkbox" ng-model="oWBlock.blnSameVol" ng-click="replicate('AVGVolOW', oWBlock.blnSameVol, keyOW)"/></th>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                        <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                            <td class="verticalTH" ng-bind="strRange"></td>
                                            <td ng-repeat="(keyOW, oWBlock) in EX.OWFrecc" ng-show="oWBlock.strName">
                                                <table width="100%">
                                                    <tr>
                                                        <td class="center" contenteditable="true" ng-bind="oWBlock.ranges[keyRange].fltAVGWeight | number:2" ng-blur="setValue('AVGWeightOW', keyRange, $event, keyOW)"></td>
                                                        <td class="center" contenteditable="true" ng-bind="oWBlock.ranges[keyRange].fltAVGVol | number:2" ng-blur="setValue('AVGVolOW', keyRange, $event, keyOW)"></td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-12 col-md-12" ng-show="EX.hasOverWBlocks">
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                            <tr>
                                                <th colspan="12" class="center" data-toggle="collapse" data-target="#ZPTable"><a href="#ZPTable">COBERTURA ZONA PLUS</a> </th>
                                            </tr>
                                        </thead>
                                        <tbody id="ZPTable" class="collapse in" >
                                            <tr>
                                                <th class="center"> Kilómetros  </th>
                                                <th class="center" ng-repeat="(keyFee, frecc) in EX.mapFreccZP" ng-bind="keyFee" ng-show="isFrecc(keyFee)" ></th>
                                                <th class="center">PAQUETES</th>
                                                <th class="center">FRECUENCIA</th>
                                            </tr>
                                            <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                                <td class="verticalTH" ng-bind="strRange"></td>
                                                <td class="center" width="7%" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFreccZP"  ng-bind="frecc.ranges[keyRange].intFrecuency | number" ng-blur="setValue('intFrecuencyZP', keyRange, $event, keyFee)" ng-show="isFrecc(keyFee)"></td>
                                                <td class="center thead-light" width="7%" ng-bind="EX.mapRanges[keyRange]['ZP'].intQTotal | number"></td>
                                                <td class="center thead-light" width="7%" contenteditable="true" ng-bind="EX.mapRanges[keyRange]['ZP'].fltFrecc | percentage:2" ng-blur="setValue('fltFreccRangeZP', keyRange, $event, keyFee)"></td>
                                            </tr>
                                            <tr>
                                                <td class="thead-light">Total</td>
                                                <td class="center thead-light" ng-repeat="(keyFee, frecc) in EX.mapFreccZP"  ng-bind="frecc.intQTotal | number" ng-show="isFrecc(keyFee)"></td>
                                                <td class="center thead-light" contenteditable="true" ng-bind="EX.mapFreccZP.intQTotal | number" ng-blur="setValue('intQTotalZP', keyRange, $event, keyFee)"></td>
                                                <td class="center" ng-bind="EX.mapFreccZP.fltFTotal | percentage:2" ></td>
                                            </tr>
                                            <tr>
                                                <td/>
                                                <td class="center thead-light" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFreccZP" ng-bind="EX.mapFreccZP[keyFee].fltFrecc | percentage:2" ng-show="isFrecc(keyFee)" ng-blur="setValue('fltFreccFeeZP', keyRange, $event, keyFee)"></td>
                                                <td class="center" ng-bind="EX.mapFreccZP.fltFEETotal | percentage:2" ></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-sm-9 col-md-9" ng-hide="EX.hasOverWBlocks">
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                        <tr>
                                            <th colspan="12" class="center" data-toggle="collapse" data-target="#ZPTableSmall"><a href="#ZPTableSmall">COBERTURA ZONA PLUS</a> </th>
                                        </tr>
                                        </thead>
                                        <tbody id="ZPTableSmall" class="collapse in" >
                                        <tr>
                                            <th class="center"> Kilómetros  </th>
                                            <th class="center" ng-repeat="(keyFee, frecc) in EX.mapFreccZP" ng-bind="keyFee" ng-show="isFrecc(keyFee)" ></th>
                                            <th></th>
                                            <th class="center">PAQUETES</th>
                                            <th class="center">FRECUENCIA</th>
                                        </tr>
                                        <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                            <td class="verticalTH" ng-bind="strRange"></td>
                                            <td class="center" width="7%" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFreccZP"  ng-bind="frecc.ranges[keyRange].intFrecuency | number" ng-blur="setValue('intFrecuencyZP', keyRange, $event, keyFee)" ng-show="isFrecc(keyFee)"></td>
                                            <td width="7%"/>
                                            <td class="center thead-light" width="7%" ng-bind="EX.mapRanges[keyRange]['ZP'].intQTotal | number"></td>
                                            <td class="center thead-light" width="7%" contenteditable="true" ng-bind="EX.mapRanges[keyRange]['ZP'].fltFrecc | percentage:2" ng-blur="setValue('fltFreccRangeZP', keyRange, $event, keyFee)"></td>
                                        </tr>
                                        <tr>
                                            <td class="thead-light">Total</td>
                                            <td class="center thead-light" ng-repeat="(keyFee, frecc) in EX.mapFreccZP"  ng-bind="frecc.intQTotal | number" ng-show="isFrecc(keyFee)"></td>
                                            <td/>
                                            <td class="center thead-light" contenteditable="true" ng-bind="EX.mapFreccZP.intQTotal | number" ng-blur="setValue('intQTotalZP', keyRange, $event, keyFee)"></td>
                                            <td class="center" ng-bind="EX.mapFreccZP.fltFTotal | percentage:2" ></td>
                                        </tr>
                                        <tr>
                                            <td/>
                                            <td class="center thead-light" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFreccZP" ng-bind="EX.mapFreccZP[keyFee].fltFrecc | percentage:2" ng-show="isFrecc(keyFee)" ng-blur="setValue('fltFreccFeeZP', keyRange, $event, keyFee)"></td>
                                            <td/>
                                            <td class="center" ng-bind="EX.mapFreccZP.fltFEETotal | percentage:2" ></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--29/09/2020 Salvador: Tabla para captura de propuesta T7 Zona plus-->
                    <!--<div class="row">
                        <div class="col-sm-12 col-md-12" ng-show="EX.hasOverWBlocks">
                            <table class="table table-striped table-bordered">
                                <thead class="thead-light">
                                    <tr>
                                        <th colspan="12" class="center" data-toggle="collapse" data-target="#ZPTable"><a href="#ZPTable">TARIFA T7 ZONA PLUS</a> </th>
                                    </tr>
                                </thead>
                                <tbody id="ZPTable" class="collapse in" >
                                    <tr>
                                        <th class="center">Origen</th>
                                        <th class="center">Tender destino</th>
                                        <th class="center">Rango km</th>
                                        <th class="center"># Paquetes</th>
                                        <th class="center">Largo</th>
                                        <th class="center">Ancho</th>
                                        <th class="center">Alto</th>
                                        <th class="center">Peso</th>
                                    </tr>
                                    <tr ng-repeat="(keyRange, strRange) in EX.listTender">
                                        <!--<td class="verticalTH" ng-bind="strRange"></td>
                                        <td class="center" width="7%" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFreccZP"  ng-bind="frecc.ranges[keyRange].intFrecuency | number" ng-blur="setValue('intFrecuencyZP', keyRange, $event, keyFee)" ng-show="isFrecc(keyFee)"></td>
                                        <td class="center thead-light" width="7%" ng-bind="EX.mapRanges[keyRange]['ZP'].intQTotal | number"></td>
                                        <td class="center thead-light" width="7%" contenteditable="true" ng-bind="EX.mapRanges[keyRange]['ZP'].fltFrecc | percentage:2" ng-blur="setValue('fltFreccRangeZP', keyRange, $event, keyFee)"></td>-->
                        <!--            </tr>
                                    <!--<tr>
                                        <td class="thead-light">Total</td>
                                        <td class="center thead-light" ng-repeat="(keyFee, frecc) in EX.mapFreccZP"  ng-bind="frecc.intQTotal | number" ng-show="isFrecc(keyFee)"></td>
                                        <td class="center thead-light" contenteditable="true" ng-bind="EX.mapFreccZP.intQTotal | number" ng-blur="setValue('intQTotalZP', keyRange, $event, keyFee)"></td>
                                        <td class="center" ng-bind="EX.mapFreccZP.fltFTotal | percentage:2" ></td>
                                    </tr>
                                    <tr>
                                        <td/>
                                        <td class="center thead-light" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFreccZP" ng-bind="EX.mapFreccZP[keyFee].fltFrecc | percentage:2" ng-show="isFrecc(keyFee)" ng-blur="setValue('fltFreccFeeZP', keyRange, $event, keyFee)"></td>
                                        <td class="center" ng-bind="EX.mapFreccZP.fltFEETotal | percentage:2" ></td>
                                    </tr>-->
                        <!--        </tbody>
                            </table>
                        </div>
                        <!--<div class="col-sm-9 col-md-9" ng-hide="EX.hasOverWBlocks">
                            <table class="table table-striped table-bordered">
                                <thead class="thead-light">
                                <tr>
                                    <th colspan="12" class="center" data-toggle="collapse" data-target="#ZPTableSmall"><a href="#ZPTableSmall">COBERTURA ZONA PLUS</a> </th>
                                </tr>
                                </thead>
                                <tbody id="ZPTableSmall" class="collapse in" >
                                <tr>
                                    <th class="center"> Kilómetros  </th>
                                    <th class="center" ng-repeat="(keyFee, frecc) in EX.mapFreccZP" ng-bind="keyFee" ng-show="isFrecc(keyFee)" ></th>
                                    <th></th>
                                    <th class="center">PAQUETES</th>
                                    <th class="center">FRECUENCIA</th>
                                </tr>
                                <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                    <td class="verticalTH" ng-bind="strRange"></td>
                                    <td class="center" width="7%" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFreccZP"  ng-bind="frecc.ranges[keyRange].intFrecuency | number" ng-blur="setValue('intFrecuencyZP', keyRange, $event, keyFee)" ng-show="isFrecc(keyFee)"></td>
                                    <td width="7%"/>
                                    <td class="center thead-light" width="7%" ng-bind="EX.mapRanges[keyRange]['ZP'].intQTotal | number"></td>
                                    <td class="center thead-light" width="7%" contenteditable="true" ng-bind="EX.mapRanges[keyRange]['ZP'].fltFrecc | percentage:2" ng-blur="setValue('fltFreccRangeZP', keyRange, $event, keyFee)"></td>
                                </tr>
                                <tr>
                                    <td class="thead-light">Total</td>
                                    <td class="center thead-light" ng-repeat="(keyFee, frecc) in EX.mapFreccZP"  ng-bind="frecc.intQTotal | number" ng-show="isFrecc(keyFee)"></td>
                                    <td/>
                                    <td class="center thead-light" contenteditable="true" ng-bind="EX.mapFreccZP.intQTotal | number" ng-blur="setValue('intQTotalZP', keyRange, $event, keyFee)"></td>
                                    <td class="center" ng-bind="EX.mapFreccZP.fltFTotal | percentage:2" ></td>
                                </tr>
                                <tr>
                                    <td/>
                                    <td class="center thead-light" contenteditable="true" ng-repeat="(keyFee, frecc) in EX.mapFreccZP" ng-bind="EX.mapFreccZP[keyFee].fltFrecc | percentage:2" ng-show="isFrecc(keyFee)" ng-blur="setValue('fltFreccFeeZP', keyRange, $event, keyFee)"></td>
                                    <td/>
                                    <td class="center" ng-bind="EX.mapFreccZP.fltFEETotal | percentage:2" ></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!--29/09/2020 Salvador: Tabla para captura de propuesta T7 Zona plus-->
                <!--div class="col-md-6 col-sm-6">
                    <div class="panel panel-default" ng-show="EX.hasOverWBlocks" style="overflow: scroll;">
                        <div class="panel-heading">
                            <a data-toggle="collapse" href="#T7ZP"><h3 class="panel-title" >PROPUESTA</h3></a>
                        </div>
                        <div id="T7ZPPROP" class="panel-collapse collapse in">
                            <div class="panel-body">
                                <table class="table table-striped" >
                                    <thead class="thead-light">
                                    <tr>
                                        <th>Rango KM</th>
                                        <th>Costo propuesto por kg</th>
                                        <th>Total propuesta</th>
                                        <th>Total tarifa llena</th>
                                        <th>Descuento</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td colspan="1">Replicar</td>
                                        <!--<td class="thead-light center"><input type="checkbox" ng-model="EX.mapPropuesta['PROP'].blnSameQuote" ng-click="replicate('Quote7ZP', EX.mapPropuesta['PROP'].ranges['0-400'].fltCost, strFeeKey)" /></td>-->
                                        <!--<td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    <tr ng-repeat="(keyRange, strRange) in EX.listRange">
                                        <td class="thead-light" ng-bind="strRange"></td>
                                        <td class="thead-light center" contenteditable="true" ng-bind="EX.mapPropuesta['PROP'].ranges[keyRange].fltCost | currency" ng-blur="setValue('fltCostoPropuestoXKg', strRange, $event, 'T7ZP')"></td>
                                        <td class="center" ng-bind="EX.mapPropuesta['PROP'].ranges[keyRange].fltTotalPropuesta | currency" ng-blur=""></td>
                                        <td class="center" ng-bind="EX.mapPropuesta['PROP'].ranges[keyRange].fltTotalTarifaLlena | currency" ng-blur=""></td>
                                        <td class="center" ng-bind="EX.mapPropuesta['PROP'].ranges[keyRange].fltDescuento | percentage:2"></td>
                                    </tr>
                                    <tr>
                                        <td>Total</td>
                                        <td></td>
                                        <td class="center"><span ng-bind="EX.mapPropuesta['PROP'].fltFeeTotalNormal | currency"></span></td>
                                        <td class="center"><span ng-bind="EX.mapPropuesta['PROP'].fltFeeTotalQuote | currency"></span></td>
                                        <td class="center"><span ng-bind="EX.mapPropuesta['PROP'].fltFeeTotalDesc | percentage:2"></span></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!--29/09/2020 Salvador: Tabla para captura de frecuencia y datos T7 Zona plus-->
                <!--<div class="row">
                    <div class="col-md-12 col-sm-12">
                        <div class="panel panel-default" ng-show="EX.hasOverWBlocks" style="overflow: scroll;">
                            <div class="panel-heading"> 
                                <a data-toggle="collapse" href="#T7ZP"><h3 class="panel-title" >TARIFA T7 ZONA PLUS</h3></a>
                            </div>
                            <div id="T7ZP" class="panel-collapse collapse in">
                                <div class="panel-body">
                                    <div class="row" ng-show="">
                                        <table class="table table-striped">
                                            <thead class="thead-light">
                                            <tr>
                                                <th class="center">Origen</th>
                                                <th class="center">Tender destino</th>
                                                <th class="center">Rango KM</th>
                                                <th class="center">#Paquetes</th>
                                                <th class="center">Largo</th>
                                                <th class="center">Ancho</th>
                                                <th class="center">Alto</th>
                                                <th class="center">Peso</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                                <!--<tr>
                                                    <td colspan="1">Replicar</td>
                                                    <td></td>
                                                    <td></td>
                                                    <td class="thead-light center"><input type="checkbox" ng-model="EX.mapQuotes['T7ZP'].blnSameFrecuency" ng-click="replicate('frecuencyT7ZP', null, index, keytender)"/></td>
                                                    <td class="thead-light center"><input type="checkbox" ng-model="EX.mapQuotes['T7ZP'].blnSameLarge" ng-click="replicate('LargeT7ZP', null, index, keytender)"/></td>
                                                    <td class="thead-light center"><input type="checkbox" ng-model="EX.mapQuotes['T7ZP'].blnSameAncho" ng-click="replicate('AnchoT7ZP', null, index, keytender)"/></td>
                                                    <td class="thead-light center"><input type="checkbox" ng-model="EX.mapQuotes['T7ZP'].blnSameHigh" ng-click="replicate('AltoT7ZP', null, index, keytender)"/></td>
                                                    <td class="thead-light center"><input type="checkbox" ng-model="EX.mapQuotes['T7ZP'].blnSameWeigth" ng-click="replicate('PesoT7ZP', null, index, keytender)"/></td>
                                                </tr>-->
                                                <!--<tr ng-repeat="(keyTender, strTender) in EX.listTender">
                                                    <td class="thead-light center" contenteditable="true" ng-bind="EX.mapQuotes['T7ZP'].Tender[strTender].strOrigen" ng-blur="setValue('PPStrOrigen', keyTender, $event, 'T7ZP')"></td>
                                                    <td class="center" ng-bind="strTender"></td>
                                                    <td class="center" ng-bind="EX.mapQuotes['T7ZP'].Tender[strTender].strRange" ng-blur=""></td>
                                                    <td class="thead-light center" contenteditable="true" ng-bind="EX.mapQuotes['T7ZP'].Tender[strTender].intFrecuency | number" ng-blur="setValue('PPintFrecuency', strTender, $event, 'T7ZP')"></td>
                                                    <td class="thead-light center" contenteditable="true" ng-bind="EX.mapQuotes['T7ZP'].Tender[strTender].fltLargo | number" ng-blur="setValue('fltLargo', strTender, $event, 'T7ZP')"></td>
                                                    <td class="thead-light center" contenteditable="true" ng-bind="EX.mapQuotes['T7ZP'].Tender[strTender].fltAncho | number" ng-blur="setValue('fltAncho', strTender, $event, 'T7ZP')"></td>
                                                    <td class="thead-light center" contenteditable="true" ng-bind="EX.mapQuotes['T7ZP'].Tender[strTender].fltAlto | number" ng-blur="setValue('fltAlto', strTender, $event, 'T7ZP')"></td>
                                                    <td class="thead-light center" contenteditable="true" ng-bind="EX.mapQuotes['T7ZP'].Tender[strTender].fltPeso | number" ng-blur="setValue('PPfltPeso', strTender, $event, 'T7ZP')"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>-->
                </div>
                <!-- Descuentos -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <a data-toggle="collapse" href="#Desc"><h3 class="panel-title">DESCUENTOS </h3></a>
                    </div>
                    <div id="Desc" class="panel-collapse collapse in">
                        <div class="panel-body">
                            <div class="row">
                                <!--left-->
                                <div class="col-sm-6 col-md-6">
                                        <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                        <tr>
                                            <th colspan="6" class="center"> COBERTURA PAQUETEXPRESS </th>
                                        </tr>
                                        <tr>
                                            <th class="center"></th>
                                            <th class="center"> Peso (kg)</th>
                                            <th class="center" colspan="2">Descuento máximo</th>
                                            <th class="center" colspan="2">Descuento promedio</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat="(keyFee, fee) in ProjectionEX.PAQ">
                                                <td class="center" ng-bind="fee.strFee"></td>
                                                <td class="center" ng-bind="fee.fltWeight | number"></td>
                                                <td class="center"><span class="circle" ng-class="{green: isGreen(fee.fltMaxDisc), yellow: isYellow(fee.fltMaxDisc), red  : isRed(fee.fltMaxDisc)}"></span></td>
                                                <td class="center" ng-bind="fee.fltMaxDisc | percentage:2"></td>
                                                <td class="center"><span class="circle" ng-class="{green: isGreen(fee.fltDisc), yellow: isYellow(fee.fltDisc), red  : isRed(fee.fltDisc)}"></span></td>
                                                <td class="center" ng-bind="fee.fltDisc | percentage:2"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <!--right-->
                                <div class="col-sm-6 col-md-6">
                                    <table class="table table-striped table-bordered">
                                        <thead class="thead-light">
                                        <tr>
                                            <th colspan="6" class="center"> COBERTURA ZONA PLUS </th>
                                        </tr>
                                        <tr>
                                            <th class="center"></th>
                                            <th class="center"> Peso (kg)</th>
                                            <th class="center" colspan="2">Descuento máximo</th>
                                            <th class="center" colspan="2">Descuento promedio</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat="(keyFee, fee) in ProjectionEX.ZP">
                                                <td class="center" ng-bind="fee.strFee"></td>
                                                <td class="center" ng-bind="fee.fltWeight | number"></td>
                                                <td class="center"><span class="circle" ng-class="{green: isGreen(fee.fltMaxDisc), yellow: isYellow(fee.fltMaxDisc), red  : isRed(fee.fltMaxDisc)}"></span></td>
                                                <td class="center" ng-bind="fee.fltMaxDisc | percentage:2"></td>
                                                <td class="center"><span class="circle" ng-class="{green: isGreen(fee.fltDisc), yellow: isYellow(fee.fltDisc), red  : isRed(fee.fltDisc)}"></span></td>
                                                <td class="center" ng-bind="fee.fltDisc | percentage:2"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" ng-show="EX.step2">
            <div class="col-md-6 col-sm-6">
                <div class="row" ng-repeat="(strKey, pro) in EX.mapProjEX" ng-if="pro.strFee !=  'T7'">
                    <h3>TARIFA {{ pro.strFee }} ZP - {{ pro.fltMaxW }} kg </h3>
                    <table class="table table-striped table-bordered" style="overflow-x: scroll">
                                <thead class="thead-light">
                                <tr>
                                    <th>KM</th>
                                    <th>Tarifa</th>
                                    <th>#</th>
                                    <th>RAD</th>
                                    <th>EAD</th>
                                    <th>ACK</th>
                                    <th>Seguro</th>
                                    <th>T.llena</th>
                                    <th>BaseQ</th>
                                    <th>ACKQ</th>
                                    <th>FullQ</th>
                                    <th>TNORMAL</th>
                                    <th>TPROP</th>
                                    <th>Disc</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr ng-repeat="(keyRange, range) in pro.ranges">
                                    <td ng-bind="keyRange"></td>
                                    <td ng-bind="EX.mapFrecc[pro.strFee].ranges[keyRange].fltBaseFee | currency"></td>
                                    <td ng-bind="EX.mapFrecc[pro.strFee].ranges[keyRange].intFrecuency | number"></td>
                                    <td ng-bind="EX.mapFrecc[pro.strFee].ranges[keyRange].fltRAD | currency"></td>
                                    <td ng-bind="EX.mapFrecc[pro.strFee].ranges[keyRange].fltEAD | currency"></td>
                                    <td ng-bind="EX.mapFrecc[pro.strFee].ranges[keyRange].fltACK | currency"></td>
                                    <td ng-bind="EX.mapFrecc[pro.strFee].ranges[keyRange].fltSEG | currency"></td>
                                    <td ng-bind="EX.mapFrecc[pro.strFee].ranges[keyRange].fltFullFee | currency"></td>
                                    <td ng-bind="range.fltQuoteFee | currency"></td>
                                    <td ng-bind="range.fltACK | currency"></td>
                                    <td ng-bind="range.fltQuoteFullFee | currency"></td>
                                    <td ng-bind="EX.mapFrecc[pro.strFee].ranges[keyRange].fltTotalNormal | currency"></td>
                                    <td ng-bind="range.fltTotalQuote | currency"></td>
                                    <td ng-bind="range.fltDisc | percentage:2"></td>
                                </tr>
                                <tr>
                                    <td>Total</td>
                                    <td colspan="10" />
                                    <td ng-bind="pro.fltTotalNormal | currency"></td>
                                    <td ng-bind="pro.fltTotalQuote | currency"></td>
                                    <td ng-bind="pro.fltDisc | percentage:2"></td>
                                </tr>
                                </tbody>
                            </table>
                </div>
            </div>
            <div class="col-md-6 col-sm-6">
                <div class="row" ng-repeat="(strKey, pro) in EX.mapProjEXZP" >
                    <h3>TARIFA {{ pro.strFee }} ZP - {{ pro.fltMaxW }} kg </h3>
                    <table class="table table-striped table-bordered" style="overflow-x: scroll">
                                <thead class="thead-light">
                                <tr>
                                    <th>KM</th>
                                    <th>Tarifa</th>
                                    <th>#</th>
                                    <th>RAD</th>
                                    <th>EAD</th>
                                    <th>ACK</th>
                                    <th>Seguro</th>
                                    <th>T.llena</th>
                                    <th>BaseQ</th>
                                    <th>ACKQ</th>
                                    <th>FullQ</th>
                                    <th>TNORMAL</th>
                                    <th>TPROP</th>
                                    <th>Disc</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr ng-repeat="(keyRange, range) in pro.ranges">
                                    <td ng-bind="keyRange"></td>
                                    <td ng-bind="EX.mapFreccZP[pro.strFee].ranges[keyRange].fltBaseFee | currency"></td>
                                    <td ng-bind="EX.mapFreccZP[pro.strFee].ranges[keyRange].intFrecuency | number"></td>
                                    <td ng-bind="EX.mapFreccZP[pro.strFee].ranges[keyRange].fltRAD | currency"></td>
                                    <td ng-bind="EX.mapFreccZP[pro.strFee].ranges[keyRange].fltEAD | currency"></td>
                                    <td ng-bind="EX.mapFreccZP[pro.strFee].ranges[keyRange].fltACK | currency"></td>
                                    <td ng-bind="EX.mapFreccZP[pro.strFee].ranges[keyRange].fltSEG | currency"></td>
                                    <td ng-bind="EX.mapFreccZP[pro.strFee].ranges[keyRange].fltFullFee | currency"></td>
                                    <td ng-bind="range.fltQuoteFee | currency"></td>
                                    <td ng-bind="range.fltACK | currency"></td>
                                    <td ng-bind="range.fltQuoteFullFee | currency"></td>
                                    <td ng-bind="EX.mapFreccZP[pro.strFee].ranges[keyRange].fltTotalNormal | currency"></td>
                                    <td ng-bind="range.fltTotalQuote | currency"></td>
                                    <td ng-bind="range.fltDisc | percentage:2"></td>
                                </tr>
                                <tr>
                                    <td>Total</td>
                                    <td colspan="10" />
                                    <td ng-bind="pro.fltTotalNormal | currency"></td>
                                    <td ng-bind="pro.fltTotalQuote | currency"></td>
                                    <td ng-bind="pro.fltDisc | percentage:2"></td>
                                </tr>
                                </tbody>
                            </table>
                </div>
            </div>
        </div>
        <!-- messages -->
        <div class="row center">
            <div class="col-sm-12 col-md-12">
                <div class="alert alert-danger" role="alert" ng-repeat="(i, errorMessage) in DML.listErrors">
                    <span ng-bind="errorMessage"></span>
                </div>
                <div class="alert alert-success" role="alert" ng-show="DML.blnSuccess && sent">
                    <span ng-bind="SuccessMessage"></span>  <span ng-show="Wrapper.objQuote.Id"> Ver: <a href="/{{Wrapper.objQuote.Id}}">{{ Wrapper.objQuote.Name }}</a> </span>
                </div>
            </div>
        </div>
        <!--modal servicios-->
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="modal fade" id="ModalServicesEX" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog big-modal" role="document">
                        <div class="modal-content big-modal">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Agregar Servicios</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="bootstrap snippet">
                                    <div class="row">
                                        <div class="col-sm-4 col-sm-offset-1">
                                            <div class="list-group" id="list3">
                                                <a href="#" class="list-group-item active">Servicios Disponibles<input title="toggle all" type="checkbox" class="all pull-right" ng-model="EX.blnServiceAddAll" ng-click="addAll('add')"/></a>
                                                <a href="#" class="list-group-item" ng-repeat="(i, service) in EX.ServiceSelect.available" ng-click="clickFee(i, 'serviceAdd')">
                                                    <span ng-bind="service.label"></span>
                                                    <span class="glyphicon glyphicon-ok" ng-show="service.blnSelected"/>
                                                </a>
                                            </div>
                                        </div>
                                        <div class="col-md-2 v-center">
                                            <button title="Send to list 2" class="btn btn-default center-block add" ng-click="updateFees('add', 'service')"><i class="glyphicon glyphicon-chevron-right"></i></button>
                                            <button title="Send to list 1" class="btn btn-default center-block remove" ng-click="updateFees('remove', 'service')"><i class="glyphicon glyphicon-chevron-left"></i></button>
                                        </div>
                                        <div class="col-sm-4">
                                            <div class="list-group" id="list4">
                                                <a href="#" class="list-group-item active">Servicios Seleccionados <input title="toggle all" type="checkbox" class="all pull-right" ng-model="EX.blnServiceRemoveAll" ng-click="addAll('remove')"/></a>
                                                <a href="#" class="list-group-item" ng-repeat="(i, service) in EX.ServiceSelect.selected" ng-click="clickFee(i, 'serviceRemove')">
                                                    <span ng-bind="service.label"></span>
                                                    <span class="glyphicon glyphicon-remove" ng-show="service.blnSelected"/>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row custom-control custom-radio" ng-show="EX.blnSEG">
                                    <div class="col-sm-1 col-md-1" />
                                    <div class="col-sm-3 col-md-3"><label class="custom-control-label" >Monto asegurado</label></div>
                                    <div class="col-sm-3 col-md-3"><input type="number" class="custom-control-input rouded-med" ng-model="EX.fltSEG" ng-change="calculateEX();"/></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--modal destinos-->
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="modal fade" id="EXModalDestiny" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog big-modal" role="document">
                        <div class="modal-content big-modal">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Agregar Destinos</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-12 col-sm-12">
                                        <div class="row custom-control custom-radio">

                                            <div class="col-sm-3 col-md-3"><label class="custom-control-label" > Origen </label></div>
                                            <div class="col-sm-3 col-md-3"><input type="text" class="custom-control-input rouded" ng-model="EX.strOrigin" maxlength="3" ng-disabled="EX.OriginDisabled"/></div>

                                            <div class="col-sm-3 col-md-3"><label class="custom-control-label" > Destino </label></div>
                                            <div class="col-sm-3 col-md-3"><input type="text" class="custom-control-input rouded" ng-model="EX.strDestiny" maxlength="3"/></div>
                                        </div>
                                        <br/>
                                        <div class="row" ng-show="EX.OriginDisabled">
                                            <div class="col-md-4 col-sm-4">
                                                <div class="alert alert-warning" role="alert" >
                                                    <span class="glyphicon glyphicon-exclamation-sign"> Si modifica el Origen se eliminarán los destinos agregados</span>
                                                </div>
                                            </div>
                                            <div class="col-md-2 col-sm-2 ccenter">
                                                <button class="btn btn-primary" ng-click="editOrigin()">
                                                    Modificar Origen
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row custom-control custom-radio">

                                            <div class="col-sm-6 col-md-6">
                                                <table class="table table-striped" >
                                                    <thead>
                                                    <tr>
                                                        <th> Destinos </th>
                                                        <th> Rango Km </th>
                                                        <th> Eliminar </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    <tr ng-repeat="(strDestinyKey, destiny) in EX.listDestiny" >
                                                        <td ng-bind="strDestinyKey"></td>
                                                        <td ng-bind="destiny.range"></td>
                                                        <td>
                                                            <button class="btn btn-danger" ng-click="removeDestiny(strDestinyKey)">
                                                                <span class="glyphicon glyphicon-minus"></span>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="col-sm-6 col-md-6">
                                                <div class="row">
                                                    <button type="button" class="btn btn-primary"
                                                            ng-click="addDestiny()">
                                                        Agregar destino <span class="glyphicon glyphicon-plus"></span>
                                                    </button>
                                                </div>
                                                <div class="row">
                                                    <div class="alert alert-danger" role="alert" ng-show="DestinyErrorMessage !==''">
                                                        <span ng-bind="DestinyErrorMessage"></span>
                                                    </div>
                                                    <div class="alert alert-success" role="alert" ng-show="DestinySuccessMessage !==''" >
                                                        <span ng-bind="DestinySuccessMessage"></span>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- buttons -->
        <div class="row right">
            <div class="btn-group ">
                <button type="button" class="btn btn-default" ng-click="exit()">
                    <span class="glyphicon glyphicon-menu-left"></span> Salir
                </button>
                <button type="button" class="btn btn-primary" ng-click="sumbit()" ng-show="hasRecord()">
                    Enviar a Autorización <span class="glyphicon glyphicon-check"></span>
                </button>
                <button type="button" class="btn btn-primary" ng-click="createQuotesEX()">
                    Guardar <span class="glyphicon glyphicon-floppy-disk"></span>
                </button>
                <button type="button" class="btn btn-danger" ng-click="dataTest()">
                    DATA TEST
                </button>
                <button type="button" class="btn btn-default" ng-click="back()" ng-show="EX.step2 && isAdmin()">
                    <span class="glyphicon glyphicon-menu-left"></span> Atras
                </button>
                <button type="button" class="btn btn-primary" ng-click="next()" ng-show="EX.step1 && isAdmin()">
                    Siguiente <span class="glyphicon glyphicon-menu-right"></span>
                </button>
            </div>
        </div>
    </div>
    <script type="text/javascript" lang="js">
        var j$ = jQuery.noConflict();
        //j$.blockUI({ message: '<h3><span class="glyphicon glyphicon-time"></span> Por favor espere... </h3>' });
        j$(document).ready(function(){
            //console.clear();
            j$('.container-fluid').show();
        });
        (function(){
            // angujar module
            var app = angular.module('Cotizador');
            // main controller
            /*
            * Angular module controllers
            * Begin Angular Controller
            */
            app.controller('EXCController', ['$scope',function($scope) {

                /*
                * Controller variables
                */
                $scope.DeletedDestiny = [];
                $scope.DestinyErrorMessage = '';
                $scope.DestinySuccessMessage = '';
                $scope.EX = {
                    strACK : ''
                    , strOrigin : ''
                    , strDestiny : ''
                    , fltMaxG : 1
                    , step1 : true
                    , step2 : false
                    , blnServiceAddAll : false
                    , blnServiceRemoveAll : false
                    , blnRAD : false
                    , blnEAD : false
                    , blnACK : false
                    , blnSEG : false
                    , blnZP : false
                    , blnSameAddCost : false
                    , hasOverWBlocks : false
                    , listFee : {
                        'TS': 'TARIFA SOBRE'
                        , 'T0': 'TARIFA T0'
                        , 'T1': 'TARIFA T1'
                        , 'T2': 'TARIFA T2'
                        , 'T3': 'TARIFA T3'
                        , 'T4': 'TARIFA T4'
                        , 'T5': 'TARIFA T5'
                        , 'T6': 'TARIFA T6'
                        , 'T7': 'TARIFA T7'
                    }
                    , listFeeZP : {
                        'TS': 'TARIFA SOBRE'
                        , 'T0': 'TARIFA T0'
                        , 'T1': 'TARIFA T1'
                        , 'T2': 'TARIFA T2'
                        , 'T3': 'TARIFA T3'
                        , 'T4': 'TARIFA T4'
                        , 'T5': 'TARIFA T5'
                        , 'T6': 'TARIFA T6'
                    }
                    , listDestiny : {}
                    //, listTender : {
                        
                    //} //29/09/2020 Salvador: Lista de tenders de destino para T7 ZP
                    , OriginDisabled : false
                    , OriginalListRange : {
                        '0-400': '0-400'
                        , '401-800': '401-800'
                        , '801-1200': '801-1200'
                        , '1201-1600': '1201-1600'
                        , '1601-2000': '1601-2000'
                        , '2001-2400': '2001-2400'
                        , '+2400' :'Más de 2400'
                    }
                    , listTender: { //22/09/2020 Salvador: Lista para almacenar los tenders para la T7ZP
                        'ACA':'ACA'
                        ,'AGU':'AGU'
                        ,'BJX':'BJX'
                        ,'CEN':'CEN'
                        ,'CLQ':'CLQ'
                        ,'COA':'COA'
                        ,'CPE':'CPE'
                        ,'CRB':'CRB'
                        ,'CUL':'CUL'
                        ,'CUN':'CUN'
                        ,'CUU':'CUU'
                        ,'CVJ':'CVJ'
                        ,'CVM':'CVM'
                        ,'DGO':'DGO'
                        ,'ENS':'ENS'
                        ,'GDL':'GDL'
                        ,'HMO':'HMO'
                        ,'IGW':'IGW'
                        ,'JRI':'JRI'
                        ,'LAP':'LAP'
                        ,'LDM':'LDM'
                        ,'LMM':'LMM'
                        ,'LOV':'LOV'
                        ,'MEX':'MEX'
                        ,'MID':'MID'
                        ,'MLM':'MLM'
                        ,'MTY':'MTY'
                        ,'MXL':'MXL'
                        ,'MZT':'MZT'
                        ,'NJA':'NJA'
                        ,'OAX':'OAX'
                        ,'PBC':'PBC'
                        ,'PCA':'PCA'
                        ,'PVR':'PVR'
                        ,'QRO':'QRO'
                        ,'SLP':'SLP'
                        ,'SLW':'SLW'
                        ,'TGZ':'TGZ'
                        ,'TIJ':'TIJ'
                        ,'TLC':'TLC'
                        ,'TPQ':'TPQ'
                        ,'VSA':'VSA'
                        ,'ZCL':'ZCL'
                        ,'VER':'VER'
                    }
                    , mapRanges : {
                        '0-400': {
                            'PAQ': {fltFrecc: 0, intQTotal:0}
                            , 'ZP' :{fltFrecc: 0, intQTotal:0}
                            , 'T7' :{fltFrecc: 0, intQTotal:0}
                        }
                        , '401-800': {
                            'PAQ': {fltFrecc: 0, intQTotal:0}
                            , 'ZP' :{fltFrecc: 0, intQTotal:0}
                            , 'T7' :{fltFrecc: 0, intQTotal:0}
                        }
                        , '801-1200': {
                            'PAQ': {fltFrecc: 0, intQTotal:0}
                            , 'ZP' :{fltFrecc: 0, intQTotal:0}
                            , 'T7' :{fltFrecc: 0, intQTotal:0}
                        }
                        , '1201-1600': {
                            'PAQ': {fltFrecc: 0, intQTotal:0}
                            , 'ZP' :{fltFrecc: 0, intQTotal:0}
                            , 'T7' :{fltFrecc: 0, intQTotal:0}
                        }
                        , '1601-2000': {
                            'PAQ': {fltFrecc: 0, intQTotal:0}
                            , 'ZP' :{fltFrecc: 0, intQTotal:0}
                            , 'T7' :{fltFrecc: 0, intQTotal:0}
                        }
                        , '2001-2400': {
                            'PAQ': {fltFrecc: 0, intQTotal:0}
                            , 'ZP' :{fltFrecc: 0, intQTotal:0}
                            , 'T7' :{fltFrecc: 0, intQTotal:0}
                        }
                        , '+2400': {
                            'PAQ': {fltFrecc: 0, intQTotal:0}
                            , 'ZP' :{fltFrecc: 0, intQTotal:0}
                            , 'T7' :{fltFrecc: 0, intQTotal:0}
                        }
                    }
                    /*, mapLimits:{
                        'TS': { max : 1, min : 0.49 }
                        , 'T0': { max : 5, min : 0.49}
                        , 'T1': { max : 10, min : 5}
                        , 'T2': { max : 20, min : 10}
                        , 'T3': { max : 30, min : 20}
                        , 'T4': { max : 40, min : 30}
                        , 'T5': { max : 50, min : 40}
                        , 'T6': { max : 60, min : 50}
                    }*/
                    , mapLimits:{
                        'TS': { max : 1, min : 0.49 }
                        , 'T0': { max : 5, min : 0.49}
                        , 'T1': { max : 10, min : 6}
                        , 'T2': { max : 20, min : 11}
                        , 'T3': { max : 30, min : 21}
                        , 'T4': { max : 40, min : 31}
                        , 'T5': { max : 50, min : 41}
                        , 'T6': { max : 60, min : 51}
                    }
                    , mapBlock : {

                    }
                    , OWFrecc : {
                         intQTotal : 0
                        , fltFTotal : 0
                        , fltFEETotal : 0
                    }
                    , mapService : {
                        'Add' : {
                            ranges : {}
                        }
                        , 'ZP' : {
                            blnSameCost : false
                            , ranges : {}
                        }
                        , 'ACK' : {
                            blnSameCost : false
                            , fltAVGDeliveryByACK : 0
                            , fltAVGPackByDay : 0
                            , optOption :{
                                model : undefined
                                , aviableOptions:[
                                    {id : 'Interno', label:'Acuse Interno'}
                                    , { id : 'Empresa', label:'Acuse Empresa'}
                                    , { id : 'XT', label:'Acuse XT'}
                                ]
                            }
                            , optForma :{
                                model : undefined
                                , aviableOptions:[
                                    {id : 'G', label:'Por Guía'}
                                    , { id : 'B', label:'Por Bulto'}
                                ]
                            }
                            , ranges : {}
                        }
                    }
                    , ServiceSelect : {
                        available : [
                            {id:'RAD' , label : 'Recolección a domicilio', blnSelected : false }
                            , {id:'EAD' , label : 'Entrega a domicilio', blnSelected : false }
                            , {id:'SEG' , label : 'Seguro', blnSelected : false }
                            , {id:'ACK' , label : 'Acuse', blnSelected : false }
                        ]
                        , selected : []
                    }
                    , mapPropuesta : {
                    }
                    , mapFrecc : {
                        'TS':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T0':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T1':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T2':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T3':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T4':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T5':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T6':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T7':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T7P':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T7V':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        //, 'T7ZP':{tender:{}, fltFrecc: 0, intQTotal:0} //29/09/2020 Salvador: Bloque para T7 ZP
                        , intQTotal : 0
                        , fltFTotal : 0
                        , fltFEETotal : 0
                    }
                    , mapFreccZP : {
                        'TS':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T0':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T1':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T2':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T3':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T4':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T5':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T6':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T7':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , intQTotal : 0
                        , fltFTotal : 0
                        , fltFEETotal : 0
                    }
                    , mapTarifas7 : {}
                    , mapProjEX : {
                        'TS': {}
                        , 'T0': {}
                        , 'T1': {}
                        , 'T2': {}
                        , 'T3': {}
                        , 'T4': {}
                        , 'T5': {}
                        , 'T6': {}
                        , 'T7': {}
                    }
                    , mapProjEXZP : {
                        'TS': {}
                        , 'T0': {}
                        , 'T1': {}
                        , 'T2': {}
                        , 'T3': {}
                        , 'T4': {}
                        , 'T5': {}
                        , 'T6': {}
                    }
                    , mapQuotes : {
                        'TS':{}
                        , 'T0':{}
                        , 'T1':{}
                        , 'T2':{}
                        , 'T3':{}
                        , 'T4':{}
                        , 'T5':{}
                        , 'T6':{}
                        , 'T7':{}}
                    , mapQuotesZP : {
                        'TS':{}
                        , 'T0':{}
                        , 'T1':{}
                        , 'T2':{}
                        , 'T3':{}
                        , 'T4':{}
                        , 'T5':{}
                        , 'T6':{}
                    }
                    , TOTAL : {
                        'PAQUETES': 0
                        , 'NORMAL': 0
                        , 'PROPUESTA': 0
                        , 'SEGURO': 0
                        , 'DESCUENTO': 0
                    }
                };
                $scope.listFee = {
                    'TS': 'TARIFA TS'
                    , 'T0': 'TARIFA T0'
                    , 'T1': 'TARIFA T1'
                    , 'T2': 'TARIFA T2'
                    , 'T3': 'TARIFA T3'
                    , 'T4': 'TARIFA T4'
                    , 'T5': 'TARIFA T5'
                    , 'T6': 'TARIFA T6'
                    , 'T7': 'TARIFA T7'
                };
                /*$scope.listTender = { //29/09/2020 Salvador: Lista para almacenar los tenders para la T7ZP
                        'ACA':'ACA'
                        ,'AGU':'AGU'
                        ,'BJX':'BJX'
                        ,'CEN':'CEN'
                        ,'CLQ':'CLQ'
                        ,'COA':'COA'
                        ,'CPE':'CPE'
                        ,'CRB':'CRB'
                        ,'CUL':'CUL'
                        ,'CUN':'CUN'
                        ,'CUU':'CUU'
                        ,'CVJ':'CVJ'
                        ,'CVM':'CVM'
                        ,'DGO':'DGO'
                        ,'ENS':'ENS'
                        ,'GDL':'GDL'
                        ,'HMO':'HMO'
                        ,'IGW':'IGW'
                        ,'JRI':'JRI'
                        ,'LAP':'LAP'
                        ,'LDM':'LDM'
                        ,'LMM':'LMM'
                        ,'LOV':'LOV'
                        ,'MEX':'MEX'
                        ,'MID':'MID'
                        ,'MLM':'MLM'
                        ,'MTY':'MTY'
                        ,'MXL':'MXL'
                        ,'MZT':'MZT'
                        ,'NJA':'NJA'
                        ,'OAX':'OAX'
                        ,'PBC':'PBC'
                        ,'PCA':'PCA'
                        ,'PVR':'PVR'
                        ,'QRO':'QRO'
                        ,'SLP':'SLP'
                        ,'SLW':'SLW'
                        ,'TGZ':'TGZ'
                        ,'TIJ':'TIJ'
                        ,'TLC':'TLC'
                        ,'TPQ':'TPQ'
                        ,'VSA':'VSA'
                        ,'ZCL':'ZCL'
                        ,'VER':'VER'
                    }*/
                $scope.listBlocksByMaxW = [];
                $scope.ProjectionEX = {
                    'PAQ' : {}
                    , 'ZP' : {}
                    , fltTotalNormal : 0
                    , fltTotalQuote : 0
                    , fltTotalSEG : 0
                    , fltDisc : 0
                };
                $scope.EX.mapPropuesta['PROP'] = { //29/09/2020 Salvador: Mapa para almacenar la propuesta de T7 ZP
                    ranges : []
                    , intFeeTotalFrec : 0
                    , fltFeeTotalNormal : 0
                    , fltFeeTotalQuote : 0
                    , fltFeeTotalSEG : 0
                    , fltFeeTotalDesc : 0
                    , fltDisc : 0
                    , blnSameQuote : false
                };
                j$.each($scope.EX.listRange, function (key, str) {
                    $scope.EX.mapService['Add'].ranges[key] = { fltCostWeight : 0, fltCostVol : 0};
                    $scope.EX.mapService['ACK'].ranges[key] = { fltCost : 0 };
                    $scope.EX.mapService['ZP'].ranges[key] = { fltCost : 0 };
                    j$.each($scope.listFee, function (keyFee, strFee) {
                        $scope.EX.mapFrecc[keyFee].ranges[key] = {
                            intFrecuency : 0
                            , fltBaseFee : 0
                            , fltFullFee : 0
                            , fltRAD : 0
                            , fltEAD : 0
                            , fltACK : 0
                            , fltSEG : 0
                            , fltTotalNormal : 0
                        };
                        if(keyFee !== 'T7')
                            $scope.EX.mapFreccZP[keyFee].ranges[key] = {
                                intFrecuency : 0
                                , fltBaseFee : 0
                                , fltFullFee : 0
                                , fltRAD : 0
                                , fltEAD : 0
                                , fltACK : 0
                                , fltSEG : 0
                                , fltTotalNormal : 0
                            };
                        else {
                            $scope.EX.mapFrecc[keyFee].ranges[key].fltAVGWeight = 0;
                            $scope.EX.mapFrecc[keyFee].ranges[key].fltAVGVol = 0;

                            $scope.EX.mapFrecc[keyFee+'ZP'].ranges[key].fltAVGWeight = 0;
                            $scope.EX.mapFrecc[keyFee+'ZP'].ranges[key].fltAVGVol = 0;
                        }
                        //$scope.EX.mapQuotes[keyFee][key] = {};
                        /*if(keyFee !== 'T7')
                            $scope.EX.mapQuotesZP[keyFee][key] = {};*/
                    });
                    $scope.EX.mapFrecc['T7P'].ranges[key] = {
                        intFrecuency : 0
                        , fltBaseFee : 0
                        , fltFullFee : 0
                        , fltRAD : 0
                        , fltEAD : 0
                        , fltACK : 0
                        , fltSEG : 0
                        , fltTotalNormal : 0
                        , fltAVGWeight : 1
                        , fltAVGVol : 1
                    };
                    $scope.EX.mapFrecc['T7V'].ranges[key] = {
                        intFrecuency : 0
                        , fltBaseFee : 0
                        , fltFullFee : 0
                        , fltRAD : 0
                        , fltEAD : 0
                        , fltACK : 0
                        , fltSEG : 0
                        , fltTotalNormal : 0
                        , fltAVGWeight : 1
                        , fltAVGVol : 1
                    };

                });
                /*
                * Controller functions
                */
                $scope.addAll = function(strOpr){
                    if(strOpr === 'add')
                        j$.each($scope.EX.ServiceSelect.available, function (i, serv) {
                            serv.blnSelected = $scope.EX.blnServiceAddAll;
                        });
                    else if(strOpr === 'remove')
                        j$.each($scope.EX.ServiceSelect.selected, function (i, serv) {
                            serv.blnSelected = $scope.EX.blnServiceRemoveAll;;
                        });
                };

                $scope.ValidarPropuesta = function(){
                /*29/09/2020 Salvador: Funcionalidad para calcular la propuesta antes de grabar la cotización*/
                    var blnError = false;
                    j$.each($scope.EX.listRange, function(keyRange, strRange){
                        $scope.EX.mapPropuesta['PROP'].ranges[keyRange].fltTotalPropuesta   = 0;
                        $scope.EX.mapPropuesta['PROP'].ranges[keyRange].fltTotalTarifaLlena = 0;
                        $scope.EX.mapPropuesta['PROP'].ranges[keyRange].fltDescuento        = 0;
                        $scope.EX.mapPropuesta['PROP'].ranges[keyRange].fltQuoteFee         = 0;
                    });
                    j$.each($scope.EX.listTender, function(keyTender, strTender){
                        debugger;
                        if($scope.EX.mapQuotes['T7ZP'].Tender[strTender].intFrecuency !== 0){
                            if ($scope.EX.mapPropuesta['PROP'].ranges[$scope.EX.mapQuotes['T7ZP'].Tender[strTender].strRange].fltCost === 0){
                                alert('Debe ingresar un costo propuesto por kg. Rango de km: ' + $scope.EX.mapQuotes['T7ZP'].Tender[strTender].strRange);
                                blnError = true;
                                return blnError;
                            }
                            if ($scope.EX.mapQuotes['T7ZP'].Tender[strTender].strOrigen === ''){
                                alert('Debe ingresar un origen para la cotización');
                                blnError = true;
                                return blnError;
                            }
                            if ($scope.EX.mapQuotes['T7ZP'].Tender[strTender].strRange === ''){
                                alert('Debe calcular obtener los rangos de km para poder continuar');
                                blnError = true;
                                return blnError;
                            }
                            if ($scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltLargo === 0){
                                alert('No puede calcular propuesta sin el valor de "Largo". Tender: ' + strTender);
                                blnError = true;
                                return blnError;
                            }
                            if ($scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltAncho === 0){
                                alert('No puede calcular propuesta sin el valor de "Ancho". Tender: ' + strTender);
                                blnError = true;
                                return blnError;
                            }
                            if ($scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltAlto === 0){
                                alert('No puede calcular propuesta sin el valor de "Alto". Tender: ' + strTender);
                                blnError = true;
                                return blnError;
                            }
                            if ($scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltPeso === 0){
                                alert('No puede calcular propuesta sin el valor de "Peso". Tender: ' + strTender);
                                blnError = true;
                                return blnError;
                            }
                            $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltPesoVol = ObtienePesoVolum($scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltLargo, $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltAncho, $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltAlto);
                            $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltPesoDom = ObtienePesoDominante($scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltPeso, $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltPesoVol);
                            $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltFullFee = ObtieneTarifaLlena($scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltPesoDom, $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltExc);
                            $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltTotalQuote = ObtieneTotalTarifaLlena($scope.EX.mapQuotes['T7ZP'].Tender[strTender].intFrecuency, $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltFullFee);
                            $scope.EX.mapQuotes['T7ZP'].Tender[strTender].flttarifaProp = ObtieneTarifaPropuesta($scope.EX.mapPropuesta['PROP'].ranges[$scope.EX.mapQuotes['T7ZP'].Tender[strTender].strRange].fltCost, $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltPesoDom);
                            $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltQuoteFull = $scope.EX.mapQuotes['T7ZP'].Tender[strTender].flttarifaProp * $scope.EX.mapQuotes['T7ZP'].Tender[strTender].intFrecuency;
                            $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltDiscount = $scope.EX.mapQuotes['T7ZP'].Tender[strTender].flttarifaProp / $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltFullFee - 1;
                            $scope.AgregaTotalPropuestaMapaPropuesta($scope.EX.mapQuotes['T7ZP'].Tender[strTender].strRange, $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltQuoteFull);
                            $scope.AgregaTotalTarifaLlenaMapaPropuesta($scope.EX.mapQuotes['T7ZP'].Tender[strTender].strRange, $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltTotalQuote);
                            $scope.AgregaDescuentoMapaPropuesta($scope.EX.mapQuotes['T7ZP'].Tender[strTender].strRange, $scope.EX.mapPropuesta['PROP'].ranges[$scope.EX.mapQuotes['T7ZP'].Tender[strTender].strRange].fltTotalPropuesta, $scope.EX.mapPropuesta['PROP'].ranges[$scope.EX.mapQuotes['T7ZP'].Tender[strTender].strRange].fltTotalTarifaLlena);
                            $scope.EX.mapQuotes['T7ZP'].intFeeTotalFrec += $scope.EX.mapQuotes['T7ZP'].Tender[strTender].intFrecuency;
                            $scope.EX.mapQuotes['T7ZP'].fltFeeTotalNormal += $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltTotalQuote;
                            $scope.EX.mapQuotes['T7ZP'].fltFeeTotalQuote += $scope.EX.mapQuotes['T7ZP'].Tender[strTender].flttarifaProp;
                        }
                    });
                    $scope.EX.mapQuotes['T7ZP'].fltFeeTotalDesc = $scope.EX.mapQuotes['T7ZP'].fltFeeTotalQuote / $scope.EX.mapQuotes['T7ZP'].fltFeeTotalNormal -1;
                    $scope.AgregaTotalesT7ZP($scope.EX.mapQuotes['T7ZP'].intFeeTotalFrec, $scope.EX.mapQuotes['T7ZP'].fltFeeTotalNormal, $scope.EX.mapQuotes['T7ZP'].fltFeeTotalQuote, $scope.EX.mapQuotes['T7ZP'].fltFeeTotalDesc);
                }

                $scope.addBlock = function(fltMaxW){
                    var key = '';
                    var strkey = '';
                    if(fltMaxW <= 60){
                        if(fltMaxW === 1){
                            key = 'TS';
                            $scope.EX.mapBlock['TS'] = {
                                strLabel : 'TS'
                                , fltMaxW : fltMaxW
                                , fltVolW : 0
                                , fltVolWeight: 0
                                , blnSameCost : false
                                , ranges : {}
                            };
                            j$.each($scope.EX.listRange, function (keyRange, strRange) {
                                $scope.EX.mapBlock[key].ranges[keyRange] = {
                                    fltCost : 0
                                };
                            });
                        } else {
                            j$.each($scope.EX.mapLimits, function (keyFee, limits) {
                                key = keyFee;
                                strKey = fltMaxW.toString();
                                key += strKey.replace('.', '_');
                                if(fltMaxW > limits.min && fltMaxW <= limits.max){
                                    $scope.EX.mapBlock[key] = {
                                        strLabel : keyFee
                                        , fltMaxW : fltMaxW
                                        , fltVolW : 0
                                        , fltVolWeight: 0
                                        , blnSameCost : false
                                        , ranges : {}
                                    };
                                    $scope.listBlocksByMaxW.push({key:key, value: fltMaxW});
                                    j$.each($scope.EX.listRange, function (keyRange, strRange) {
                                        $scope.EX.mapBlock[key].ranges[keyRange] = {
                                            fltCost : 0
                                        };
                                    });
                                }
                            });
                        }
                    }
                    else{
                        $scope.EX.hasOverWBlocks = true;
                        key = 'T7';
                        strKey = fltMaxW.toString();
                        key += strKey.replace('.', '_');
                        $scope.EX.mapBlock[key] = {
                            strLabel : 'T7'
                            , fltMaxW : fltMaxW
                            , fltVolW : 0
                            , fltVolWeight: 0
                            , blnSameCost : false
                            , ranges : {}
                        };
                        $scope.listBlocksByMaxW.push({key:key, value: fltMaxW});
                        j$.each($scope.EX.listRange, function (keyRange, strRange) {
                            $scope.EX.mapBlock[key].ranges[keyRange] = {
                                fltCost : 0
                            };
                        });
                        $scope.addFrecc(fltMaxW);
                    }
                };

                $scope.addDestiny = function(){
                    $scope.EX.OriginDisabled = true;
                    $scope.DestinyErrorMessage = '';
                    $scope.DestinySuccessMessage = '';
                    if(notEmpty($scope.EX.strOrigin)
                            && notEmpty($scope.EX.strDestiny)
                            && $scope.EX.strDestiny.length == 3
                            && !isIn($scope.EX.strDestiny, $scope.EX.listDestiny)
                    )
                        callCheckDestiny($scope);
                    else if(!notEmpty($scope.EX.strOrigin))
                        $scope.DestinyErrorMessage = 'Debe agregar un origen';
                    else if(!notEmpty($scope.EX.strDestiny))
                        $scope.DestinyErrorMessage = 'Debe agregar un destino';
                    else if(notEmpty($scope.EX.strDestiny) && $scope.EX.strDestiny.length < 3)
                        $scope.DestinyErrorMessage = 'El destino tener una longitud de 3 letras';

                };

                $scope.addFrecc = function(fltWeigth){
                    var strFee = fltWeigth + ' kg';
                    var keyFee = 'T7_' + fltWeigth;
                    $scope.EX.OWFrecc[keyFee] = {
                        ranges:{}
                        , fltFrecc: 0
                        , intQTotal:0
                        , strName:strFee
                        , blnSameFrecc :false
                        , blnSameWeight :false
                        , blnSameVol :false
                    };
                    $scope.EX.OWFrecc[keyFee + 'ZP'] = { //21/09/2020 Salvador: Mapa para guardar las frecuencias T7 zona plus
                        ranges:{}
                        , fltFrecc: 0
                        , intQTotal:0
                        , strNombre:strFee
                        , blnMismaFrec :false
                        , blnMismoPeso :false
                        , blnMismoVol :false
                    };
                    $scope.EX.mapQuotes[keyFee] = {};
                    //$scope.EX.mapQuotes[keyFee + 'ZP'] = {};
                    $scope.listFee[keyFee] = 'TARIFA '+ keyFee;
                    //$scope.listFee[keyFee] = 'TARIFA '+ keyFee + 'ZP';
                    if ($scope.OnlineDocByRangeKM || (!$scope.OnlineDocByRangeKM && !$scope.OnlineDocByDestiny)){
                        j$.each($scope.EX.listRange, function (key, str) {
                            $scope.EX.OWFrecc[keyFee].ranges[key] = {
                                intFrecuency : 0
                                , fltAVGWeight : fltWeigth
                                , fltAVGVol : 0
                                , fltBaseFee : 0
                                , fltBaseFeeP : 0
                                , fltFullFee : 0
                                , fltFullFeeP : 0
                                , fltRAD : 0
                                , fltRADP : 0
                                , fltEAD : 0
                                , fltEADP : 0
                                , fltACK : 0
                                , fltSEG : 0
                                , fltTotalNormal : 0
                            };
                            //$scope.EX.mapQuotes[keyFee][key] = {};
                            $scope.EX.OWFrecc[keyFee+'ZP'].ranges[key] = {
                                intFrecuency : 0
                                , fltAVGWeight : fltWeigth  
                                , fltAVGVol : 0 
                                , fltBaseFee : 0
                                , fltFullFee : 0
                                , fltRAD : 0
                                , fltEAD : 0
                                , fltACK : 0
                                , fltSEG : 0
                                , fltTotalNormal : 0
                            };
                            
                        });

                        /*j$.each($scope.EX.listRange, function (key, str) {
                            $scope.EX.OWFrecc[keyFee+'ZP'].ranges[key] = {
                                intFrecuency : 0
                                , fltAVGWeight : fltWeigth
                                , fltAVGVol : 0 
                                , fltBaseFee : 0
                                , fltFullFee : 0
                                , fltRAD : 0
                                , fltEAD : 0
                                , fltACK : 0
                                , fltSEG : 0
                                , fltTotalNormal : 0
                            };
                            //$scope.EX.mapQuotes[keyFee+'ZP'][key] = {};
                        });*/
                    } else if ($scope.OnlineDocByDestiny && !$scope.OnlineDocByRangeKM){
                        j$.each($scope.EX.listDestiny, function (keyDestiny, strDestiny) {
                            $scope.EX.OWFrecc[keyFee].ranges[keyDestiny] = {
                                intFrecuency : 0
                                , fltAVGWeight : fltWeigth
                                , fltAVGVol : 0
                                , fltBaseFee : 0
                                , fltBaseFeeP : 0
                                , fltFullFee : 0
                                , fltFullFeeP : 0
                                , fltRAD : 0
                                , fltRADP : 0
                                , fltEAD : 0
                                , fltEADP : 0
                                , fltACK : 0
                                , fltSEG : 0
                                , fltTotalNormal : 0
                            };
                            $scope.EX.mapQuotes[keyFee][keyDestiny] = {};
                        });
                    }
                };

                $scope.addService = function(service){
                    var index =  j$.inArray(service, $scope.EX.ServiceSelect.available);
                    $scope.EX.ServiceSelect.available.splice(index, 1);
                    $scope.EX.ServiceSelect.selected.push(service);
                    switch (service.id) {
                        case 'EAD':
                            $scope.EX.blnEAD = true;
                            break;
                        case 'RAD':
                            $scope.EX.blnRAD = true;
                            break;
                        case 'SEG':
                            $scope.EX.blnSEG = true;
                            break;
                        case 'ACK':
                            $scope.EX.blnACK = true;
                            break;
                    }

                };

                $scope.back = function(){
                    $scope.EX.step1 = true;
                    $scope.EX.step2 = false;
                };

                $scope.calculateDiscProjection = function(){
                    $scope.ProjectionEX = {
                        'PAQ' : {}
                        , 'ZP' : {}
                        , fltTotalNormal : 0
                        , fltTotalQuote : 0
                        , fltTotalSEG : 0
                        , fltDisc : 0
                    };
                    j$.each($scope.EX.mapProjEX, function (strKey, pro){
                        $scope.ProjectionEX.PAQ[strKey] = { strFee : pro.strFee, fltWeight: pro.fltMaxW , fltDisc : pro.fltDisc, fltMaxDisc : 0 } ;
                        j$.each(pro.ranges, function (keyRange, range){
                            if($scope.ProjectionEX.PAQ[strKey].fltMaxDisc === 0)
                                $scope.ProjectionEX.PAQ[strKey].fltMaxDisc = range.fltDisc;
                            else if($scope.ProjectionEX.PAQ[strKey].fltMaxDisc > range.fltDisc)
                                $scope.ProjectionEX.PAQ[strKey].fltMaxDisc = range.fltDisc;
                        });
                    });
                    j$.each($scope.EX.mapProjEXZP, function (strKey, pro){
                        $scope.ProjectionEX.ZP[strKey] = { strFee : pro.strFee, fltWeight: pro.fltMaxW , fltDisc : pro.fltDisc, fltMaxDisc : 0 } ;
                        j$.each(pro.ranges, function (keyRange, range){
                            if($scope.ProjectionEX.ZP[strKey].fltMaxDisc === 0)
                                $scope.ProjectionEX.ZP[strKey].fltMaxDisc = range.fltDisc;
                            if($scope.ProjectionEX.ZP[strKey].fltMaxDisc > range.fltDisc)
                                $scope.ProjectionEX.ZP[strKey].fltMaxDisc = range.fltDisc;
                        });
                    });
                };

                $scope.calculateEX = function(){
                    var key = '';
                    var destrange = '';
                    var rangeresp = '';
                    j$.each($scope.listFee, function (keyFee, strFee) {
                        if (keyFee.includes('T7_')){
                            $scope.EX.mapTarifas7[keyFee + 'P'] = {
                                ranges : {}
                            }
                            $scope.EX.mapTarifas7[keyFee + 'V'] = {
                                ranges : {}
                            }
                        }
                        j$.each($scope.EX.listRange, function (keyRange, strRange) {
                            rangeresp = strRange;
                            if(strRange.includes(' (')){
                                destrange = rangeresp.replace(keyRange + ' (', '');
                                destrange = destrange.replace(')', '');
                            } else destrange = strRange;
                            if(keyFee === 'TS' || keyFee === 'T0'|| keyFee === 'T1'|| keyFee === 'T2'|| keyFee === 'T3'|| keyFee === 'T4'|| keyFee === 'T5'|| keyFee === 'T6'|| keyFee === 'T7')
                                var item = $scope.EX.mapFrecc[keyFee].ranges[keyRange];
                            else
                                var item = $scope.EX.OWFrecc[keyFee].ranges[keyRange];
                            item.fltRAD = 0;
                            item.fltEAD = 0;
                            item.fltACK = 0;
                            item.fltSEG = 0;
                            if(keyFee === 'TS' || keyFee === 'T0'|| keyFee === 'T1'|| keyFee === 'T2'|| keyFee === 'T3'|| keyFee === 'T4'|| keyFee === 'T5'|| keyFee === 'T6')
                                item.fltBaseFee = $scope.Wrapper.mapTarifarioT[strFee][destrange].Flete__c;
                            if (!$scope.exceptionAD(keyFee)) {
                                if ($scope.EX.blnRAD)
                                    item.fltRAD = dominantFeeServiceDom($scope.Wrapper.mapCS['MinRAD'], item.fltBaseFee);
                                if ($scope.EX.blnEAD)
                                    item.fltEAD = dominantFeeServiceDom($scope.Wrapper.mapCS['MinEAD'], item.fltBaseFee);
                            }
                            if($scope.EX.blnSEG)
                                item.fltSEG = ($scope.Wrapper.mapCS['SEG'] / 1000) * $scope.EX.fltSEG;
                            if($scope.EX.blnACK)
                                item.fltACK = $scope.Wrapper.mapACK[$scope.EX.strACK];
                            if (keyFee.includes('T7_')){
                                $scope.EX.mapTarifas7[keyFee + 'P'].ranges[keyRange] = {
                                    intFrecuency : 0
                                    , fltBaseFee : 0
                                    , fltFullFee : 0
                                    , fltRAD : 0
                                    , fltEAD : 0
                                    , fltACK : 0
                                    , fltSEG : 0
                                    , fltTarPropuesta : 0
                                    , fltTotalNormal : 0
                                    , fltAVGWeight : 1
                                    , fltAVGVol : 1
                                }
                                $scope.EX.mapTarifas7[keyFee + 'V'].ranges[keyRange] = {
                                    intFrecuency : 0
                                    , fltBaseFee : 0
                                    , fltFullFee : 0
                                    , fltRAD : 0
                                    , fltEAD : 0
                                    , fltACK : 0
                                    , fltSEG : 0
                                    , fltTarPropuesta : 0
                                    , fltTotalNormal : 0
                                    , fltAVGWeight : 1
                                    , fltAVGVol : 1
                                }
                                key = keyFee.replace('_', '');
                                var t7p = {
                                    intFrecuency : $scope.EX.OWFrecc[keyFee].ranges[keyRange].intFrecuency
                                    , fltBaseFee : 0
                                    , fltFullFee : 0
                                    , fltRAD : 0
                                    , fltEAD : 0
                                    , fltACK : 0
                                    , fltSEG : 0
                                    , fltTarPropuesta : 0
                                    , fltTotalNormal : 0
                                    , fltAVGWeight : $scope.EX.mapBlock[key].fltMaxW
                                };
                                var t7v = {
                                    intFrecuency : $scope.EX.OWFrecc[keyFee].ranges[keyRange].intFrecuency
                                    , fltBaseFee : 0
                                    , fltFullFee : 0
                                    , fltRAD : 0
                                    , fltEAD : 0
                                    , fltACK : 0
                                    , fltSEG : 0
                                    , fltTarPropuesta : 0
                                    , fltTotalNormal : 0
                                    , fltAVGVol : $scope.EX.OWFrecc[keyFee].ranges[keyRange].fltAVGVol
                                };
                                t7p.fltBaseFee = $scope.Wrapper.mapTarifarioT['TARIFA T7P'][destrange].Flete__c * $scope.EX.OWFrecc[keyFee].ranges[keyRange].fltAVGWeight;
                                t7p.fltTarPropuesta = $scope.EX.mapBlock[key].ranges[keyRange].fltCost;
                                t7v.fltTarPropuesta = $scope.EX.mapBlock[key].ranges[keyRange].fltCost;
                                t7v.fltBaseFee = $scope.Wrapper.mapTarifarioT['TARIFA T7V'][destrange].Flete__c * $scope.EX.OWFrecc[keyFee].ranges[keyRange].fltAVGVol;
                                
                                if ($scope.EX.blnRAD) {
                                    t7p.fltRAD = dominantFeeServiceDom($scope.Wrapper.mapCS['MinRAD'], t7p.fltBaseFee);
                                    t7v.fltRAD = dominantFeeServiceDom($scope.Wrapper.mapCS['MinRAD'], t7v.fltBaseFee);
                                }
                                if ($scope.EX.blnEAD) {
                                    t7p.fltEAD = dominantFeeServiceDom($scope.Wrapper.mapCS['MinEAD'], t7p.fltBaseFee);
                                    t7v.fltEAD = dominantFeeServiceDom($scope.Wrapper.mapCS['MinEAD'], t7v.fltBaseFee);
                                }
                                if ($scope.EX.blnSEG) {
                                    t7p.fltSEG = ($scope.Wrapper.mapCS['SEG'] / 1000) * $scope.EX.fltSEG;
                                    t7v.fltSEG = ($scope.Wrapper.mapCS['SEG'] / 1000) * $scope.EX.fltSEG;
                                }
                                if ($scope.EX.blnACK) {
                                    t7p.fltACK = $scope.Wrapper.mapACK[$scope.EX.strACK];
                                    t7v.fltACK = $scope.Wrapper.mapACK[$scope.EX.strACK];
                                }

                                t7p.fltFullFee = t7p.fltBaseFee + t7p.fltRAD + t7p.fltEAD + t7p.fltACK + t7p.fltSEG;
                                t7p.fltTotalNormal = t7p.fltFullFee * $scope.EX.OWFrecc[keyFee].ranges[keyRange].intFrecuency;

                                t7v.fltFullFee = t7v.fltBaseFee + t7v.fltRAD + t7v.fltEAD + t7v.fltACK + t7v.fltSEG;
                                t7v.fltTotalNormal = t7v.fltFullFee * $scope.EX.OWFrecc[keyFee].ranges[keyRange].intFrecuency;
                                $scope.EX.mapTarifas7[keyFee + 'P'].ranges[keyRange] = t7p;
                                $scope.EX.mapTarifas7[keyFee + 'V'].ranges[keyRange] = t7v;
                            }
                            item.fltFullFee = item.fltBaseFee + item.fltRAD + item.fltEAD + item.fltACK + item.fltSEG;
                            if(keyFee === 'TS' || keyFee === 'T0'|| keyFee === 'T1'|| keyFee === 'T2'|| keyFee === 'T3'|| keyFee === 'T4'|| keyFee === 'T5'|| keyFee === 'T6'|| keyFee === 'T7')
                                $scope.EX.mapFrecc[keyFee].ranges[keyRange] = item;
                            else
                                $scope.EX.OWFrecc[keyFee].ranges[keyRange] = item;
                            if(keyFee === 'T0' || keyFee === 'T1')
                                item.fltTotalNormal = item.fltFullFee * (item.intFrecuency  / 5);
                            else if(keyFee !== 'TS' && keyFee !== 'T0'  && keyFee !== 'T1' && keyFee != 'T7' && !keyFee.includes('T7'))
                                item.fltTotalNormal = item.fltFullFee * (item.intFrecuency  / 10);
                            else
                                item.fltTotalNormal = item.fltFullFee * item.intFrecuency;

                            /* ZP */
                            if(keyFee !== 'T7' && !keyFee.includes('T7')){
                                var itemZP = $scope.EX.mapFreccZP[keyFee].ranges[keyRange];
                                itemZP.fltRAD = 0;
                                itemZP.fltACK = 0;
                                itemZP.fltSEG = 0;
                                itemZP.fltBaseFee = $scope.Wrapper.mapTarifarioT[strFee][destrange].Flete__c;
                                itemZP.fltEAD = $scope.Wrapper.mapCS['AEZP'];
                                if (!$scope.exceptionAD(keyFee)) {
                                    if ($scope.EX.blnRAD)
                                        itemZP.fltRAD = dominantFeeServiceDom($scope.Wrapper.mapCS['MinRAD'], item.fltBaseFee);
                                }
                                if($scope.EX.blnSEG)
                                    itemZP.fltSEG = ($scope.Wrapper.mapCS['SEG'] / 1000) * $scope.EX.fltSEG;
                                if($scope.EX.blnACK)
                                    itemZP.fltACK = $scope.Wrapper.mapACK[$scope.EX.strACK];
                                itemZP.fltFullFee = itemZP.fltBaseFee + itemZP.fltRAD + itemZP.fltEAD + itemZP.fltACK + itemZP.fltSEG;
                                if(keyFee === 'T0' || keyFee === 'T1')
                                    itemZP.fltTotalNormal = itemZP.fltFullFee * (itemZP.intFrecuency / 5);
                                else if(keyFee !== 'TS' && keyFee !== 'T0' && keyFee !== 'T1')
                                    itemZP.fltTotalNormal = itemZP.fltFullFee * (itemZP.intFrecuency / 10);
                                else
                                    itemZP.fltTotalNormal = itemZP.fltFullFee * itemZP.intFrecuency;

                            }
                        });
                    });
                    $scope.calculateProjEX();
                };

                $scope.calculateProjEX = function(){
                    //debugger;
                    $scope.EX.mapProjEX = {};
                    $scope.EX.mapProjEXZP = {};
                    $scope.EX.TOTAL.PROPUESTA = 0;
                    $scope.EX.TOTAL.SEGURO = 0;
                    $scope.EX.TOTAL.NORMAL = 0;
                    $scope.EX.TOTAL.DESCUENTO = 0;
                    var firstBlock = null;
                    var lastBlock = null;
                    j$.each($scope.listBlocksByMaxW, function (j, block) {
                        lastBlock = block;
                        if(firstBlock === null)
                            firstBlock = block;
                        /*if(block.value > 60)
                            $scope.t7blocks[] = block;*/
                    });
                    j$.each($scope.EX.listFee, function(keyFee, strFee){
                        $scope.EX.mapQuotes[keyFee] = {
                            block : {}
                        };
                    });
                    j$.each($scope.EX.listFeeZP, function(keyFee, strFee){
                        $scope.EX.mapQuotesZP[keyFee] = {
                            block : {}
                        };
                    });
                    var listBlocksReverse = [];
                    Object.assign(listBlocksReverse, $scope.listBlocksByMaxW);
                    listBlocksReverse.reverse();
                    //TS - T6
                    for (let i = 0; i <= 60; i++) {
                        let key = i;
                        let w = i;
                        let block;
                        let listRanges = {};
                        let fltTotalNormal = 0;
                        let fltTotalQuote = 0 ;
                        let fltTotalSEG = 0;
                        let listRangesZP = {};
                        let fltTotalNormalZP = 0;
                        let fltTotalQuoteZP = 0 ;
                        let fltTotalSEGZP = 0;
                        let strFee = '';

                        if(i === 0)
                            strFee = 'TS';
                        else if(i === 1)
                            strFee = 'T0';
                        else
                            j$.each($scope.EX.mapLimits, function (keyF, limits) {
                                /*if(i > limits.min && i <= limits.max)
                                    strFee = keyF;*/
                                if(i > limits.min && i <= limits.max || i === limits.min)
                                    strFee = keyF;
                            });
                        if(i <= firstBlock.value){
                            key = firstBlock.key;
                        }else if(i >= lastBlock.value){
                            key = lastBlock.key;
                        }else{
                            j$.each(listBlocksReverse, function (index, b) {
                                if(i < b.value)
                                    key = b.key;
                            });
                        }
                        block = $scope.EX.mapBlock[key];
                        //if(key.includes(strFee) || i === 0)
                            $scope.EX.mapQuotes[strFee].block[key] = {
                                strBlock : ''
                                , ranges : {}
                            };
                        $scope.EX.mapQuotesZP[strFee].block[key] = {
                            strBlock : ''
                            , ranges : {}
                        };
                        j$.each($scope.EX.listRange, function (keyRange, strRange) {
                            var item = {
                                 fltQuoteFee : block.ranges[keyRange].fltCost
                                , fltQuoteFullFee : 0
                                , fltQuoteAdKG : 0
                                , fltRAD : $scope.EX.mapFrecc[strFee].ranges[keyRange].fltRAD
                                , fltEAD : $scope.EX.mapFrecc[strFee].ranges[keyRange].fltEAD
                                , fltACK : 0
                                , fltSEG : 0
                                , fltTotalSEG : 0
                                , fltTotalQuote : 0
                                , fltDisc : 0
                                , strBlockKey : key
                                , strFee : strFee
                            };
                            let fltTarifaPropuesta = 0;
                            let fltTarifaPropuestaZP = 0;
                            let fltAcuse = 0;
                            let fltTarifaPropuesta2 = 0;
                            let fltTarPropuestaZP = 0;
                            if(i > lastBlock.value)
                                item.fltQuoteAdKG = $scope.EX.mapService['Add'].ranges[keyRange].fltCostWeight * ( i - lastBlock.value);
                            if($scope.EX.blnACK){
                                item.fltACK = $scope.EX.mapService['ACK'].ranges[keyRange].fltCost;
                                fltAcuse = $scope.Wrapper.mapACK[$scope.EX.strACK];
                            }
                            if($scope.EX.blnSEG)
                                item.fltSEG = ($scope.Wrapper.mapCS['SEG'] / 1000) * $scope.EX.fltSEG;

                            var itemZP = {};
                            Object.assign(itemZP, item);
                            itemZP.fltEAD = $scope.EX.mapService['ZP'].ranges[keyRange].fltCost;
                            //PAQ
                            item.fltQuoteFullFee = $scope.EX.mapFrecc[item.strFee].ranges[keyRange].fltBaseFee + item.fltRAD + item.fltEAD + fltAcuse + item.fltSEG;
                            fltTarifaPropuesta = item.fltQuoteFee + item.fltQuoteAdKG;
                            fltTarifaPropuesta2 = item.fltACK + fltTarifaPropuesta;
                            //item.fltDisc = (item.fltQuoteFee / $scope.EX.mapFrecc[item.strFee].ranges[keyRange].fltFullFee) - 1;
                            //item.fltDisc = (fltTarifaPropuesta2 / $scope.EX.mapFrecc[item.strFee].ranges[keyRange].fltFullFee) - 1;
                            item.fltDisc = (fltTarifaPropuesta2 / item.fltQuoteFullFee) - 1;
                            if(item.strFee === 'T0' || item.strFee === 'T1'){
                                item.fltTotalQuote = fltTarifaPropuesta2 * ($scope.EX.mapFrecc[item.strFee].ranges[keyRange].intFrecuency / 5);
                                item.fltTotalSEG = item.fltSEG * ($scope.EX.mapFrecc[item.strFee].ranges[keyRange].intFrecuency / 5);

                            }
                            else if(item.strFee !== 'TS' && item.strFee !== 'T0'  && item.strFee !== 'T1'){
                                item.fltTotalQuote = fltTarifaPropuesta2 * ($scope.EX.mapFrecc[item.strFee].ranges[keyRange].intFrecuency / 10);
                                item.fltTotalSEG = item.fltSEG * ($scope.EX.mapFrecc[item.strFee].ranges[keyRange].intFrecuency / 10);

                            }
                            else {
                                item.fltTotalQuote = fltTarifaPropuesta2 * $scope.EX.mapFrecc[item.strFee].ranges[keyRange].intFrecuency;
                                item.fltTotalSEG = item.fltSEG * $scope.EX.mapFrecc[item.strFee].ranges[keyRange].intFrecuency;

                            }
                            $scope.EX.mapQuotes[item.strFee].block[key].strBlock = key;
                            $scope.EX.mapQuotes[item.strFee].block[key].ranges[keyRange] = item;
                            listRanges[keyRange] = item;
                            fltTotalNormal += $scope.EX.mapFrecc[item.strFee].ranges[keyRange].fltTotalNormal;
                            fltTotalQuote += item.fltTotalQuote;
                            fltTotalSEG += item.fltTotalSEG;
                            // ZP
                            itemZP.fltQuoteFullFee = $scope.EX.mapFreccZP[item.strFee].ranges[keyRange].fltBaseFee + itemZP.fltRAD + 208.5 + fltAcuse + itemZP.fltSEG;
                            fltTarifaPropuestaZP += itemZP.fltQuoteFee +  itemZP.fltQuoteAdKG + $scope.EX.mapService['ZP'].ranges[keyRange].fltCost;
                            fltTarPropuestaZP = fltTarifaPropuestaZP + itemZP.fltACK;
                            itemZP.fltDisc = (fltTarPropuestaZP / $scope.EX.mapFreccZP[item.strFee].ranges[keyRange].fltFullFee) -1;
                            if(itemZP.strFee === 'T0' || itemZP.strFee === 'T1'){
                                itemZP.fltTotalQuote = fltTarPropuestaZP * ($scope.EX.mapFreccZP[item.strFee].ranges[keyRange].intFrecuency / 5);
                                itemZP.fltTotalSEG = itemZP.fltSEG * ($scope.EX.mapFreccZP[item.strFee].ranges[keyRange].intFrecuency / 5);

                            }
                            else if(itemZP.strFee !== 'TS' && itemZP.strFee !== 'T0' && itemZP.strFee !== 'T1'){
                                itemZP.fltTotalQuote = fltTarPropuestaZP * ($scope.EX.mapFreccZP[item.strFee].ranges[keyRange].intFrecuency / 10);
                                itemZP.fltTotalSEG = itemZP.fltSEG * ($scope.EX.mapFreccZP[item.strFee].ranges[keyRange].intFrecuency / 10);

                            }
                            else{
                                itemZP.fltTotalQuote = fltTarPropuestaZP * $scope.EX.mapFreccZP[item.strFee].ranges[keyRange].intFrecuency;
                                itemZP.fltTotalSEG = itemZP.fltSEG * $scope.EX.mapFreccZP[item.strFee].ranges[keyRange].intFrecuency;

                            }
                            listRangesZP[keyRange] = itemZP;
                            $scope.EX.mapQuotesZP[itemZP.strFee].block[key].strBlock = key;
                            $scope.EX.mapQuotesZP[itemZP.strFee].block[key].ranges[keyRange] = itemZP;
                            fltTotalNormalZP += $scope.EX.mapFreccZP[item.strFee].ranges[keyRange].fltTotalNormal;
                            fltTotalQuoteZP += itemZP.fltTotalQuote;
                            fltTotalSEGZP += itemZP.fltTotalSEG;
                        });
                        if(i===0)
                            w=1;
                        
                        $scope.EX.mapProjEX[block.strLabel + i] = {
                            strFee : strFee
                            , fltMaxW: w
                            , fltTotalNormal : fltTotalNormal
                            , fltTotalQuote : fltTotalQuote
                            , fltDisc : (fltTotalQuote - fltTotalSEG) / ( fltTotalNormal - fltTotalSEG) -1
                            ,  ranges : listRanges
                        };
                        $scope.EX.TOTAL.PROPUESTA += fltTotalQuote;
                        $scope.EX.TOTAL.SEGURO += fltTotalSEG;
                        $scope.EX.TOTAL.NORMAL += fltTotalNormal;
                        $scope.EX.mapProjEXZP[block.strLabel + i] = {
                            strFee : strFee
                            , fltMaxW: w
                            , fltTotalNormal : fltTotalNormalZP
                            , fltTotalQuote : fltTotalQuoteZP
                            , fltDisc : (fltTotalQuoteZP - fltTotalSEGZP) / ( fltTotalNormalZP - fltTotalSEGZP) -1
                            ,  ranges : listRangesZP
                        };
                        $scope.EX.TOTAL.PROPUESTA += fltTotalQuoteZP;
                        $scope.EX.TOTAL.SEGURO += fltTotalSEGZP;
                        $scope.EX.TOTAL.NORMAL += fltTotalNormalZP;
                    }
                    //T7
                    var fltTotalNormal = 0;
                    var fltTotalQuote = 0 ;
                    var fltTotalSEG = 0;
                    var discV = 0;
                    var discP = 0;
                    var listRanges = {};
                    var t7W = 0;
                    var key = '';
                    var keypeso = '';
                    var decTarifaLlenaT7 = 0;
                    if(lastBlock.value > 60){
                        j$.each($scope.listFee, function (keyFee, strFee) {
                            fltTotalNormal = 0;
                            fltTotalQuote = 0 ;
                            fltTotalSEG = 0;
                            discV = 0;
                            discP = 0;
                            listRanges = {};
                            t7W = 0;
                            key = '';
                            keypeso = '';
                            key = keyFee.replace('_', '');
                            if (keyFee.includes('T7_'))
                                $scope.EX.mapQuotes[keyFee] = {
                                    ranges : {}
                                };
                            j$.each($scope.EX.listRange, function (keyRange, strRange) {
                                if (keyFee.includes('T7_')){
                                    decTarifaLlenaT7 = 0;
                                    var item = {
                                        fltQuoteFee : $scope.EX.mapBlock[key].ranges[keyRange].fltCost
                                        , fltQuoteFullFeeP : $scope.EX.mapTarifas7[keyFee + 'P'].ranges[keyRange].fltFullFee
                                        , fltQuoteFullFeeV : $scope.EX.OWFrecc[keyFee].ranges[keyRange].fltFullFee
                                        , fltQuoteFullFee : $scope.EX.mapBlock[key].ranges[keyRange].fltCost
                                        , fltQuoteBaseFee : 0
                                        , fltQuoteAdKG : $scope.EX.mapService['Add'].ranges[keyRange].fltCostWeight  * ( $scope.EX.OWFrecc[keyFee].ranges[keyRange].fltAVGWeight - lastBlock.value )
                                        , fltQuoteAdM3 : $scope.EX.mapService['Add'].ranges[keyRange].fltCostVol  * ( $scope.EX.OWFrecc[keyFee].ranges[keyRange].fltAVGVol - lastBlock.vol  )
                                        , fltRAD : $scope.EX.OWFrecc[keyFee].ranges[keyRange].fltRAD
                                        , fltEAD : $scope.EX.OWFrecc[keyFee].ranges[keyRange].fltEAD
                                        , fltACK : $scope.EX.mapService['ACK'].ranges[keyRange].fltCost
                                        , fltSEG : $scope.EX.OWFrecc[keyFee].ranges[keyRange].fltSEG
                                        , fltTotalSEG : 0
                                        , fltTotalQuote : 0
                                        , fltDisc : 0
                                        , strBlockKey : lastBlock.key
                                        , strFee : keyFee
                                        , fltTotalNormal : 0
                                    };
                                    if($scope.EX.mapTarifas7[keyFee + 'P'].ranges[keyRange].fltFullFee > 0)
                                        discP = $scope.EX.mapTarifas7[keyFee + 'P'].ranges[keyRange].fltTarPropuesta / $scope.EX.mapTarifas7[keyFee + 'P'].ranges[keyRange].fltFullFee -1;
                                    if($scope.EX.mapTarifas7[keyFee + 'V'].ranges[keyRange].fltFullFee > 0)
                                        discV = $scope.EX.mapTarifas7[keyFee + 'V'].ranges[keyRange].fltTarPropuesta / $scope.EX.mapTarifas7[keyFee + 'V'].ranges[keyRange].fltFullFee -1;
                                    let strTarifa = '';
                                    let TarifaLlena = 0;
                                    let flete = 0;
                                    if(discP < discV ){
                                        item.fltQuoteFullFee = $scope.EX.mapTarifas7[keyFee + 'P'].ranges[keyRange].fltFullFee;
                                        item.fltQuoteBaseFee = item.fltQuoteFee + item.fltQuoteAdKG;
                                        item.fltDisc         = discP;
                                        strTarifa = 'TARIFA T7P';
                                        flete = 
                                        decTarifaLlenaT7 = $scope.EX.mapTarifas7[keyFee + 'P'].ranges[keyRange].fltBaseFee + $scope.EX.mapTarifas7[keyFee + 'P'].ranges[keyRange].fltRAD + $scope.EX.mapTarifas7[keyFee + 'P'].ranges[keyRange].fltEAD;
                                    } else{
                                        item.fltQuoteFullFee = $scope.EX.mapTarifas7[keyFee + 'V'].ranges[keyRange].fltFullFee;
                                        item.fltQuoteBaseFee = item.fltQuoteFee + item.fltQuoteAdKG;
                                        item.fltDisc         = discV;
                                        strTarifa = 'TARIFA T7V';
                                        decTarifaLlenaT7 = $scope.EX.mapTarifas7[keyFee + 'V'].ranges[keyRange].fltBaseFee + $scope.EX.mapTarifas7[keyFee + 'V'].ranges[keyRange].fltRAD + $scope.EX.mapTarifas7[keyFee + 'V'].ranges[keyRange].fltEAD;
                                    }
                                    if(item.fltACK !== 0)
                                        //item.fltQuoteFee += item.fltACK;
                                        decTarifaLlenaT7 += item.fltACK;//item.fltQuoteFee + item.fltACK;
                                    //item.fltTotalQuote = item.fltQuoteFullFee * $scope.EX.OWFrecc[keyFee].ranges[keyRange].intFrecuency;
                                    item.fltTotalQuote = item.fltQuoteFee * $scope.EX.OWFrecc[keyFee].ranges[keyRange].intFrecuency;
                                    item.fltTotalSEG = item.fltSEG * $scope.EX.OWFrecc[keyFee].ranges[keyRange].intFrecuency;
                                    //item.fltTotalNormal = item.fltQuoteFee * $scope.EX.OWFrecc[keyFee].ranges[keyRange].intFrecuency;
                                    item.fltTotalNormal = $scope.EX.OWFrecc[keyFee].ranges[keyRange].intFrecuency * decTarifaLlenaT7;
                                    //item.fltDisc = (item.fltQuoteFee / item.fltQuoteFullFee) - 1;
                                    //item.fltDisc = (decTarifaLlenaT7 / item.fltQuoteFullFee) - 1;
                                    $scope.EX.mapQuotes[keyFee].ranges[keyRange] = item;
                                    listRanges[keyRange] = item;
                                    fltTotalNormal += item.fltTotalNormal;
                                    fltTotalQuote += item.fltTotalQuote;
                                    fltTotalSEG += item.fltTotalSEG;
                                }
                            });
                            $scope.EX.TOTAL.PROPUESTA += fltTotalQuote;
                            $scope.EX.TOTAL.SEGURO += fltTotalSEG;
                            $scope.EX.TOTAL.NORMAL += fltTotalNormal;
                            if (keyFee.includes('T7_')){
                                keypeso = keyFee.replace('T7_', '');
                                $scope.EX.mapProjEX['T7' + keypeso] = {
                                    strFee : 'T7'
                                    , fltMaxW: keypeso
                                    , fltTotalNormal : fltTotalNormal
                                    , fltTotalQuote : fltTotalQuote
                                    , fltDisc : (fltTotalQuote - fltTotalSEG) / ( fltTotalNormal - fltTotalSEG) -1
                                    ,  ranges : listRanges
                                };
                            }
                        });
                    }
                    else{
                        $scope.EX.mapQuotes['T7'] = {
                            strBlock : ''
                            , block : {}
                        };
                        $scope.EX.mapQuotes['T7'].block[lastBlock.key] = {
                            ranges : {}
                        };
                        j$.each($scope.EX.listRange, function (keyRange, strRange) {
                            let fltAcuseT7 = 0;
                            let fltTarifaLlenaV = 0;
                            let fltTarifaLlenaP = 0;
                            let fltEADV = 0;
                            let fltEADP = 0;
                            let fltRADP = 0;
                            let fltRADV = 0;
                            let fltSEV = 0;
                            let fltACK = 0;
                            let fltTarPropV = 0;
                            let fltTarPropP = 0;
                            let fltTotPropV = 0;
                            let fltTotPropP = 0;
                            var item = {
                                //fltQuoteFee : $scope.EX.mapBlock[lastBlock.key].ranges[keyRange].fltCost
                                fltQuoteFee : 0
                                , fltQuoteFullFeeP : 0
                                , fltQuoteFullFeeV : 0
                                , fltQuoteFullFee : 0
                                , fltQuoteBaseFee : 0
                                , fltQuoteAdKG : $scope.EX.mapService['Add'].ranges[keyRange].fltCostWeight  * ( $scope.EX.mapFrecc['T7'].ranges[keyRange].fltAVGWeight - lastBlock.value )
                                , fltQuoteAdM3 : $scope.EX.mapService['Add'].ranges[keyRange].fltCostVol  * ( $scope.EX.mapFrecc['T7'].ranges[keyRange].fltAVGVol - lastBlock.value  )
                                , fltRAD : 0
                                , fltEAD : 0
                                , fltACK : 0
                                , fltSEG : 0
                                , fltTotalSEG : 0
                                , fltTotalQuote : 0
                                , fltDisc : 0
                                , strBlockKey : lastBlock.key
                                , strFee : 'T7'
                                , fltTotalNormal : 0
                            };
                            if($scope.EX.blnACK){
                                item.fltACK = $scope.EX.mapService['ACK'].ranges[keyRange].fltCost;
                                fltAcuseT7 = $scope.Wrapper.mapACK[$scope.EX.strACK];
                            }
                            if($scope.EX.blnSEG)
                                item.fltSEG = ($scope.Wrapper.mapCS['SEG'] / 1000) * $scope.EX.fltSEG;

                            //item.fltQuoteFullFeeP = item.fltQuoteFee + item.fltQuoteAdKG + item.fltRAD + item.fltEAD + item.fltACK + item.fltSEG;
                            //item.fltQuoteFullFeeV = item.fltQuoteFee + item.fltQuoteAdM3 + item.fltRAD + item.fltEAD + item.fltACK + item.fltSEG;
                            fltTarifaLlenaV = $scope.Wrapper.mapTarifarioT['TARIFA T7V'][strRange].Flete__c * $scope.EX.mapFrecc['T7V'].ranges[keyRange].fltAVGVol;
                            fltTarifaLlenaP = $scope.EX.mapFrecc['T7P'].ranges[keyRange].fltAVGWeight * $scope.Wrapper.mapTarifarioT['TARIFA T7P'][strRange].Flete__c;
                            fltTarPropV = $scope.EX.mapBlock[lastBlock.key].ranges[keyRange].fltCost + ($scope.EX.mapFrecc['T7V'].ranges[keyRange].fltAVGVol - $scope.EX.mapBlock[lastBlock.key].fltMaxV) * $scope.EX.mapService['Add'].ranges[keyRange].fltCostVol;
                            fltTarPropP = $scope.EX.mapBlock[lastBlock.key].ranges[keyRange].fltCost + ($scope.EX.mapFrecc['T7P'].ranges[keyRange].fltAVGWeight - $scope.EX.mapBlock[lastBlock.key].fltMaxW) * $scope.EX.mapService['Add'].ranges[keyRange].fltCostWeight;
                            fltTotPropV = fltTarPropV + item.fltACK;
                            fltTotPropP = fltTarPropP + item.fltACK;
                            if($scope.EX.blnEAD){
                                fltEADP = fltTarifaLlenaP * 0.11;
                                fltEADV = fltTarifaLlenaV * 0.11;
                            }
                            if ($scope.EX.blnRAD) {
                                fltRADP = fltTarifaLlenaP * 0.11;
                                fltRADV = fltTarifaLlenaV * 0.11;
                            }
                            /*item.fltQuoteFullFeeP = item.fltQuoteFee + item.fltQuoteAdKG + item.fltRAD + item.fltEAD + fltAcuseT7 + item.fltSEG;
                            item.fltQuoteFullFeeV = item.fltQuoteFee + item.fltQuoteAdM3 + item.fltRAD + item.fltEAD + fltAcuseT7 + item.fltSEG;*/
                            item.fltQuoteFullFeeP = fltTarifaLlenaP + fltRADP + fltEADP + fltAcuseT7 + item.fltSEG;
                            item.fltQuoteFullFeeV = fltTarifaLlenaV + fltRADV + fltEADV + fltAcuseT7 + item.fltSEG;

                            //if($scope.EX.mapFrecc['T7P'].ranges[keyRange].fltFullFee > 0)
                            //discP = item.fltQuoteFullFeeP / $scope.EX.mapFrecc['T7P'].ranges[keyRange].fltFullFee -1;
                            discP = fltTotPropP / item.fltQuoteFullFeeP - 1; 
                            //if($scope.EX.mapFrecc['T7V'].ranges[keyRange].fltFullFee > 0)
                            //discV = item.fltQuoteFullFeeV / $scope.EX.mapFrecc['T7V'].ranges[keyRange].fltFullFee -1;
                            discV = fltTotPropV / item.fltQuoteFullFeeV - 1;

                            if(discP < discV ){
                                item.fltQuoteFullFee = item.fltQuoteFullFeeP;
                                item.fltQuoteBaseFee = item.fltQuoteFee + item.fltQuoteAdKG;
                                item.strFee = 'T7P';
                                item.fltEAD = fltEADP;
                                item.fltRAD = fltRADP;
                                item.fltTotalQuote = (fltTarPropP + item.fltACK) * $scope.EX.mapFrecc['T7'].ranges[keyRange].intFrecuency;
                                item.fltDisc = discP;
                            }
                            else{
                                item.fltQuoteFullFee = item.fltQuoteFullFeeV;
                                item.fltQuoteBaseFee = item.fltQuoteFee + item.fltQuoteAdKG;
                                item.strFee = 'T7V';
                                item.fltEAD = fltEADV;
                                item.fltRAD = fltRADV;
                                item.fltTotalQuote = fltTotPropV * $scope.EX.mapFrecc['T7'].ranges[keyRange].intFrecuency;
                                item.fltDisc = discV;
                            }
                            item.fltTotalNormal = $scope.EX.mapFrecc['T7'].ranges[keyRange].intFrecuency * item.fltQuoteFullFee;
                            $scope.EX.mapFrecc['T7'].ranges[keyRange].fltFullFee = $scope.EX.mapFrecc[item.strFee].ranges[keyRange].fltFullFee;
                            $scope.EX.mapFrecc['T7'].ranges[keyRange].fltTotalNormal = $scope.EX.mapFrecc[item.strFee].ranges[keyRange].fltTotalNormal;
                            
                            item.fltTotalSEG = item.fltSEG * $scope.EX.mapFrecc['T7'].ranges[keyRange].intFrecuency;
                            /*if($scope.EX.blnACK && $scope.isACK('G'))
                                item.fltTotalQuote += (
                                                (
                                                        (
                                                                $scope.EX.mapFrecc[item.strFee].ranges[keyRange].intFrecuency
                                                        )
                                                        * $scope.EX.mapService['ACK'].fltAVGDeliveryByACK
                                                )
                                                / $scope.EX.mapService['ACK'].fltAVGPackByDay
                                        )
                                        * $scope.EX.mapService.ACK.ranges[keyRange].fltCost;*/
                            /*if($scope.EX.mapFrecc[item.strFee].ranges[keyRange].fltTotalNormal > 0 && item.fltQuoteFullFee > 0 )
                                item.fltDisc = (item.fltQuoteFullFee - item.fltTotalSEG) / ($scope.EX.mapFrecc[item.strFee].ranges[keyRange].fltTotalNormal - item.fltTotalSEG) -1;*/
                            //Object.assign($scope.EX.mapQuotes['T7'][keyRange], item);
                            $scope.EX.mapQuotes['T7'].block[lastBlock.key].strBlock = lastBlock.key;
                            $scope.EX.mapQuotes['T7'].block[lastBlock.key].ranges[keyRange] = item;
                            listRanges[keyRange] = item;
                            fltTotalNormal += item.fltTotalNormal;
                            fltTotalQuote += item.fltTotalQuote;
                            fltTotalSEG += item.fltTotalSEG;
                            if($scope.EX.mapFrecc['T7'].ranges[keyRange].fltAVGWeight > t7W)
                                t7W = $scope.EX.mapFrecc['T7'].ranges[keyRange].fltAVGWeight;
                        });

                        $scope.EX.mapProjEX['T7'] = {
                            strFee : 'T7'
                            , fltMaxW : t7W
                            , fltTotalNormal : fltTotalNormal
                            , fltTotalQuote : fltTotalQuote
                            , fltDisc : (fltTotalQuote - fltTotalSEG) / ( fltTotalNormal - fltTotalSEG) -1
                            ,  ranges : listRanges
                        };
                        $scope.EX.TOTAL.PROPUESTA += fltTotalQuote;
                        $scope.EX.TOTAL.SEGURO += fltTotalSEG;
                        $scope.EX.TOTAL.NORMAL += fltTotalNormal;
                    }
                    $scope.EX.TOTAL.DESCUENTO = ($scope.EX.TOTAL.PROPUESTA - $scope.EX.TOTAL.SEGURO) / ( $scope.EX.TOTAL.NORMAL - $scope.EX.TOTAL.SEGURO)-1;
                    //if($scope.EX.blnACK && $scope.isACK('G'))
                    //      $scope.EX.TOTAL.NORMAL += (($scope.EX.TOTAL.PAQUETES * $scope.EX.mapService['ACK'].fltAVGDeliveryByACK) / $scope.EX.mapService['ACK'].fltAVGPackByDay) * $scope.Wrapper.mapACK[$scope.EX.strACK];
                    $scope.calculateDiscProjection();
                };

                $scope.calculateQ = function(){
                    $scope.EX.TOTAL['PAQUETES'] = 0;
                    $scope.EX.blnZP = false;
                    $scope.EX.mapFrecc.fltFTotal = 0;
                    $scope.EX.mapFrecc.fltFEETotal = 0;
                    $scope.EX.mapFreccZP.fltFTotal = 0;
                    $scope.EX.mapFreccZP.fltFEETotal = 0;
                    j$.each($scope.EX.listRange, function (keyRange, strRange) {
                        $scope.EX.mapRanges[keyRange]['PAQ'].intQTotal = Math.round($scope.EX.mapFrecc.intQTotal *  $scope.EX.mapRanges[keyRange]['PAQ'].fltFrecc);
                        $scope.EX.mapRanges[keyRange]['ZP'].intQTotal = Math.round($scope.EX.mapFreccZP.intQTotal *  $scope.EX.mapRanges[keyRange]['ZP'].fltFrecc);
                        $scope.EX.mapFrecc.fltFTotal += $scope.EX.mapRanges[keyRange]['PAQ'].fltFrecc;
                        $scope.EX.mapFreccZP.fltFTotal += $scope.EX.mapRanges[keyRange]['ZP'].fltFrecc;
                    });
                    j$.each($scope.EX.listFee, function (keyFee, strFee) {
                        $scope.EX.mapFrecc[keyFee].intQTotal = Math.round($scope.EX.mapFrecc.intQTotal * $scope.EX.mapFrecc[keyFee].fltFrecc);
                        if(keyFee !== 'T7')
                            $scope.EX.mapFreccZP [keyFee].intQTotal = Math.round($scope.EX.mapFreccZP.intQTotal * $scope.EX.mapFreccZP[keyFee].fltFrecc);
                        j$.each($scope.EX.listRange, function (keyRange, strRange) {
                            $scope.EX.mapFrecc[keyFee].ranges[keyRange].intFrecuency = Math.round($scope.EX.mapFrecc[keyFee].fltFrecc * $scope.EX.mapRanges[keyRange]['PAQ'].intQTotal);
                            $scope.EX.TOTAL['PAQUETES'] += $scope.EX.mapFrecc[keyFee].ranges[keyRange].intFrecuency;
                            if(keyFee !== 'T7'){
                                $scope.EX.mapFreccZP[keyFee].ranges[keyRange].intFrecuency = Math.round($scope.EX.mapFreccZP[keyFee].fltFrecc * $scope.EX.mapRanges[keyRange]['ZP'].intQTotal);
                                $scope.EX.TOTAL['PAQUETES'] += $scope.EX.mapFreccZP[keyFee].ranges[keyRange].intFrecuency;
                            }
                        });
                        $scope.EX.mapFrecc.fltFEETotal += $scope.EX.mapFrecc[keyFee].fltFrecc;
                        if(keyFee !== 'T7')
                            $scope.EX.mapFreccZP.fltFEETotal += $scope.EX.mapFreccZP[keyFee].fltFrecc;
                    });
                    if($scope.EX.mapFreccZP.intQTotal > 0)
                        $scope.EX.blnZP = true;
                    $scope.calculateEX();
                };

                $scope.calculateXY = function(){
                    $scope.EX.blnZP = false;
                    $scope.EX.TOTAL['PAQUETES'] = 0;
                    $scope.EX.mapFrecc.intQTotal = 0;
                    $scope.EX.mapFreccZP.intQTotal = 0;
                    $scope.EX.mapFrecc.fltFTotal = 1;
                    $scope.EX.mapFrecc.fltFEETotal = 1;
                    $scope.EX.mapFreccZP.fltFTotal = 1;
                    $scope.EX.mapFreccZP.fltFEETotal = 1;
                    j$.each($scope.EX.listFee, function (keyFee, strFee) {
                        $scope.EX.mapFrecc[keyFee].intQTotal = 0;
                        if(keyFee !== 'T7')
                            $scope.EX.mapFreccZP[keyFee].intQTotal = 0;
                        j$.each($scope.EX.listRange, function (keyRange, strRange) {
                            $scope.EX.TOTAL['PAQUETES'] += $scope.EX.mapFrecc[keyFee].ranges[keyRange].intFrecuency;
                            if(keyFee !== 'T7')
                                $scope.EX.TOTAL['PAQUETES'] += $scope.EX.mapFreccZP[keyFee].ranges[keyRange].intFrecuency;

                            $scope.EX.mapFrecc.intQTotal += $scope.EX.mapFrecc[keyFee].ranges[keyRange].intFrecuency;
                            $scope.EX.mapFrecc[keyFee].intQTotal += $scope.EX.mapFrecc[keyFee].ranges[keyRange].intFrecuency;
                            if(keyFee !== 'T7'){
                                $scope.EX.mapFreccZP.intQTotal += $scope.EX.mapFreccZP[keyFee].ranges[keyRange].intFrecuency;
                                $scope.EX.mapFreccZP[keyFee].intQTotal += $scope.EX.mapFreccZP[keyFee].ranges[keyRange].intFrecuency;
                            }
                        });
                    });
                    j$.each($scope.EX.listRange, function (keyRange, strRange) { //Salvador: Se recorre la lista de rangos de KM para acceder a la segunda llave
                        j$.each($scope.EX.mapBlock, function(range, item){ //Salvador: Se recorren los bloques de arranque para poder aceder al peso de cada bloque
                            if (item.fltMaxW > 60){ //Salvador: Si el bloque es mayor de 69, es decir a partir de 70 que es cuando empiezan las tarifas T7
                                $scope.EX.TOTAL['PAQUETES'] += $scope.EX.OWFrecc['T7_'+item.fltMaxW].ranges[keyRange].intFrecuency; //Salvador: Se obtiene la frecuencia del bloque
                                //$scope.EX.TOTAL['PAQUETES'] += $scope.EX.OWFrecc['T7_'+item.fltMaxW + 'ZP'].ranges[keyRange].intFrecuency;

                                $scope.EX.mapFrecc.intQTotal += $scope.EX.OWFrecc['T7_'+item.fltMaxW].ranges[keyRange].intFrecuency;
                                $scope.EX.OWFrecc['T7_'+item.fltMaxW].intQTotal += $scope.EX.OWFrecc['T7_'+item.fltMaxW].ranges[keyRange].intFrecuency;
                            }
                        });
                    });
                    j$.each($scope.EX.listFee, function (keyFee, strFee) {
                        if($scope.EX.mapFrecc.intQTotal > 0)
                            $scope.EX.mapFrecc[keyFee].fltFrecc = $scope.EX.mapFrecc[keyFee].intQTotal / $scope.EX.mapFrecc.intQTotal;
                        if(keyFee !== 'T7' && $scope.EX.mapFreccZP.intQTotal > 0)
                            $scope.EX.mapFreccZP[keyFee].fltFrecc = $scope.EX.mapFreccZP[keyFee].intQTotal / $scope.EX.mapFreccZP.intQTotal;
                    });
                    j$.each($scope.EX.listRange, function (keyRange, strRange) {
                        $scope.EX.mapRanges[keyRange]['PAQ'].intQTotal = 0;
                        $scope.EX.mapRanges[keyRange]['ZP'].intQTotal = 0;
                        j$.each($scope.EX.listFee, function (keyFee, strFee) {
                            $scope.EX.mapRanges[keyRange]['PAQ'].intQTotal += $scope.EX.mapFrecc[keyFee].ranges[keyRange].intFrecuency;
                            if(keyFee !== 'T7')
                                $scope.EX.mapRanges[keyRange]['ZP'].intQTotal += $scope.EX.mapFreccZP[keyFee].ranges[keyRange].intFrecuency;
                        });
                        if($scope.EX.mapFrecc.intQTotal > 0) {
                            $scope.EX.mapRanges[keyRange]['PAQ'].fltFrecc = $scope.EX.mapRanges[keyRange]['PAQ'].intQTotal / $scope.EX.mapFrecc.intQTotal;
                            $scope.EX.mapRanges[keyRange]['ZP'].fltFrecc = $scope.EX.mapRanges[keyRange]['ZP'].intQTotal / $scope.EX.mapFrecc.intQTotal;
                        }
                    });
                    if($scope.EX.mapFreccZP.intQTotal > 0)
                        $scope.EX.blnZP = true;
                    $scope.calculateEX();
                };

                $scope.clickFee = function(index, strType){
                    switch (strType) {
                        case 'serviceAdd':
                            $scope.EX.ServiceSelect.available[index].blnSelected = !$scope.EX.ServiceSelect.available[index].blnSelected;
                            break;
                        case 'serviceRemove':
                            $scope.EX.ServiceSelect.selected[index].blnSelected = !$scope.EX.ServiceSelect.selected[index].blnSelected;
                            break;
                    }

                };

                $scope.createQuotesEX = function(){
                    var listDelete = [];
                    var strRange = '';
                    var listQuoteItem = [];
                    var Quote = {
                        Acuse__c: $scope.EX.strACK
                        , AcuseCosto__c : $scope.EX.strAckCost
                        , SBQQ__Primary__c : true
                        , PAQ_TipoServicio__c : 'Estándar terrestre (STD)'
                        , Modelo_de_tarifas__c : 'Costo base más excedente: Por Destinos / Por rangos de km'
                        , Descuento_Global__c : $scope.EX.TOTAL['DESCUENTO'] * - 100
                        , PAQ_DescuentoGlobal__c : $scope.EX.TOTAL['DESCUENTO'] * - 100
                        , Ingreso_Mensual__c : $scope.EX.TOTAL['PROPUESTA']
                        , TarifaLlenaMensual__c : $scope.EX.TOTAL['NORMAL']
                        , Paquetes_Mensuales__c : $scope.EX.TOTAL['PAQUETES']
                        , Gerente_de_sucursal_aprobacion__c : $scope.Managers['GSU']
                        , KAM_aprobacion__c : $scope.Managers['KAM']
                        , Gerente_desarrollo_aprobacion__c : $scope.Managers['GDS']
                        , Director_comercial_aprobacion__c : $scope.Managers['DCO']
                        , Tipo_de_documentacion__c : 'Documentación Remota'
                        , AVRDeliveryACK__c : $scope.EX.mapService['ACK'].fltAVGDeliveryByACK
                        , AVRPackByDelivery__c : $scope.EX.mapService['ACK'].fltAVGPackByDay
                        , Plaza__c: $scope.EX.strOrigin
                        , RangosKM__c: $scope.OnlineDocByRangeKM
                        , Destinos__c: $scope.OnlineDocByDestiny
                        , RecordTypeId : $scope.Wrapper.mapRecordType['EXC']
                    };
                    if($scope.Wrapper.objQuote && $scope.Wrapper.objQuote.Id){
                        Quote.Id = $scope.Wrapper.objQuote.Id;
                        Quote.SBQQ__Status__c = $scope.Wrapper.objQuote.SBQQ__Status__c;
                    }
                    if($scope.Wrapper.objLead && notEmpty($scope.Wrapper.objLead.Id))
                        Quote.Lead__c = $scope.Wrapper.objLead.Id;
                    if($scope.Wrapper.objAccountId)
                        Quote.SBQQ__Account__c = $scope.Wrapper.objAccountId;
                    if($scope.Wrapper.objOpp && notEmpty($scope.Wrapper.objOpp.Id))
                        Quote.SBQQ__Opportunity2__c = $scope.Wrapper.objOpp.Id;
                    Quote.Servicios_adicionales__c = "";
                    if($scope.EX.blnRAD)
                        Quote.Servicios_adicionales__c = "RAD;";
                    if($scope.EX.blnEAD)
                        Quote.Servicios_adicionales__c += "EAD;";
                    if($scope.EX.blnSEG)
                        Quote.Servicios_adicionales__c += "Seguro;";
                    if ($scope.EX.blnACK)
                        Quote.Servicios_adicionales__c += "Acuse " + $scope.EX.strACK;
                    var rangeDisc = 0;
                    //$scope.EX.blnZP = false;
                    j$.each($scope.listFee, function (keyFee, strFee) {
                        if(!keyFee.includes('T7_')){
                            j$.each($scope.EX.mapQuotes[keyFee].block, function(keyblock, block){
                                j$.each($scope.EX.listRange, function (keyRange, labelRange) {
                                    if(keyFee === 'TS'||keyFee === 'T0' ||keyFee === 'T1' ||keyFee === 'T2' ||keyFee === 'T3' ||keyFee === 'T4' ||keyFee === 'T5' ||keyFee === 'T6' ||keyFee === 'T7')
                                        var frecc = $scope.EX.mapFrecc[keyFee].ranges[keyRange];
                                    var quote = $scope.EX.mapQuotes[keyFee].block[block.strBlock].ranges[keyRange];
                                    
                                    if(frecc.intFrecuency > 0){
                                        if (getId(labelRange, $scope.EX.OriginalListRange))
                                            strRange = labelRange;
                                        else
                                            strRange = getRange(labelRange);
                                        if(keyFee === 'TS'||keyFee === 'T0' ||keyFee === 'T1' ||keyFee === 'T2' ||keyFee === 'T3' ||keyFee === 'T4' ||keyFee === 'T5' ||keyFee === 'T6' ||keyFee === 'T7')
                                            var quoteItem = {
                                                SBQQ__Quantity__c : frecc.intFrecuency
                                                , SBQQ__Discount__c : quote.fltDisc
                                                , SBQQ__CustomerPrice__c : quote.fltQuoteFullFee
                                                , SBQQ__NetPrice__c : frecc.fltFullFee
                                                , SBQQ__SpecialPrice__c : frecc.fltFullFee
                                                , QuoteTotal__c :  quote.fltQuoteFullFee
                                                , PackVolAVG__c : $scope.EX.mapBlock[quote.strBlockKey].fltMaxV
                                                , PackWeightAVG__c : $scope.EX.mapBlock[quote.strBlockKey].fltMaxW
                                                , FLETE__c : quote.fltQuoteFee
                                                , ACK__c : $scope.EX.mapService['ACK'].ranges[keyRange].fltCost
                                                , EAD__c : quote.fltEAD
                                                , RAD__c : quote.fltRAD
                                                , SEG__c : quote.fltSEG
                                                , KG_ADICIONAL__c : $scope.EX.mapService['Add'].ranges[keyRange].fltCostWeight
                                                , GUIA__c : quote.fltQuoteFee
                                                , Tarifa__c : strFee
                                                , Rango_KM__c : strRange
                                                , Pack_Seg__c : $scope.EX.fltSEG
                                                , Id : frecc.Id
                                                , SBQQ__Quote__c : Quote.Id

                                            };
                                        if(labelRange.includes(' (')){
                                            quoteItem.Destiny__c = labelRange;
                                        }
                                        if (strFee === 'TARIFA T7') {
                                            quoteItem.Weight__c = $scope.EX.mapFrecc[keyFee].ranges[keyRange].fltAVGWeight;
                                            quoteItem.Width__c = $scope.EX.mapFrecc[keyFee].ranges[keyRange].fltAVGVol;
                                            quoteItem.Large__c = 1;
                                            quoteItem.High__c = 1;
                                        }
                                        if(strFee === 'TARIFA TS')
                                            quoteItem.Tarifa__c = 'TARIFA SOBRE';
                                        if(keyFee !== 'T7'){
                                            if ((quoteItem.SBQQ__Discount__c * -1) > rangeDisc)
                                                rangeDisc = quoteItem.SBQQ__Discount__c * -1;
                                        }
                                        listQuoteItem.push(quoteItem);
                                    }

                                    if(keyFee === 'TS'||keyFee === 'T0' ||keyFee === 'T1' ||keyFee === 'T2' ||keyFee === 'T3' ||keyFee === 'T4' ||keyFee === 'T5' ||keyFee === 'T6'){
                                        var freccZP = $scope.EX.mapFreccZP[keyFee].ranges[keyRange];
                                        //var quoteZP = $scope.EX.mapQuotesZP[keyFee][keyRange];
                                        var quoteZP = $scope.EX.mapQuotesZP[keyFee].block[block.strBlock].ranges[keyRange];
                                        if(freccZP.intFrecuency > 0) {
                                            if (getId(labelRange, $scope.EX.OriginalListRange))
                                                strRange = labelRange;
                                            else
                                                strRange = getRange(labelRange);
                                            var quoteItemZP = {
                                                SBQQ__Quantity__c: freccZP.intFrecuency
                                                , SBQQ__Discount__c: quoteZP.fltDisc
                                                , SBQQ__CustomerPrice__c: quoteZP.fltQuoteFullFee
                                                , SBQQ__NetPrice__c: freccZP.fltFullFee
                                                , SBQQ__SpecialPrice__c: quoteZP.fltFullFee
                                                , QuoteTotal__c: quoteZP.fltQuoteFullFee
                                                , PackVolAVG__c: $scope.EX.mapBlock[quoteZP.strBlockKey].fltMaxV
                                                , PackWeightAVG__c: $scope.EX.mapBlock[quoteZP.strBlockKey].fltMaxW
                                                , FLETE__c: quoteZP.fltQuoteFee
                                                , ACK__c: $scope.EX.mapService['ACK'].ranges[keyRange].fltCost
                                                , EAD__c: quoteZP.fltEAD
                                                , RAD__c: quoteZP.fltRAD
                                                , SEG__c: quoteZP.fltSEG
                                                , KG_ADICIONAL__c: $scope.EX.mapService['Add'].ranges[keyRange].fltCostWeight
                                                , GUIA__c: quoteZP.fltQuoteFee
                                                , Tarifa__c: strFee
                                                , Rango_KM__c: strRange
                                                , Pack_Seg__c: $scope.EX.fltSEG
                                                , Id: freccZP.Id
                                                , SBQQ__Quote__c: Quote.Id
                                                , ZonaPlus__c: true
                                            };
                                            if (!getId(labelRange, $scope.EX.OriginalListRange))
                                                quoteItemZP.Destiny__c = keyRange;
                                            if (strFee === 'TARIFA TS')
                                                quoteItemZP.Tarifa__c = 'TARIFA SOBRE';
                                            //$scope.EX.blnZP = false;
                                            if ((quoteItemZP.SBQQ__Discount__c * -1) > rangeDisc)
                                                rangeDisc = quoteItemZP.SBQQ__Discount__c * -1;
                                            listQuoteItem.push(quoteItemZP);
                                        }
                                        else if (freccZP.intFrecuency === 0 && freccZP.Id)
                                                listDelete.push(freccZP.Id);
                                    }

                                });
                            });
                        } else {
                            var frecc = null;
                            var quote = null;
                            var key = '';
                            key = keyFee.replace('_', '');
                            j$.each($scope.EX.listRange, function (keyRange, labelRange) {
                                if (getId(labelRange, $scope.EX.OriginalListRange))
                                    strRange = labelRange;
                                else
                                    strRange = getRange(labelRange);
                                quote = $scope.EX.mapQuotes[keyFee].ranges[keyRange];
                                frecc = $scope.EX.OWFrecc[keyFee].ranges[keyRange]
                                var quoteItem = {
                                    SBQQ__Quantity__c : frecc.intFrecuency
                                    , SBQQ__Discount__c : quote.fltDisc
                                    , SBQQ__CustomerPrice__c : quote.fltQuoteFullFee
                                    , SBQQ__NetPrice__c : frecc.fltFullFee
                                    , SBQQ__SpecialPrice__c : frecc.fltFullFee
                                    , QuoteTotal__c :  quote.fltQuoteFullFee
                                    , PackVolAVG__c : $scope.EX.mapBlock[key].fltMaxV
                                    , PackWeightAVG__c : $scope.EX.mapBlock[key].fltMaxW
                                    , FLETE__c : quote.fltQuoteFee
                                    , ACK__c : $scope.EX.mapService['ACK'].ranges[keyRange].fltCost
                                    , EAD__c : quote.fltEAD
                                    , RAD__c : quote.fltRAD
                                    , SEG__c : quote.fltSEG
                                    , KG_ADICIONAL__c : $scope.EX.mapService['Add'].ranges[keyRange].fltCostWeight
                                    , GUIA__c : quote.fltQuoteFee
                                    , Tarifa__c : strFee
                                    , Rango_KM__c : strRange
                                    , Pack_Seg__c : $scope.EX.fltSEG
                                    , Id : frecc.Id
                                    //, SBQQ__Quote__c : Quote.Id

                                };
                                if(labelRange.includes(' ('))
                                    quoteItem.Destiny__c = labelRange;
                                quoteItem.Weight__c = $scope.EX.OWFrecc[keyFee].ranges[keyRange].fltAVGWeight;
                                quoteItem.Width__c = $scope.EX.OWFrecc[keyFee].ranges[keyRange].fltAVGVol;
                                quoteItem.Large__c = 1;
                                quoteItem.High__c = 1;
                                listQuoteItem.push(quoteItem);
                            });
                        }
                        
                    });
                    j$.each($scope.DeletedDestiny, function (key, value) {
                        j$.each($scope.EX.listFee, function (keyFee, strFee) {
                            var frecc = $scope.EX.mapFrecc[keyFee].ranges[keyRange];
                            if (frecc.Id)
                                listDelete.push(frecc.Id);
                            var freccZP = $scope.EX.mapFreccZP[keyFee].ranges[keyRange];
                            if (freccZP.Id)
                                listDelete.push(freccZP.Id);
                        });
                    });
                    if($scope.EX.blnZP)
                        Quote.Servicios_adicionales__c += ";EAD Zona plus";
                    Quote.Descuento_por_linea_o_rangokm__c = rangeDisc;
                    if($scope.Wrapper.objLead && notEmpty($scope.Wrapper.objLead.Id))
                        $scope.Wrapper.objLead.Hay_Cotizacion__c = true;
                    else
                        $scope.Wrapper.objLead = null;

                    if($scope.Wrapper.objOpp && notEmpty($scope.Wrapper.objOpp.Id)){
                        var blnHasQuotePending = false;
                        var blnHasQuoteApproved = false;
                        j$.each(
                                $scope.Wrapper.listPrevQuotes
                                , function (index , quoteOpp) {
                                    if(quoteOpp.SBQQ__Status__c === 'In Review')
                                        blnHasQuotePending = true;
                                    if(quoteOpp.SBQQ__Status__c === 'Approved')
                                        blnHasQuoteApproved = true;
                                }
                        );
                        if(blnHasQuoteApproved)
                            $scope.Wrapper.objOpp.StageName = 'Seguimiento a cierre / revisión de condiciones\n';

                        $scope.Wrapper.objOpp.Hay_Cotizacion__c = true;

                        if(blnHasQuotePending)
                            $scope.DML.listErrors.push('Esta oportunidad ya tiene una cotización pendiente de autorización, no es posible crear una nueva en este momento');
                        else if(Quote.Id)
                            if(Quote.SBQQ__Status__c === 'Draft' || Quote.SBQQ__Status__c === 'Rejected')
                                callUpdateQuoteConv($scope, Quote,listQuoteItem,  $scope.Wrapper.objLead, $scope.Wrapper.objOpp, listDelete, null, null);
                            else
                                $scope.DML.listErrors.push('El Estatus actual de la cotización no permite modificaciones');
                        else
                            callCreateQuoteConv($scope, Quote,listQuoteItem,  $scope.Wrapper.objLead, $scope.Wrapper.objOpp, null);

                    }
                    else{
                        if(Quote.Id)
                            if(Quote.SBQQ__Status__c === 'Draft' || Quote.SBQQ__Status__c === 'Rejected')
                                callUpdateQuoteConv($scope, Quote,listQuoteItem,  $scope.Wrapper.objLead, null, listDelete, null, null);
                            else
                                $scope.DML.listErrors.push('El Estatus actual de la cotización no permite modificaciones');
                        else
                            callCreateQuoteConv($scope, Quote,listQuoteItem,  $scope.Wrapper.objLead, null, null);
                    }
                };

                $scope.exceptionAD = function(strFeeKey){
                    return strFeeKey === 'TS';
                };

                $scope.editOrigin = function(){
                    $scope.EX.OriginDisabled = false;
                    $scope.EX.listDestiny = {};
                    $scope.fillRanges();
                };
                $scope.fillRangesByDestiny = function(){
                    $scope.EX.mapFrecc = {};
                    $scope.EX.mapFrecc = {
                        'TS':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T0':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T1':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T2':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T3':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T4':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T5':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T6':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T7':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T7P':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , 'T7V':{ranges:{}, fltFrecc: 0, intQTotal:0}
                        , intQTotal : 0
                        , fltFTotal : 0
                        , fltFEETotal : 0
                    };
                    $scope.EX.mapRanges = {};
                    $scope.EX.mapRanges = {ranges : {}};
                    j$.each($scope.EX.listRange, function (key, str) {
                        $scope.EX.mapRanges[key] = {
                            'PAQ': {fltFrecc: 0, intQTotal:0}
                            , 'ZP' :{fltFrecc: 0, intQTotal:0}
                            , 'T7' :{fltFrecc: 0, intQTotal:0}
                        };
                        /*$scope.EX.mapService['Add'].ranges[key] = { fltCostWeight : 0, fltCostVol : 0};
                        $scope.EX.mapService['ACK'].ranges[key] = { fltCost : 0 };
                        $scope.EX.mapService['ZP'].ranges[key] = { fltCost : 0 };*/
                        $scope.EX.mapRanges[key] = {
                            'PAQ': {fltFrecc: 0, intQTotal:0}
                            , 'ZP' :{fltFrecc: 0, intQTotal:0}
                            , 'T7' :{fltFrecc: 0, intQTotal:0}
                        };
                        j$.each($scope.listFee, function (keyFee, strFee) {
                            //$scope.EX.mapFrecc[keyFee] = {ranges:{}, fltFrecc: 0, intQTotal:0}
                            if(!keyFee.includes('T7_')){
                                $scope.EX.mapFrecc[keyFee].ranges[key] = {
                                    intFrecuency : 0
                                    , fltBaseFee : 0
                                    , fltFullFee : 0
                                    , fltRAD : 0
                                    , fltEAD : 0
                                    , fltACK : 0
                                    , fltSEG : 0
                                    , fltTotalNormal : 0
                                };
                                if(keyFee != 'T7')
                                    $scope.EX.mapFreccZP[keyFee].ranges[key] = {
                                        intFrecuency : 0
                                        , fltBaseFee : 0
                                        , fltFullFee : 0
                                        , fltRAD : 0
                                        , fltEAD : 0
                                        , fltACK : 0
                                        , fltSEG : 0
                                        , fltTotalNormal : 0
                                    };
                                else {
                                    $scope.EX.mapFrecc[keyFee].ranges[key].fltAVGWeight = 0;
                                    $scope.EX.mapFrecc[keyFee].ranges[key].fltAVGVol = 0;
                                    $scope.EX.mapFrecc[keyFee].ranges[key].blnSameWeight = false;
                                    $scope.EX.mapFrecc[keyFee].ranges[key].fltSameVol = false;
                                    /*$scope.EX.mapFrecc['T7V'].ranges[key] = $scope.EX.mapFrecc[keyFee].ranges[key];
                                    $scope.EX.mapFrecc['T7P'].ranges[key] = $scope.EX.mapFrecc[keyFee].ranges[key];*/
                                }
                                //$scope.EX.mapQuotes[keyFee][key] = {};
                                //if(keyFee != 'T7')
                                    //$scope.EX.mapQuotesZP[keyFee][key] = {};
                            }
                        });
                    });
                };
                $scope.fillRanges = function(){
                    if ($scope.OnlineDocByRangeKM || (!$scope.OnlineDocByRangeKM && !$scope.OnlineDocByDestiny)){
                        $scope.EX.listRange = {
                            '0-400': '0-400'
                            , '401-800': '401-800'
                            , '801-1200': '801-1200'
                            , '1201-1600': '1201-1600'
                            , '1601-2000': '1601-2000'
                            , '2001-2400': '2001-2400'
                            , '+2400' :'Más de 2400'
                        };
                        j$.each($scope.EX.listRange, function (key, str) {
                            $scope.EX.mapService['Add'].ranges[key] = { fltCostWeight : 0, fltCostVol : 0};
                            $scope.EX.mapService['ACK'].ranges[key] = { fltCost : 0 };
                            $scope.EX.mapService['ZP'].ranges[key] = { fltCost : 0 };
                            j$.each($scope.listFee, function (keyFee, strFee) {
                                $scope.EX.mapFrecc[keyFee].ranges[key] = {
                                    intFrecuency : 0
                                    , fltBaseFee : 0
                                    , fltFullFee : 0
                                    , fltRAD : 0
                                    , fltEAD : 0
                                    , fltACK : 0
                                    , fltSEG : 0
                                    , fltTotalNormal : 0
                                };
                                if(keyFee != 'T7')
                                    $scope.EX.mapFreccZP[keyFee].ranges[key] = {
                                        intFrecuency : 0
                                        , fltBaseFee : 0
                                        , fltFullFee : 0
                                        , fltRAD : 0
                                        , fltEAD : 0
                                        , fltACK : 0
                                        , fltSEG : 0
                                        , fltTotalNormal : 0
                                    };
                                else {
                                    $scope.EX.mapFrecc[keyFee].ranges[key].fltAVGWeight = 0;
                                    $scope.EX.mapFrecc[keyFee].ranges[key].fltAVGVol = 0;
                                    $scope.EX.mapFrecc[keyFee].ranges[key].blnSameWeight = false;
                                    $scope.EX.mapFrecc[keyFee].ranges[key].fltSameVol = false;
                                    $scope.EX.mapFrecc['T7V'].ranges[key] = $scope.EX.mapFrecc[keyFee].ranges[key];
                                    $scope.EX.mapFrecc['T7P'].ranges[key] = $scope.EX.mapFrecc[keyFee].ranges[key];
                                }
//                                $scope.EX.mapQuotes[keyFee][key] = {};
                                //if(keyFee != 'T7')
                                    //$scope.EX.mapQuotesZP[keyFee][key] = {};
                            });
                        });
                        /*j$.each($scope.EX.listTender, function(keyTender, strTender){
                            $scope.EX.mapQuotes['T7ZP'].Tender[strTender] = {
                                fltSeg : 0
                                , strOrigen : ''
                                , strRange : ''
                                , strTenderDestino : ''
                                , fltFullFee : 0
                                , fltNormalFee : 0
                                , fltTotalQuote : 0
                                , fltDiscount : 0
                                , intFrecuency : 0
                                , fltQuoteFee : 0
                                , fltAmountSeg : 0
                                , fltEAD: 0
                                , fltEADZP: 0
                                , fltRAD : 0
                                , fltAmount : 0
                                , fltACK : 0
                                , fltVolAVR : 0
                                , fltPesoVol : 0
                                , fltWeightAVR : 0
                                , fltWeight : 0
                                , fltWeightAmount : 0
                                , fltVolAmount : 0
                                , fltLargo : 0
                                , fltPeso : 0
                                , fltAlto : 0
                                , fltAncho : 0
                                , fltExc : 0
                                , fltPesoDom : 0
                                , flttarifaProp : 0
                            };
                        
                        });*/
                    } else{
                        $scope.EX.listRange = {};
                    }
                };

                $scope.getKey = function(fltMaxW){
                    var key = null;
                    j$.each($scope.EX.mapLimits, function (keyFee, limits) {
                        if(fltMaxW > limits.min && fltMaxW <= limits.max){
                            key = keyFee;
                            var strKey = fltMaxW.toString();
                            key += strKey.replace('.', '_');
                        }
                    });
                    return key;
                };

                $scope.getMaxKM = function(strKey){
                    var max = 0;
                    var strRange = '';
                    if(getLabel(strKey, $scope.EX.listDestiny))
                        strRange = $scope.EX.listDestiny[strKey].range;
                    else
                        strRange = getLabel(strKey, $scope.EX.listRange);
                    switch(strRange){
                        case '0-400':
                            max = 400;
                            break;
                        case '401-800':
                            max = 800;
                            break;
                        case '801-1200':
                            max = 1200;
                            break;
                        case '1201-1600':
                            max = 1600;
                            break;
                        case '1601-2000':
                            max = 2000;
                            break;
                        case '2001-2400':
                            max = 2400;
                            break;
                        case 'Más de 2400':
                            max = 2401;
                            break;
                        default :
                            break;
                    }
                    return max;
                };

                $scope.insertRange = function(strDestiny, strKM){
                    let newList = {};
                    if(isArrayEmpy($scope.EX.listRange))
                        newList[strDestiny] = strDestiny +' ('+ strKM +')';
                    else {
                        let sortable = [];
                        sortable.push([strDestiny, $scope.getMaxKM(strDestiny)]);
                        j$.each($scope.EX.listRange, function (range, key) {
                            sortable.push([range, $scope.getMaxKM(range)]);
                        });
                        sortable.sort();
                        sortable.sort(function (a, b) {
                            return a[1] - b[1];
                        });
                        j$.each(sortable, function (range, key) {
                            if(getLabel(key[0], $scope.EX.listRange))
                                newList[key[0]] = getLabel(key[0], $scope.EX.listRange);
                            else if(getLabel(key[0], $scope.EX.listDestiny))
                                newList[key[0]] = $scope.EX.listDestiny[key[0]].name;
                        });
                    }
                    let listDestiny = {};
                    Object.assign(listDestiny, $scope.EX.listDestiny);
                    $scope.EX.listRange = newList;

                    $scope.EX.listDestiny = {};
                    if(!isArrayEmpy(listDestiny))
                        j$.each(newList, function (range, key) {
                            if(getLabel(range, listDestiny))
                                $scope.EX.listDestiny[range] = {
                                    range: listDestiny[range].range
                                    , name: listDestiny[range].name
                                };
                        });

                };

                $scope.isACK = function(strMode){
                    return $scope.EX.mapService['ACK'].optForma.model.id === strMode;
                };

                $scope.isException = function(objQuote, strProfile){
                    var exception = false;
                    if(objQuote.PAQ_TipoServicio__c.includes('Estándar terrestre (STD)')) {
                        if (strProfile === 'Ejecutivo de venta') {
                            if (objQuote.Descuento_por_linea_o_rangokm__c <= 60
                                    && objQuote.Descuento_Global__c < 10.01)
                                exception = true;
                        } else if (strProfile === 'Gerente de sucursal') {
                            if (objQuote.Descuento_por_linea_o_rangokm__c <= 60
                                    && objQuote.Descuento_Global__c < 25.01)
                                exception = true;
                        } else if (strProfile === 'KAM Regional') {
                            if (objQuote.Descuento_por_linea_o_rangokm__c <= 60
                                    && objQuote.Descuento_Global__c < 40.01)
                                exception = true;
                        } else if (strProfile === 'Gerentes de desarrollo de Negocios') {
                            if (objQuote.Descuento_Global__c < 60.01)
                                exception = true;
                        } else if (strProfile === 'Director comercial') {
                            exception = true;
                        }
                    }
                    else
                        exception = true;
                    if(exception && objQuote.PAQ_TipoServicio__c.includes('Servicio Express Garantizado (SEG)')){
                        exception = false;
                        if (strProfile === 'Ejecutivo de venta') {
                            if (objQuote.Descuento_por_linea_o_rango_km_Express__c <= 25
                                    && objQuote.Descuento_Global_Express__c <= 10)
                                exception = true;
                        } else if (strProfile === 'Gerente de sucursal') {
                            if (objQuote.Descuento_por_linea_o_rango_km_Express__c <= 25
                                    && objQuote.Descuento_Global_Express__c <= 25)
                                exception = true;
                        } else if (strProfile === 'KAM Regional') {
                            if (objQuote.Descuento_por_linea_o_rango_km_Express__c <= 25
                                    && objQuote.Descuento_Global_Express__c <= 25)
                                exception = true;
                        } else if (strProfile === 'Gerentes de desarrollo de Negocios') {
                            if (objQuote.Descuento_Global_Express__c <= 25)
                                exception = true;
                        } else if (strProfile === 'Director comercial') {
                            exception = true;
                        }
                    }
                    return exception;
                };

                $scope.isFrecc = function(keyFee){
                    return keyFee !== 'intQTotal'
                            && keyFee !== 'fltFTotal'
                            &&  keyFee !== 'fltFEETotal'
                            && keyFee !== 'T7P'
                            && keyFee !== 'T7V'
                            && (keyFee !== 'T7' || !$scope.EX.hasOverWBlocks);
                };

                $scope.isGreen = function(numDisc){
                    return numDisc < 0 && numDisc > -0.401;
                };

                $scope.isYellow = function(numDisc){
                    return numDisc < -0.40 && numDisc > -0.601;
                };

                $scope.isRed = function(numDisc){
                    return numDisc < -0.60;
                };

                $scope.next = function(){
                    $scope.EX.step2 = true;
                    $scope.EX.step1 = false;
                };

                $scope.removeBlock = function(strKey){
                    delete $scope.EX.mapBlock[strKey];
                    var index = j$.inArray(strKey, $scope.listBlocksByMaxW);
                    $scope.listBlocksByMaxW.splice(index, 1);
                    delete $scope.EX.OWFrecc[strKey];
                    $scope.calculateEX();
                };

                $scope.removeService = function(service){
                    var index =  j$.inArray(service, $scope.EX.ServiceSelect.selected);
                    $scope.EX.ServiceSelect.selected.splice(index, 1);
                    $scope.EX.ServiceSelect.available.push(service);
                    switch (service.id) {
                        case 'EAD':
                            $scope.EX.blnEAD = false;
                            break;
                        case 'RAD':
                            $scope.EX.blnRAD = false;
                            break;
                        case 'SEG':
                            $scope.EX.blnSEG = false;
                            break;
                        case 'ACK':
                            $scope.EX.blnACK = false;
                            $scope.EX.strAck = '';
                            break;

                    }
                };

                $scope.replicate = function(strName, blnCheck, key){
                    var fltCost = 0;
                    switch (strName){
                        case 'ZP':
                        case 'ACK':
                            if(blnCheck)
                                j$.each($scope.EX.mapService[strName].ranges, function (range, item) {
                                    if(fltCost === 0)
                                        fltCost = item.fltCost;
                                    else
                                        item.fltCost = fltCost;

                                });
                            break;
                        case 'Add':
                            if(blnCheck)
                                j$.each($scope.EX.mapService[strName].ranges, function (range, item) {
                                    if(fltCost === 0)
                                        fltCost = item.fltCostWeight;
                                    else
                                        item.fltCostWeight = fltCost;

                                    item.fltCostVol = item.fltCostWeight * 200;
                                });
                            break;
                        case 'base':
                            if(blnCheck)
                                j$.each($scope.EX.mapBlock[key].ranges, function (range, item) {
                                    if(fltCost === 0)
                                        fltCost = item.fltCost;
                                    else
                                        item.fltCost = fltCost;
                                });
                            break;
                        case 'OWFrecc':
                            debugger;
                            if(blnCheck )
                                j$.each($scope.EX.OWFrecc[key].ranges, function (range, item) {
                                    if(fltCost === 0)
                                        fltCost = item.intFrecuency;
                                    else
                                        item.intFrecuency = fltCost;
                                    $scope.calculateEX();
                                });
                            break;
                        case 'AVGWeightOW':
                            if(blnCheck )
                                j$.each($scope.EX.OWFrecc[key].ranges, function (range, item) {
                                    if(fltCost === 0)
                                        fltCost = item.fltAVGWeight;
                                    else
                                        item.fltAVGWeight = fltCost;
                                });
                            break;
                        case 'AVGVolOW':
                            if(blnCheck )
                                j$.each($scope.EX.OWFrecc[key].ranges, function (range, item) {
                                    if(fltCost === 0)
                                        fltCost = item.fltAVGVol;
                                    else
                                        item.fltAVGVol = fltCost;
                                });
                            break;
                        case 'AVGVol':
                            if(blnCheck )
                                j$.each($scope.EX.mapFrecc[key].ranges, function (range, item) {
                                    if(fltCost === 0)
                                        fltCost = item.fltAVGVol;
                                    else
                                        item.fltAVGVol = fltCost;
                                });
                            break;
                        case 'AVGWeight':
                            if(blnCheck)
                                j$.each($scope.EX.mapFrecc[key].ranges, function (range, item) {
                                    if(fltCost === 0)
                                        fltCost = item.fltAVGWeight;
                                    else
                                        item.fltAVGWeight = fltCost;
                                });
                            break;
                        case 'Quote7ZP': //29/09/2020 Salvador: Caso para replicar tarifa del mapa de propuesta de T7 ZP
                            if($scope.EX.mapPropuesta['PROP'].blnSameQuote) //29/09/2020 Salvador: si se marcó la casilla de replica
                                j$.each($scope.EX.listRange, function (keyRange, strTender) { //29/09/2020 Salvador: Recorre la lista de rangos para obtener el rango sobre el que va a usar como llame de mappropuesta
                                    if(num == null)
                                        num = $scope.EX.mapPropuesta['PROP'].ranges[keyRange].fltCost;
                                    else $scope.EX.mapPropuesta['PROP'].ranges[keyRange].fltCost = num;
                                });
                        break;
                        case 'frecuencyT7ZP': //29/09/2020 Salvador: Replicar frecuencia de paquetes de cotización T7 ZP
                            if($scope.EX.mapQuotes['T7ZP'].blnSameFrecuency)
                                j$.each($scope.EX.listTender, function (keyTender, strTender) {
                                    if (num === null)
                                        num = $scope.EX.mapQuotes['T7ZP'].Tender[strTender].intFrecuency;
                                    else $scope.EX.mapQuotes['T7ZP'].Tender[strTender].intFrecuency = num;
                                });
                        break;
                        case 'LargeT7ZP': //29/09/2020 Salvador: Replica el valor de la columna "Largo"
                            if($scope.EX.mapQuotes['T7ZP'].blnSameLarge)
                                j$.each($scope.EX.listTender, function (keyTender, strTender) {
                                    if (num === null)
                                        num = $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltLargo;
                                    else $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltLargo = num;
                                });
                        break;
                        case 'AnchoT7ZP': //29/09/2020 Salvador: Replica el valor de la columna "Ancho"
                            if($scope.EX.mapQuotes['T7ZP'].blnSameAncho)
                                j$.each($scope.EX.listTender, function (keyTender, strTender) {
                                    if (num === null)
                                        num = $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltAncho;
                                    else $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltAncho = num;
                                });
                        break;
                        case 'AltoT7ZP': //29/09/2020 Salvador: Replica el valor de la columna "Alto"
                            if($scope.EX.mapQuotes['T7ZP'].blnSameHigh)
                                j$.each($scope.EX.listTender, function (keyTender, strTender) {
                                    if (num === null)
                                        num = $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltAlto;
                                    else $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltAlto = num;
                                });
                        break;
                        case 'PesoT7ZP': //29/09/2020 Salvador: Replica el valor de la columna "Alto"
                            if($scope.EX.mapQuotes['T7ZP'].blnSameWeigth)
                                j$.each($scope.EX.listTender, function (keyTender, strTender) {
                                    if (num === null)
                                        num = $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltPeso;
                                    else $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltPeso = num;
                                });
                        break;
                    }
                };

                $scope.setACK = function(model){
                    $scope.EX.strACK = model.id;
                    $scope.calculateEX();
                };

                $scope.setACKmode = function(model){
                    if(model.id === 'G')
                        $scope.EX.strAckCost = 'Guía';
                    if(model.id === 'B')
                        $scope.EX.strAckCost = 'Paquete';
                    $scope.calculateEX();
                };

                $scope.setValue = function(name, key, cmp, keyX){
                    if (notEmpty(cmp.target.textContent))
                        switch (name) {
                            case 'fltCost':
                                $scope.EX.mapBlock[keyX].ranges[key].fltCost = getNumFromCurrency(cmp.target.textContent);
                                $scope.calculateEX();
                                break;
                            case 'fltMaxW':
                                $scope.EX.mapBlock[keyX].fltMaxW = getNum(cmp.target.textContent);
                                $scope.calculateEX();
                                break;
                            case 'fltMaxV':
                                $scope.EX.mapBlock[keyX].fltMaxV = getNum(cmp.target.textContent);
                                $scope.EX.mapBlock[keyX].fltVolWeight = $scope.EX.mapBlock[keyX].fltMaxV * 200;
                                var strKeyRango = '';
                                j$.each($scope.listBlocksByMaxW, function (k, val) {
                                    if(val.value === $scope.EX.mapBlock[keyX].fltMaxW)
                                        val.vol = $scope.EX.mapBlock[keyX].fltMaxV;
                                    if (keyX.includes('T7'))
                                        strKeyRango = 'T7_' + $scope.EX.mapBlock[keyX].fltMaxW;
                                    j$.each($scope.EX.listRange, function (keyRange, strRange) {
                                        $scope.EX.OWFrecc[strKeyRango].ranges[keyRange].fltAVGVol = $scope.EX.mapBlock[keyX].fltMaxV;
                                    });
                                });
                                
                                oWBlock.ranges[keyRange].fltAVGVol
                                $scope.calculateEX();
                                break;
                            case 'fltCostWeight':
                                $scope.EX.mapService[keyX].ranges[key].fltCostWeight = getNumFromCurrency(cmp.target.textContent);
                                $scope.EX.mapService[keyX].ranges[key].fltCostVol = $scope.EX.mapService[keyX].ranges[key].fltCostWeight * 200;
                                $scope.calculateEX();
                                break;
                            case 'fltCostService':
                                $scope.EX.mapService[keyX].fltCost = getNumFromCurrency(cmp.target.textContent);
                                $scope.calculateEX();
                                break;
                            case 'fltCostRange':
                                $scope.EX.mapService[keyX].ranges[key].fltCost = getNumFromCurrency(cmp.target.textContent);
                                $scope.calculateEX();
                                break;
                            case 'AVGDeliveryACK':
                                $scope.EX.mapService[keyX].fltAVGDeliveryByACK = getNumFromPercent(cmp.target.textContent);
                                $scope.calculateEX();
                                break;
                            case 'AVGPack':
                                $scope.EX.mapService[keyX].fltAVGPackByDay = getNum(cmp.target.textContent);
                                $scope.calculateEX();
                                break;
                            case 'intFrecuency':
                                $scope.EX.mapFrecc[keyX].ranges[key].intFrecuency = getNum(cmp.target.textContent);
                                if($scope.EX.mapFrecc[keyX].ranges[key].intFrecuency !== 0 && $scope.EX.mapFrecc[keyX].ranges[key].intFrecuency !== undefined)
                                    $scope.calculateXY();
                                break;
                            case 'intFrecuencyZP':
                                $scope.EX.mapFreccZP[keyX].ranges[key].intFrecuency = getNum(cmp.target.textContent);
                                if($scope.EX.mapFreccZP[keyX].ranges[key].intFrecuency !== 0 && $scope.EX.mapFreccZP[keyX].ranges[key].intFrecuency !== undefined)
                                    $scope.calculateXY();
                                break;
                            case 'fltFreccFee':
                                $scope.EX.mapFrecc[keyX].fltFrecc = getNumFromPercent(cmp.target.textContent);
                                $scope.calculateQ();
                                break;
                            case 'fltFreccRange':
                                $scope.EX.mapRanges[key]['PAQ'].fltFrecc = getNumFromPercent(cmp.target.textContent);
                                if($scope.EX.mapRanges[key]['PAQ'].fltFrecc !== 0 || $scope.EX.mapRanges[key]['PAQ'].fltFrecc !== undefined)
                                    $scope.calculateQ();
                                break;
                            case 'intQTotal':
                                $scope.EX.mapFrecc.intQTotal = getNum(cmp.target.textContent);
                                $scope.calculateQ();
                                break;
                            case 'fltFreccFeeZP':
                                $scope.EX.mapFreccZP[keyX].fltFrecc = getNumFromPercent(cmp.target.textContent);
                                $scope.calculateQ();
                                break;
                            case 'fltFreccRangeZP':
                                $scope.EX.mapRanges[key]['ZP'].fltFrecc = getNumFromPercent(cmp.target.textContent);
                                $scope.calculateQ();
                                break;
                            case 'intQTotalZP':
                                $scope.EX.mapFreccZP.intQTotal = getNum(cmp.target.textContent);
                                $scope.calculateQ();
                                break;
                            case 'AVGWeightOW':
                                $scope.EX.OWFrecc[keyX].ranges[key].fltAVGWeight = getNum(cmp.target.textContent);
                                $scope.calculateQ();
                                break;
                            case 'AVGVolOW':
                                $scope.EX.OWFrecc[keyX].ranges[key].fltAVGVol = getNum(cmp.target.textContent);
                                $scope.calculateQ();
                                break;
                            case 'intFrecuencyOW':
                                $scope.EX.OWFrecc[keyX].ranges[key].intFrecuency = getNum(cmp.target.textContent);
                                $scope.calculateXY();
                                break;
                            case 'fltAVGWeight':
                                $scope.EX.mapFrecc[keyX].ranges[key].fltAVGWeight = getNumFromCurrency(cmp.target.textContent);
                                $scope.calculateEX();
                                break;
                            case 'fltAVGVol':
                                $scope.EX.mapFrecc[keyX].ranges[key].fltAVGVol = getNumFromCurrency(cmp.target.textContent);
                                $scope.calculateXY();
                                break;
                            case 'PPStrOrigen':
                                var Origen = cmp.target.textContent; //24/09/2020 Salvador: Se respalda el origen digitado.
                                j$.each($scope.EX.listTender, function(keyTender, strTender){
                                    $scope.EX.mapQuotes['T7ZP'].Tender[strTender].strOrigen = Origen; //24/09/2020 Salvador: Se asigna el origen, será el mismo para todos.
                                    $scope.EX.mapQuotes['T7ZP'].Tender[strTender].strTenderDestino = strTender + '70';//24/09/2020 Salvador: Se le agrega un 70 al tender ya que de esa forma se compone la clave
                                    $scope.EX.mapQuotes['T7ZP'].Tender[strTender].fltNormalFee = 208.50; //24/09/2020 Salvador: Cuota fija hasta T6, a partir de aquí se cobran excedentes
                                });
                                j$.each($scope.EX.listTender, function(keyTender, strTender){
                                    ObtieneRangoKMT7ZP($scope, $scope.EX.mapQuotes['T7ZP'].Tender[strTender].strOrigen, strTender);
                                });
                                $scope.LlenaCostoExcedenteT7ZP();
                                $scope.$apply();
                                j$.unblockUI();
                            break;
                            case 'PPfltPeso':
                                $scope.EX.mapQuotes['T7ZP'].Tender[key].fltPeso = getNum(cmp.target.textContent);
                            break;
                            case 'fltCostoPropuestoXKg':
                                var strkey = '';
                                if (key === 'Más de 2400')
                                    strkey = '+2400'
                                else strkey = key;
                                $scope.EX.mapPropuesta['PROP'].ranges[strkey].fltCost  = getNumFromCurrency(cmp.target.textContent);
                            break;
                            case 'fltLargo':
                                $scope.EX.mapQuotes['T7ZP'].Tender[key].fltLargo = getNum(cmp.target.textContent);
                            break;
                            case 'fltAncho':
                                $scope.EX.mapQuotes['T7ZP'].Tender[key].fltAncho = getNum(cmp.target.textContent);
                            break;
                            case 'fltAlto':
                                $scope.EX.mapQuotes['T7ZP'].Tender[key].fltAlto = getNum(cmp.target.textContent);
                            break;
                        }

                };
                
                 $scope.sumbit = function (){
                     debugger;
                    var strNameProcess = '';
                    var strProfile = "{!profileObj}";
                    var objQuote;
                    var gerenteSucursal = null;

                    if(strProfile === 'Ejecutivo de telemarketing'
                        || strProfile === 'Supervisor Telemarketing'
                        || strProfile === 'Gerente comercial nacional')
                        gerenteSucursal = $scope.Managers['GSU'];

                    if(strProfile === 'Ejecutivo de telemarketing' || 'Ejecutivo de telemarketing y CC')
                       strProfile = 'Ejecutivo de venta';
                    
                    if(strProfile === 'Supervisor Telemarketing' )
                       strProfile = 'KAM Regional';
                    
                    if(strProfile === 'Gerente comercial nacional' )
                       strProfile = 'Gerentes de desarrollo de Negocios';

                    if(notEmpty($scope.DML.objQuote))
                        objQuote = $scope.DML.objQuote;
                    else
                        objQuote = $scope.Wrapper.objQuote;

                    $scope.DML.listErrors = [];

                    if($scope.isException(objQuote, strProfile)){
                        objQuote.SBQQ__Status__c = 'Approved';
                        if(objQuote.Lead__c)                          
                            callUpdateStatus($scope, objQuote, objQuote.Lead__r.Name);
                        if(objQuote.SBQQ__Account__c)
                            callUpdateStatus($scope, objQuote, objQuote.SBQQ__Account__r.Name);
                    }
                    else {
                        if(objQuote.SBQQ__Status__c === 'Draft')
                         {
                            if(objQuote.Descuento_por_linea_o_rangokm__c < 60.01 ){
                                if(objQuote.Descuento_Global__c > 10
                                        && objQuote.Descuento_Global__c < 25.01
                                        && objQuote.PAQ_TipoServicio__c.includes('Estándar terrestre (STD)')){
                                    if(strProfile === 'Ejecutivo de venta')
                                        strNameProcess = 'global_10_1_a_25_y_km_menor_a_60';
                                }
                                if(objQuote.Descuento_por_linea_o_rango_km_Express__c < 25 ){
                                    if( objQuote.Descuento_Global_Express__c > 10
                                            && objQuote.Descuento_Global_Express__c < 25.01
                                            && objQuote.PAQ_TipoServicio__c.includes('Servicio Express Garantizado (SEG)')
                                            && strProfile === 'Ejecutivo de venta'
                                    )
                                        strNameProcess = 'AEREO_10_1_A_25_GBAL_MENOR_25_KM';
                                }
                                if(objQuote.Descuento_Global__c > 25
                                        && objQuote.Descuento_Global__c < 40.01
                                        && objQuote.PAQ_TipoServicio__c.includes('Estándar terrestre (STD)')){
                                    if(strProfile === 'Ejecutivo de venta')
                                        strNameProcess = 'global_25_a_40_y_km_menor_que_60';
                                    if(strProfile === 'Gerente de sucursal')
                                        strNameProcess = 'global_25_a_40_y_km_menor_que_60_GE_SUCU';
                                }
                                if(objQuote.Descuento_Global__c > 40
                                        && objQuote.Descuento_Global__c < 60.01
                                        && objQuote.PAQ_TipoServicio__c.includes('Estándar terrestre (STD)')){
                                    if(strProfile === 'Ejecutivo de venta')
                                        strNameProcess = 'global_40_1_a_60_km_menor_a_60_V2';
                                    if(strProfile === 'Gerente de sucursal')
                                        strNameProcess = 'global_40_1_a_60_km_menor_a_60_GE_SUCURS';
                                    if(strProfile === 'KAM Regional')
                                        strNameProcess = 'global_40_1_a_60_Km_menor_a_60_KAM_Regio';
                                }
                                if(objQuote.Descuento_Global__c > 60
                                        && objQuote.PAQ_TipoServicio__c.includes('Estándar terrestre (STD)')){
                                    if(strProfile === 'Ejecutivo de venta')
                                        strNameProcess = 'global_60_o_mas';
                                    if(strProfile === 'Gerente de sucursal')
                                        strNameProcess = 'global_60_o_mas_GE_SUCURSAL';
                                    if(strProfile === 'KAM Regional')
                                        strNameProcess = 'global_60_O_mas_KAM_Regional';
                                    if(strProfile === 'Gerentes de desarrollo de Negocios')
                                        strNameProcess = 'global_60_O_mas_GE_DESARROLLO';
                                }
                            }
                            if(objQuote.Descuento_por_linea_o_rango_km_Express__c > 25 ){

                                if( objQuote.Descuento_Global_Express__c < 10.01
                                        && objQuote.PAQ_TipoServicio__c.includes('Servicio Express Garantizado (SEG)')
                                        && (strProfile === 'Ejecutivo de venta'
                                                || strProfile === 'Gerente de sucursal'
                                                || strProfile === 'KAM Regional'
                                        )
                                )
                                    strNameProcess = 'AEREO_0_A_10_GBAL_25_O_MAS_KM';
                                if( objQuote.Descuento_Global_Express__c > 10
                                        && objQuote.Descuento_Global_Express__c < 25.01
                                        && objQuote.PAQ_TipoServicio__c.includes('Servicio Express Garantizado (SEG)')
                                )
                                    if(strProfile === 'Ejecutivo de venta')
                                        strNameProcess = 'AEREO_10_1_A_25_GBAL_MAYOR_25_KM';
                                if(strProfile === 'Gerente de sucursal' || strProfile === 'KAM Regional')
                                    strNameProcess = 'AEREO_10_1_A_25_GBAL_MAYOR_25_KM_GE_SUC';
                            }
                            if(objQuote.Descuento_por_linea_o_rangokm__c > 60 ){
                                if(objQuote.Descuento_Global__c < 10.01
                                        && objQuote.PAQ_TipoServicio__c.includes('Estándar terrestre (STD)')){
                                    if(strProfile === 'Ejecutivo de venta')
                                        strNameProcess = 'global_0_a_10_y_km_mayor_a_60';
                                    if(strProfile === 'Gerente de sucursal')
                                        strNameProcess = 'global_0_a_10_y_km_mayor_a_60_GE_SUCURSA';
                                    if(strProfile === 'KAM Regional')
                                        strNameProcess = 'global_0_a_10_y_km_mayor_a_60_KAM';
                                }
                                if(objQuote.Descuento_Global__c > 10
                                        && objQuote.Descuento_Global__c < 25.01
                                        && objQuote.PAQ_TipoServicio__c.includes('Estándar terrestre (STD)')){
                                    if(strProfile === 'Ejecutivo de venta')
                                        strNameProcess = 'global_10_1_a_25_y_km_60_o_mas';
                                    if(strProfile === 'Gerente de sucursal')
                                        strNameProcess = 'global_10_1_a_25_y_km_60_o_mas_GE_SUCURS';
                                    if(strProfile === 'KAM Regional')
                                        strNameProcess = 'global_10_1_a_25_y_km_60_o_mas_KAM';
                                }
                                if(objQuote.Descuento_Global__c > 25
                                        && objQuote.Descuento_Global__c < 40.01
                                        && objQuote.PAQ_TipoServicio__c.includes('Estándar terrestre (STD)')){
                                    if(strProfile === 'Ejecutivo de venta')
                                        strNameProcess = 'global_25_a_40_y_km_60_o_mas';
                                    if(strProfile === 'Gerente de sucursal')
                                        strNameProcess = 'global_25_a_40_y_km_60_o_mas_GE_SUCURSAL';
                                    if(strProfile === 'KAM Regional')
                                        strNameProcess = 'global_25_a_40_y_km_60_o_mas_KAM_Regiona';
                                }
                                if(objQuote.Descuento_Global__c > 40
                                        && objQuote.Descuento_Global__c < 60.01
                                        && objQuote.PAQ_TipoServicio__c.includes('Estándar terrestre (STD)')){
                                    if(strProfile === 'Ejecutivo de venta')
                                        strNameProcess = 'global_40_1_a_60_km_mayor_a_60';
                                    if(strProfile === 'Gerente de sucursal')
                                        strNameProcess = 'global_40_1_a_60_km_mayor_a_60_GE_SUCU';
                                    if(strProfile === 'KAM Regional')
                                        strNameProcess = 'global_40_1_a_60_km_mayor_a_60_KAM_Regi';
                                }
                                if(objQuote.Descuento_Global__c > 60
                                        && objQuote.PAQ_TipoServicio__c.includes('Estándar terrestre (STD)')){
                                    if(strProfile === 'Ejecutivo de venta')
                                        strNameProcess = 'global_60_o_mas';
                                    if(strProfile === 'Gerente de sucursal')
                                        strNameProcess = 'global_60_o_mas_GE_SUCURSAL';
                                    if(strProfile === 'KAM Regional')
                                        strNameProcess = 'global_60_O_mas_KAM_Regional';
                                    if(strProfile === 'Gerentes de desarrollo de Negocios')
                                        strNameProcess = 'global_60_O_mas_GE_DESARROLLO';

                                }

                            }
                            if(objQuote.Descuento_Global_Express__c > 25
                                    && objQuote.PAQ_TipoServicio__c.includes('Servicio Express Garantizado (SEG)')) {
                                if(strProfile === 'Ejecutivo de venta')
                                    strNameProcess = 'AEREO_MAYOR_DE_25_GLOBAL';
                                if(strProfile === 'Gerente de sucursal')
                                    strNameProcess = 'AEREO_MAYOR_DE_25_GLOBAL_G_SUC';
                                if(strProfile === 'KAM Regional')
                                    strNameProcess = 'AEREO_MAYOR_DE_25_GLOBAL_KAM';
                                if(strProfile === 'Gerentes de desarrollo de Negocios')
                                    strNameProcess = 'AEREO_MAYOR_DE_25_GERENTE_DESARROLLO';
                            }
                        }
                        if(notEmpty(strNameProcess))
                            callSent($scope, $scope.Wrapper.objQuote.Id, strNameProcess, $scope.EX.strApprovalComment);
                        else
                            $scope.DML.listErrors.push('NO se encontró el proceso de aprobación aplicable');
                    }
                };
                

                $scope.updateFees = function(strOpp, strList){
                    switch (strOpp) {
                        case 'add':
                            if(strList=== 'service')
                                for (var index = 0; index <= $scope.EX.ServiceSelect.available.length; index++){
                                    var service = $scope.EX.ServiceSelect.available[index];
                                    if(service && service.blnSelected){
                                        service.blnSelected = false;
                                        $scope.addService(service);
                                        index--;
                                    }
                                }
                            $scope.calculateEX();
                            break;
                        case 'remove':
                             if(strList=== 'service')
                                for (var index = 0; index <= $scope.EX.ServiceSelect.selected.length; index++){
                                    var service = $scope.EX.ServiceSelect.selected[index];
                                    if(service && service.blnSelected){
                                        service.blnSelected = false;
                                        $scope.removeService(service);
                                        index--;
                                    }
                                }
                            $scope.calculateEX();
                            break;
                    }
                    $scope.EX.blnFeeAddAll = false;
                    $scope.EX.blnFeeRemoveAll = false;
                    $scope.EX.blnServiceAddAll = false;
                    $scope.EX.blnServiceRemoveAll = false;
                };

                $scope.validateKG = function(fltMaxW){
                    return isNaN(fltMaxW) || fltMaxW < 1 ;
                };

                $scope.dataTest = function(){
                    $scope.EX.mapRanges['0-400']['PAQ'].fltFrecc = .15;
                    $scope.EX.mapRanges['0-400']['ZP'].fltFrecc = .15;
                    $scope.EX.mapRanges['401-800']['PAQ'].fltFrecc = .20;
                    $scope.EX.mapRanges['401-800']['ZP'].fltFrecc = .20;
                    $scope.EX.mapRanges['801-1200']['PAQ'].fltFrecc = .20;
                    $scope.EX.mapRanges['801-1200']['ZP'].fltFrecc = .20;
                    $scope.EX.mapRanges['1201-1600']['PAQ'].fltFrecc = .10;
                    $scope.EX.mapRanges['1201-1600']['ZP'].fltFrecc = .10;
                    $scope.EX.mapRanges['1601-2000']['PAQ'].fltFrecc = .20;
                    $scope.EX.mapRanges['1601-2000']['ZP'].fltFrecc = .20;
                    $scope.EX.mapRanges['2001-2400']['PAQ'].fltFrecc = .10;
                    $scope.EX.mapRanges['2001-2400']['ZP'].fltFrecc = .10;
                    $scope.EX.mapRanges['+2400']['PAQ'].fltFrecc = .05;
                    $scope.EX.mapRanges['+2400']['ZP'].fltFrecc = .05;
                    $scope.EX.mapFrecc['TS'].fltFrecc = .30;
                    $scope.EX.mapFreccZP['TS'].fltFrecc = .30;
                    $scope.EX.mapFrecc['T0'].fltFrecc = .35;
                    $scope.EX.mapFreccZP['T0'].fltFrecc = .35;
                    $scope.EX.mapFrecc['T1'].fltFrecc = .10;
                    $scope.EX.mapFreccZP['T1'].fltFrecc = .10;
                    $scope.EX.mapFrecc['T2'].fltFrecc = .07;
                    $scope.EX.mapFreccZP['T2'].fltFrecc = .07;
                    $scope.EX.mapFrecc['T3'].fltFrecc = .06;
                    $scope.EX.mapFreccZP['T3'].fltFrecc = .06;
                    $scope.EX.mapFrecc['T4'].fltFrecc = .05;
                    $scope.EX.mapFreccZP['T4'].fltFrecc = .05;
                    $scope.EX.mapFrecc['T5'].fltFrecc = .03;
                    $scope.EX.mapFreccZP['T5'].fltFrecc = .04;
                    $scope.EX.mapFrecc['T6'].fltFrecc = .03;
                    $scope.EX.mapFreccZP['T6'].fltFrecc = .03;
                    $scope.EX.mapFrecc['T7'].fltFrecc = .01;
                    j$.each($scope.EX.listRange, function (keyRange, range) {
                        $scope.EX.mapFrecc['T7'].ranges[keyRange].fltAVGWeight =  155.3;
                        $scope.EX.mapFrecc['T7'].ranges[keyRange].fltAVGVol =  1.3;
                        $scope.EX.mapService['ZP'].ranges[keyRange].fltCost = 150;
                        $scope.EX.mapService['ACK'].ranges[keyRange].fltCost = 25;
                    });
                    $scope.EX.mapFrecc.intQTotal = 23040;
                    $scope.EX.mapFreccZP.intQTotal = 15000;
                    $scope.addBlock(4);
                    $scope.EX.mapBlock['T04'].fltVolW = .009;
                    $scope.EX.mapBlock['T04'].fltVolWeight = 1.8;
                    $scope.addBlock(9);
                    $scope.EX.mapBlock['T19'].fltVolW = .015;
                    $scope.EX.mapBlock['T19'].fltVolWeight = 3;
                    $scope.EX.mapBlock['T04'].ranges['0-400'].fltCost = 85;
                    $scope.EX.mapBlock['T04'].ranges['401-800'].fltCost = 85;
                    $scope.EX.mapBlock['T04'].ranges['801-1200'].fltCost = 85;
                    $scope.EX.mapBlock['T04'].ranges['1201-1600'].fltCost = 95;
                    $scope.EX.mapBlock['T04'].ranges['1601-2000'].fltCost = 95;
                    $scope.EX.mapBlock['T04'].ranges['2001-2400'].fltCost = 95;
                    $scope.EX.mapBlock['T04'].ranges['+2400'].fltCost = 95;
                    $scope.EX.mapBlock['T19'].ranges['0-400'].fltCost = 95;
                    $scope.EX.mapBlock['T19'].ranges['401-800'].fltCost = 95;
                    $scope.EX.mapBlock['T19'].ranges['801-1200'].fltCost = 95;
                    $scope.EX.mapBlock['T19'].ranges['1201-1600'].fltCost = 105;
                    $scope.EX.mapBlock['T19'].ranges['1601-2000'].fltCost = 105;
                    $scope.EX.mapBlock['T19'].ranges['2001-2400'].fltCost = 105;
                    $scope.EX.mapBlock['T19'].ranges['+2400'].fltCost = 105;
                    $scope.EX.mapService['Add'].ranges['0-400'].fltCostWeight = 4.75;
                    $scope.EX.mapService['Add'].ranges['401-800'].fltCostWeight = 4.75;
                    $scope.EX.mapService['Add'].ranges['801-1200'].fltCostWeight = 4.75;
                    $scope.EX.mapService['Add'].ranges['1201-1600'].fltCostWeight = 6;
                    $scope.EX.mapService['Add'].ranges['1601-2000'].fltCostWeight = 6;
                    $scope.EX.mapService['Add'].ranges['2001-2400'].fltCostWeight = 6;
                    $scope.EX.mapService['Add'].ranges['+2400'].fltCostWeight = 6;
                    $scope.EX.mapService['Add'].ranges['0-400'].fltCostVol = 4.75 * 200;
                    $scope.EX.mapService['Add'].ranges['401-800'].fltCostVol = 4.75 * 200;
                    $scope.EX.mapService['Add'].ranges['801-1200'].fltCostVol = 4.75 * 200;
                    $scope.EX.mapService['Add'].ranges['1201-1600'].fltCostVol = 6 * 200;
                    $scope.EX.mapService['Add'].ranges['1601-2000'].fltCostVol =  6 * 200;
                    $scope.EX.mapService['Add'].ranges['2001-2400'].fltCostVol =  6 * 200;
                    $scope.EX.mapService['Add'].ranges['+2400'].fltCostVol =  6 * 200;
                    $scope.calculateQ();
                };

                $scope.LlenaCostoExcedenteT7ZP = function(){
                    $scope.EX.mapQuotes['T7ZP'].Tender['ACA'].fltExc = 5.4;
                    $scope.EX.mapQuotes['T7ZP'].Tender['AGU'].fltExc = 13;
                    $scope.EX.mapQuotes['T7ZP'].Tender['BJX'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['CEN'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['CLQ'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['COA'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['CPE'].fltExc = 5.4;
                    $scope.EX.mapQuotes['T7ZP'].Tender['CRB'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['CUL'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['CUN'].fltExc = 13;
                    $scope.EX.mapQuotes['T7ZP'].Tender['CUU'].fltExc = 5.4;
                    $scope.EX.mapQuotes['T7ZP'].Tender['CVJ'].fltExc = 13;
                    $scope.EX.mapQuotes['T7ZP'].Tender['CVM'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['DGO'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['ENS'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['GDL'].fltExc = 5.4;
                    $scope.EX.mapQuotes['T7ZP'].Tender['HMO'].fltExc = 13;
                    $scope.EX.mapQuotes['T7ZP'].Tender['IGW'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['JRI'].fltExc = 0;
                    $scope.EX.mapQuotes['T7ZP'].Tender['LAP'].fltExc = 5.4;
                    $scope.EX.mapQuotes['T7ZP'].Tender['LDM'].fltExc = 0;
                    $scope.EX.mapQuotes['T7ZP'].Tender['LMM'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['LOV'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['MEX'].fltExc = 5.4;
                    $scope.EX.mapQuotes['T7ZP'].Tender['MID'].fltExc = 5.4;
                    $scope.EX.mapQuotes['T7ZP'].Tender['MLM'].fltExc = 13;
                    $scope.EX.mapQuotes['T7ZP'].Tender['MTY'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['MXL'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['MZT'].fltExc = 0;
                    $scope.EX.mapQuotes['T7ZP'].Tender['NJA'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['OAX'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['PBC'].fltExc = 13;
                    $scope.EX.mapQuotes['T7ZP'].Tender['PCA'].fltExc = 13;
                    $scope.EX.mapQuotes['T7ZP'].Tender['PVR'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['QRO'].fltExc = 13;
                    $scope.EX.mapQuotes['T7ZP'].Tender['SLP'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['SLW'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['TGZ'].fltExc = 13;
                    $scope.EX.mapQuotes['T7ZP'].Tender['TIJ'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['TLC'].fltExc = 7.6;
                    $scope.EX.mapQuotes['T7ZP'].Tender['TPQ'].fltExc = 5.4;
                    $scope.EX.mapQuotes['T7ZP'].Tender['VSA'].fltExc = 5.4;
                    $scope.EX.mapQuotes['T7ZP'].Tender['ZCL'].fltExc = 13;
                    $scope.EX.mapQuotes['T7ZP'].Tender['VER'].fltExc = 0;
                }
                $scope.AgregaTotalPropuestaMapaPropuesta = function(strRange, fltTotal){
                    var rango = '';
                    if (strRange === 'Más de 2400')
                        rango = '+2400';
                    else rango = strRange;
                    if(fltTotal !== 0)
                        $scope.EX.mapPropuesta['PROP'].ranges[rango].fltTotalPropuesta += fltTotal;
                }
                $scope.AgregaTotalTarifaLlenaMapaPropuesta = function(strRange, fltTotal){
                    var rango = '';
                    if (strRange === 'Más de 2400')
                        rango = '+2400';
                    else rango = strRange;
                    if(fltTotal !== 0)
                        $scope.EX.mapPropuesta['PROP'].ranges[rango].fltTotalTarifaLlena += fltTotal;
                }
                $scope.AgregaTotalesT7ZP = function(intPaq, fltTotProp, fltTotNormal, fltDesc){
                    $scope.EX.TOTAL['NORMAL']       += fltTotNormal;
                    $scope.EX.TOTAL['PROPUESTA']    += fltTotProp;
                    $scope.EX.TOTAL['PAQUETES']     += intPaq;
                }
                $scope.AgregaDescuentoMapaPropuesta = function(strRange, fltTotalPropuesta, fltTotalTarifaLlena){
                    var range = '';
                    var descuento = 0;
                    if (strRange === 'Más de 2400')
                        range = '+2400';
                    else range = strRange;
                    if(range !== ''){
                        $scope.EX.mapPropuesta['PROP'].ranges[range].fltDescuento = fltTotalPropuesta / fltTotalTarifaLlena - 1;
                        j$.each($scope.EX.listRange, function (keyRange, strRange) {
                            $scope.EX.mapPropuesta['PROP'].fltFeeTotalNormal     += $scope.EX.mapPropuesta['PROP'].ranges[keyRange].fltTotalPropuesta;
                            $scope.EX.mapPropuesta['PROP'].fltFeeTotalQuote      += $scope.EX.mapPropuesta['PROP'].ranges[keyRange].fltTotalTarifaLlena;
                        });
                        descuento = $scope.EX.mapPropuesta['PROP'].fltFeeTotalQuote / $scope.EX.mapPropuesta['PROP'].fltFeeTotalNormal - 1;
                        $scope.EX.mapPropuesta['PROP'].fltFeeTotalDesc       = descuento;
                    }
                }
                /*
                * initial Call
                */
                console.log('END LOAD Angular Controller EXC');
                $scope.fillRanges();
                debugger;
                if($scope.hasRecord()){
                    $scope.EX.strAck = $scope.Wrapper.objQuote.Acuse__c;
                    $scope.OnlineDocByRangeKM = $scope.Wrapper.objQuote.RangosKM__c;
                    $scope.OnlineDocByDestiny = $scope.Wrapper.objQuote.Destinos__c;
                    $scope.fillRanges();
                    if ($scope.Wrapper.objQuote.Destinos__c)
                        $scope.EX.listRange = {};
                    if($scope.Wrapper.objQuote.Servicios_adicionales__c)
                        j$.each( $scope.Wrapper.objQuote.Servicios_adicionales__c.split(';'),function (key, service) {
                            switch (service) {
                                case 'RAD':
                                    $scope.EX.blnRAD = true;
                                    break;
                                case 'EAD':
                                    $scope.EX.blnEAD = true;
                                    break;
                                case 'Seguro':
                                    $scope.EX.blnSEG = true;
                                    break;
                                case 'Acuse Empresa':
                                    $scope.EX.blnACK = true;
                                    break;
                                case 'Acuse Interno':
                                    $scope.EX.blnACK = true;
                                    break;
                                case 'Acuse XT':
                                    $scope.EX.blnACK = true;
                                    break;
                            }
                        });
                    j$.each($scope.EX.ServiceSelect.available, function(key, value){
                        switch (value.id) {
                            case 'RAD':
                                value.blnSelected = $scope.EX.blnRAD;
                                break;
                            case 'EAD':
                                value.blnSelected = $scope.EX.blnEAD;
                                break;
                            case 'SEG':
                                value.blnSelected = $scope.EX.blnSEG;
                                break;
                            case 'ACK':
                                value.blnSelected = notEmpty($scope.Wrapper.objQuote.Acuse__c);
                                break;
                        }
                    });
                    $scope.EX.strACK = $scope.Wrapper.objQuote.Acuse__c;
                    $scope.EX.mapService['ACK'].optOption.model = getModel($scope.EX.strACK, $scope.EX.mapService['ACK'].optOption.aviableOptions);
                    $scope.EX.strAckCost = $scope.Wrapper.objQuote.AcuseCosto__c;
                    $scope.EX.mapService['ACK'].fltAVGDeliveryByACK = $scope.Wrapper.objQuote.AVRDeliveryACK__c;
                    $scope.EX.mapService['ACK'].fltAVGPackByDay = $scope.Wrapper.objQuote.AVRPackByDelivery__c;
                    if($scope.EX.strAckCost === 'P')
                        $scope.EX.mapService['ACK'].optForma.model = getModel('B', $scope.EX.mapService['ACK'].optForma.aviableOptions);
                    else
                        $scope.EX.mapService['ACK'].optForma.model = getModel('G', $scope.EX.mapService['ACK'].optForma.aviableOptions);
                    j$.each($scope.Wrapper.listQuoteItem, function (index, quoteItem) {
                        if (quoteItem.PackWeightAVG__c > 60){
                            var key = 'T7' + quoteItem.PackWeightAVG__c;
                            var keyFee = quoteItem.Tarifa__c;
                            $scope.EX.hasOverWBlocks = true;
                        } else {
                            var key = $scope.getKey(quoteItem.PackWeightAVG__c);
                            var keyFee = getId(quoteItem.Tarifa__c, $scope.EX.listFee);
                        }
                        if ($scope.Wrapper.objQuote.Destinos__c){
                            var keyr = '';
                            var destino = '';
                            var destinyok = '';
                            if(quoteItem.Destiny__c.includes('Más'))
                                destinyok = quoteItem.Destiny__c.replace('Más de ', '+')
                            else destinyok = quoteItem.Destiny__c;
                            if (quoteItem.Rango_KM__c === 'Más de 2400')
                                keyr = '+2400';
                            else keyr = quoteItem.Rango_KM__c;
                            destino = quoteItem.Destiny__c.replace(' (' + quoteItem.Rango_KM__c+')', '');
                            var keyRange = destino;
                            if(!getLabel(destino, $scope.EX.mapService)){
                                $scope.EX.mapService['Add'].ranges[destino] = { fltCostWeight : 0, fltCostVol : 0};
                                $scope.EX.mapService['ACK'].ranges[destino] = { fltCost : 0 };
                                $scope.EX.mapService['ZP'].ranges[destino] = { fltCost : 0 };
                            }
                            $scope.insertRange(destino, quoteItem.Rango_KM__c);
                            if (quoteItem.PackWeightAVG__c > 60){
                                $scope.listFee['T7_'+ quoteItem.PackWeightAVG__c] = 'TARIFA T7_'+ quoteItem.PackWeightAVG__c;
                                if(!getLabel('T7_'+ quoteItem.PackWeightAVG__c, $scope.EX.mapQuotes))
                                    $scope.EX.mapQuotes['T7_' + quoteItem.PackWeightAVG__c] = {};
                                $scope.EX.listDestiny[destino] = {
                                    range: keyr
                                    , name: quoteItem.Destiny__c
                                };
                                if(!getLabel('T7'+ quoteItem.PackWeightAVG__c, $scope.EX.mapBlock))
                                    $scope.EX.mapBlock['T7' + quoteItem.PackWeightAVG__c] = {
                                        strLabel : 'T7'
                                        , fltMaxW : quoteItem.PackWeightAVG__c
                                        , fltVolW : quoteItem.PackVolAVG__c
                                        , fltVolWeight: 0
                                        , blnSameCost : false
                                        , ranges : {}
                                    };
                                $scope.listBlocksByMaxW.push({key:key, value: quoteItem.PackWeightAVG__c});
                                if(!getLabel(destino, $scope.EX.mapBlock['T7' + quoteItem.PackWeightAVG__c].ranges[destino]))
                                    $scope.EX.mapBlock['T7' + quoteItem.PackWeightAVG__c].ranges[destino] = {
                                        fltCost : 0
                                    };
                                if(!getLabel('T7_'+ quoteItem.PackWeightAVG__c, $scope.EX.OWFrecc))
                                    $scope.EX.OWFrecc['T7_'+ quoteItem.PackWeightAVG__c] = {
                                        ranges:{}
                                        , fltFrecc: 0
                                        , intQTotal:0
                                        , strName: quoteItem.PackWeightAVG__c + 'kg'
                                        , blnSameFrecc :false
                                        , blnSameWeight :false
                                        , blnSameVol :false
                                    };
                                if(!getLabel(destino, $scope.EX.OWFrecc['T7_'+ quoteItem.PackWeightAVG__c].ranges[destino])){
                                    $scope.EX.OWFrecc['T7_'+ quoteItem.PackWeightAVG__c].ranges[destino] = {
                                        intFrecuency : 0
                                        , fltAVGWeight : quoteItem.PackWeightAVG__c
                                        , fltAVGVol : quoteItem.PackVolAVG__c
                                        , fltBaseFee : 0
                                        , fltFullFee : 0
                                        , fltRAD : 0
                                        , fltEAD : 0
                                        , fltACK : 0
                                        , fltSEG : 0
                                        , fltTotalNormal : 0
                                    };
                                    $scope.EX.mapQuotes['T7_'+ quoteItem.PackWeightAVG__c][destino] = {};
                                }
                            } else {
                                if(!getLabel(key, $scope.EX.mapBlock))
                                    $scope.EX.mapBlock[key] = {
                                        strLabel : key
                                        , fltMaxW : quoteItem.PackWeightAVG__c
                                        , fltVolW : quoteItem.PackVolAVG__c
                                        , fltVolWeight: 0
                                        , blnSameCost : false
                                        , ranges : {}
                                    };
                                $scope.listBlocksByMaxW.push({key:key, value: quoteItem.PackWeightAVG__c});
                                j$.each($scope.EX.listFee, function(keyFee, strFee){
                                    $scope.EX.mapBlock[key].ranges[destino] = {
                                        fltCost : 0
                                    }
                                    if(!getLabel(destino, $scope.EX.mapFrecc[keyFee].ranges))
                                        $scope.EX.mapFrecc[keyFee].ranges[destino] = {
                                            intFrecuency : 0
                                            , fltBaseFee : 0
                                            , fltBaseFeeP : 0
                                            , fltFullFee : 0
                                            , fltFullFeeP : 0
                                            , fltRAD : 0
                                            , fltRADP : 0
                                            , fltEAD : 0
                                            , fltEADP : 0
                                            , fltACK : 0
                                            , fltACKP : 0
                                            , fltSEG : 0
                                            , fltTotalNormal : 0
                                            , fltTotalNormalP : 0
                                            , fltAVGVol : $scope.EX.mapBlock[key].fltMaxV
                                            , fltAVGWeight : $scope.EX.mapBlock[key].fltMaxW
                                        };
                                    if(!getLabel(destino, $scope.EX.mapFreccZP[keyFee].ranges))
                                        $scope.EX.mapFreccZP[keyFee].ranges[destino] = {
                                            intFrecuency : 0
                                            , fltBaseFee : 0
                                            , fltFullFee : 0
                                            , fltRAD : 0
                                            , fltEAD : 0
                                            , fltACK : 0
                                            , fltSEG : 0
                                            , fltTotalNormal : 0
                                        };
                                    $scope.EX.mapRanges[destino] = {
                                        'PAQ': {fltFrecc: 0, intQTotal:0}
                                        , 'ZP' :{fltFrecc: 0, intQTotal:0}
                                        , 'T7' :{fltFrecc: 0, intQTotal:0}
                                    }
                                    //$scope.EX.mapQuotes[keyFee][destino] = {};
                                    if(keyFee !== 'T7' && !keyFee.includes('T7_'))
                                        $scope.EX.mapQuotesZP[keyFee][destino] = {};
                                });
                            }
                        } else {
                            var keyRange = getId(quoteItem.Rango_KM__c, $scope.EX.listRange);
                            if(!getLabel(key, $scope.EX.mapBlock)){
                                $scope.addBlock(quoteItem.PackWeightAVG__c);
                                j$.each($scope.listBlocksByMaxW, function (k, val) {
                                        if(val.value === $scope.EX.mapBlock[key].fltMaxW)
                                            val.vol = quoteItem.PackVolAVG__c;
                                });
                            }
                        }
                        if(getLabel(key, $scope.EX.mapBlock) && quoteItem.PackVolAVG__c && quoteItem.GUIA__c ){
                            $scope.EX.mapBlock[key].fltVolW = quoteItem.PackVolAVG__c;
                            $scope.EX.mapBlock[key].fltVolWeight = quoteItem.PackVolAVG__c * 200;
                            $scope.EX.mapBlock[key].ranges[keyRange].fltCost = quoteItem.GUIA__c;
                        }
                        if(getLabel('T7'+ quoteItem.PackWeightAVG__c, $scope.EX.mapBlock) && quoteItem.PackVolAVG__c && quoteItem.GUIA__c ){
                            $scope.EX.mapBlock['T7'+ quoteItem.PackWeightAVG__c].fltVolW = quoteItem.PackVolAVG__c;
                            $scope.EX.mapBlock['T7'+ quoteItem.PackWeightAVG__c].fltVolWeight = quoteItem.PackVolAVG__c * 200;
                            $scope.EX.mapBlock['T7'+ quoteItem.PackWeightAVG__c].ranges[keyRange].fltCost = quoteItem.GUIA__c;
                        }
                        $scope.EX.mapService['Add'].ranges[keyRange].fltCostWeight = quoteItem.KG_ADICIONAL__c;
                        $scope.EX.mapService['Add'].ranges[keyRange].fltCostVol = quoteItem.KG_ADICIONAL__c * 200;
                        if (quoteItem.ZonaPlus__c) {
                            $scope.EX.mapService['ZP'].ranges[keyRange].fltCost = quoteItem.EAD__c;
                            $scope.EX.mapFreccZP[keyFee].ranges[keyRange].intFrecuency = quoteItem.SBQQ__Quantity__c;
                            $scope.EX.mapFreccZP[keyFee].ranges[keyRange].Id = quoteItem.Id;
                            $scope.EX.mapFreccZP[keyFee].ranges[keyRange].SBQQ__Quote__c = quoteItem.SBQQ__Quote__c;

                        } else {
                            if (quoteItem.PackWeightAVG__c > 60) {
                                if (notEmpty(quoteItem.Destiny__c)){
                                    $scope.EX.OWFrecc['T7_' + quoteItem.PackWeightAVG__c].ranges[destino].intFrecuency = quoteItem.SBQQ__Quantity__c;
                                    $scope.EX.OWFrecc['T7_' + quoteItem.PackWeightAVG__c].ranges[destino].Id = quoteItem.Id;
                                    $scope.EX.OWFrecc['T7_' + quoteItem.PackWeightAVG__c].ranges[destino].SBQQ__Quote__c = quoteItem.SBQQ__Quote__c;
                                    $scope.fillRangesByDestiny();
                                } else {
                                    $scope.EX.OWFrecc['T7_' + quoteItem.PackWeightAVG__c].ranges[keyRange].intFrecuency = quoteItem.SBQQ__Quantity__c;
                                    $scope.EX.OWFrecc['T7_' + quoteItem.PackWeightAVG__c].ranges[keyRange].Id = quoteItem.Id;
                                    $scope.EX.OWFrecc['T7_' + quoteItem.PackWeightAVG__c].ranges[keyRange].SBQQ__Quote__c = quoteItem.SBQQ__Quote__c;
                                    $scope.EX.OWFrecc['T7_' + quoteItem.PackWeightAVG__c].ranges[keyRange].fltAVGVol = quoteItem.PackVolAVG__c;
                                }
                            } else {
                                $scope.EX.mapFrecc[keyFee].ranges[keyRange].intFrecuency = quoteItem.SBQQ__Quantity__c;
                                $scope.EX.mapFrecc[keyFee].ranges[keyRange].Id = quoteItem.Id;
                                $scope.EX.mapFrecc[keyFee].ranges[keyRange].SBQQ__Quote__c = quoteItem.SBQQ__Quote__c;
                                if(keyFee === 'T7'){
                                    $scope.EX.mapFrecc['T7'].ranges[keyRange].fltAVGWeight = quoteItem.Weight__c;
                                    $scope.EX.mapFrecc['T7'].ranges[keyRange].fltAVGVol = quoteItem.Width__c;
                                }
                            }
                        }
                        if(notEmpty($scope.EX.strACK))
                            $scope.EX.mapService['ACK'].ranges[keyRange].fltCost = quoteItem.ACK__c;
                    });
                    $scope.calculateXY();
                    $scope.updateFees('add', 'service');
                    $scope.calculateEX();
                }
                callGetHierarchy($scope);
            }]);
            /*
            * Angular module filters
            */
            app.filter('percentage', ['$filter', function ($filter) {
                return function (input, decimals) {
                    return $filter('number')(input * 100, decimals) + '%';
                };
            }]);
            // JSRemoting Call InitialInfo
           function callGetHierarchy($scope) {
                j$.blockUI({ message: '<h3><span class="glyphicon glyphicon-time"></span> Por favor espere... </h3>' });
                $scope.sent = true;
                Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.PAQ_CotizadorNacional_CTR.getHierarchyUser}'
                        , function (result, event) {
                            debugger;
                            if (event.status) {
                                $scope.Wrapper.mapHierarchy = result.mapHierarchy;
                                j$.each(result.mapHierarchy,
                                        function(key, userId){
                                              if(key.toUpperCase().includes('SUPERVISOR_TELEMARKETING'))
                                                $scope.Managers['KAM'] = userId;
                                           
                                            else if(key.toUpperCase().includes('GERENCIA_MARKETING_Y_PDV'))
                                                $scope.Managers['GDS'] = userId;
                                           
                                            else if(key.toUpperCase().includes('DIRECTOR_COMERCIAL'))
                                                $scope.Managers['DCO'] = userId;
                                        }
                                );
                                if(!notEmpty($scope.Managers['GSU']) && $scope.Wrapper.objEstructura && notEmpty($scope.Wrapper.objEstructura.Gerente_Sucursal__c))
                                    $scope.Managers['GSU'] = $scope.Wrapper.objEstructura.Gerente_Sucursal__c;
                                if(!notEmpty($scope.Managers['KAM']) && $scope.Wrapper.objEstructura && notEmpty($scope.Wrapper.objEstructura.KAM_regional__c))
                                    $scope.Managers['KAM'] = $scope.Wrapper.objEstructura.KAM_regional__c;
                                if(!notEmpty($scope.Managers['GDS']) && $scope.Wrapper.objEstructura && notEmpty($scope.Wrapper.objEstructura.Gerente_desarrollo_de_negocios__c ))
                                    $scope.Managers['GDS'] = $scope.Wrapper.objEstructura.Gerente_desarrollo_de_negocios__c ;
                                if(!notEmpty($scope.Managers['DCO']) && $scope.Wrapper.objEstructura && notEmpty($scope.Wrapper.objEstructura.Director_Comercial__c))
                                    $scope.Managers['DCO'] = $scope.Wrapper.objEstructura.Director_Comercial__c;
                                
                                $scope.$apply();
                                j$.unblockUI();
                            }
                            else {
                                $scope.DML.blnSuccess = false;
                                $scope.DML.listErrors.push(logErrorMessage(event.message.split(',')));
                                $scope.$apply();
                                j$.unblockUI();
                            }
                        },
                        {escape: false, timeout: 120000}
                );
            }

            function callCreateQuoteConv($scope, objQuote, listQuoteItem, leadObj, oppObj, listSS){
                j$.blockUI({ message: '<h3><span class="glyphicon glyphicon-time"></span> Por favor espere... </h3>' });
                $scope.SuccessMessage = '';
                $scope.sent = true;
                $scope.Wrapper.objQuote = {};//Se inicializa el objeto antes de llamar a la función de grabado.
                Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.PAQ_CotizadorNacional_CTR.saveQuoteConv}'
                        , objQuote
                        , listQuoteItem
                        , leadObj
                        , oppObj
                        , listSS
                        , function (result, event) {
                            //debugger;
                            if (event.status) {
                                $scope.DML.blnSuccess = true;
                                $scope.DML.listErrors = [];
                                    if($scope.DML.blnSuccess
                                            && (!$scope.Wrapper.objQuote || !$scope.Wrapper.objQuote.Id)
                                            && result.objQuote && result.objQuote.Name
                                    ){
                                        $scope.Wrapper.objQuote.Id  =  result.objQuote.Id;
                                        $scope.Wrapper.objQuote.Name =  result.objQuote.Name;
                                        $scope.DML.objQuote = result.objQuote;
                                    }
                                    if(!$scope.DML.blnSuccess){
                                        $scope.DML.blnSuccess = false;
                                        j$.each(result.listErrors, function (i, error) {
                                            if($scope.DML.listErrors.indexOf(error) === -1)
                                                $scope.DML.listErrors.push(error);
                                        });
                                    }
                                if($scope.DML.blnSuccess)
                                    $scope.SuccessMessage = 'Se han guardado los cambios con exito.';
                                $scope.$apply();
                                j$.unblockUI();

                            } else {
                                $scope.DML.blnSuccess = false;
                                $scope.DML.listErrors.push(logErrorMessage(event.message.split(',')));
                                $scope.$apply();
                                j$.unblockUI();
                            }
                        },
                        {escape: false, timeout: 120000}
                );
            }

            function callUpdateQuoteConv($scope, objQuote, listQuoteItem, leadObj, oppObj, listDeleteItems, listSS, listDELSS) {
                j$.blockUI({ message: '<h3><span class="glyphicon glyphicon-time"></span> Por favor espere... </h3>' });
                $scope.SuccessMessage = '';
                $scope.sent = true;
                Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.PAQ_CotizadorNacional_CTR.updateQuoteConv}'
                        , objQuote
                        , listQuoteItem
                        , leadObj
                        , oppObj
                        , listDeleteItems
                        , listSS
                        , listDELSS
                        , function (result, event) {
                            //debugger;
                            if (event.status) {
                                $scope.DML.blnSuccess = true;
                                $scope.DML.listErrors = [];
                                if($scope.DML.blnSuccess
                                        && (!$scope.Wrapper.objQuote || !$scope.Wrapper.objQuote.Id)
                                        && result.objQuote && result.objQuote.Name
                                ){
                                    $scope.Wrapper.objQuote.Id  =  result.objQuote.Id;
                                    $scope.Wrapper.objQuote.Name =  result.objQuote.Name;
                                    $scope.DML.objQuote = result.objQuote;
                                }
                                if(!$scope.DML.blnSuccess){
                                    $scope.DML.blnSuccess = false;
                                    j$.each(result.listErrors, function (i, error) {
                                        if($scope.DML.listErrors.indexOf(error) === -1)
                                            $scope.DML.listErrors.push(error);
                                    });
                                }
                                if($scope.DML.blnSuccess)
                                    $scope.SuccessMessage = 'Se han guardado los cambios con exito.';
                                $scope.$apply();
                                j$.unblockUI();
                            }
                            else {
                                $scope.DML.blnSuccess = false;
                                $scope.DML.listErrors.push(logErrorMessage(event.message.split(',')));
                                $scope.$apply();
                                j$.unblockUI();
                            }
                        },
                        {escape: false, timeout: 120000}
                );
            }

            function callSent($scope, strIdQuote, strNameAP) {
                j$.blockUI({ message: '<h3><span class="glyphicon glyphicon-time"></span> Por favor espere... </h3>' });
                $scope.SuccessMessage = '';
                $scope.sent = true;
                Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.PAQ_CotizadorNacional_CTR.sumbitAPP}'
                        , strIdQuote
                        , strNameAP
                        , ''
                        , function (result, event) {
                            debugger;
                            if (event.status) {
                                $scope.DML = result;
                                if(result.blnSuccess)
                                    $scope.SuccessMessage = 'La cotización se ha enviado a revisión';
                                $scope.$apply();
                                j$.unblockUI();
                            }
                            else {
                                $scope.DML.blnSuccess = false;
                                $scope.DML.listErrors.push(logErrorMessage(event.message.split(',')));
                                $scope.$apply();
                                j$.unblockUI();
                            }
                        },
                        {escape: false, timeout: 120000}
                );
            }

            function callUpdateStatus($scope, objQuote, strName) {
                j$.blockUI({ message: '<h3><span class="glyphicon glyphicon-time"></span> Por favor espere... </h3>' });
                $scope.SuccessMessage = '';
                $scope.sent = true;
                Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.PAQ_CotizadorNacional_CTR.updateStatusQuote}'
                        , objQuote
                        , strName
                        , function (result, event) {
                            debugger;
                            if (event.status) {
                                $scope.DML = result;
                                if(result.blnSuccess)
                                    $scope.SuccessMessage = 'La cotización se ha autorizado automáticamente';

                                $scope.$apply();
                                j$.unblockUI();
                            }
                            else {
                                $scope.DML.blnSuccess = false;
                                $scope.DML.listErrors.push(logErrorMessage(event.message.split(',')));
                                $scope.$apply();
                                j$.unblockUI();
                            }
                        },
                        {escape: false, timeout: 120000}
                );
            }

            function callCheckDestiny($scope) {
                j$.blockUI({ message: '<h3><span class="glyphicon glyphicon-time"></span> Por favor espere... </h3>' });
                $scope.SuccessMessage = '';
                $scope.sent = true;
                $scope.DestinyErrorMessage = '';
                $scope.DestinySuccessMessage = '';
                Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.PAQ_CotizadorNacional_CTR.checkDestiny}'
                        , $scope.EX.strOrigin
                        , $scope.EX.strDestiny
                        , function (result, event) {
                            //debugger;
                            if (event.status) {
                                $scope.DML = result;
                                if(result.blnSuccess){
                                    var strDestiny = $scope.EX.strDestiny;
                                    $scope.DestinySuccessMessage = 'Se ha agregado el destino!';
                                    $scope.EX.listDestiny[strDestiny] = {
                                        range: result.strDestinyKM
                                        , name: strDestiny +' ('+ result.strDestinyKM +')'
                                    } ;
                                    $scope.insertRange(strDestiny, result.strDestinyKM);
                                    $scope.EX.mapService['Add'].ranges[strDestiny] = { fltCostWeight : 0, fltCostVol : 0};
                                    $scope.EX.mapService['ACK'].ranges[strDestiny] = { fltCost : 0 };
                                    $scope.EX.mapService['ZP'].ranges[strDestiny] = { fltCost : 0 };
                                    j$.each($scope.listFee, function (keyFee, strFee) {
                                        if(!keyFee.includes('T7_')){
                                            $scope.EX.mapFrecc[keyFee].ranges[strDestiny] = {
                                                intFrecuency : 0
                                                , fltBaseFee : 0
                                                , fltFullFee : 0
                                                , fltRAD : 0
                                                , fltEAD : 0
                                                , fltACK : 0
                                                , fltSEG : 0
                                                , fltTotalNormal : 0
                                            };
                                            $scope.EX.mapFreccZP[keyFee].ranges[strDestiny] = {
                                                intFrecuency : 0
                                                , fltBaseFee : 0
                                                , fltFullFee : 0
                                                , fltRAD : 0
                                                , fltEAD : 0
                                                , fltACK : 0
                                                , fltSEG : 0
                                                , fltTotalNormal : 0
                                            };
                                            j$.each($scope.EX.mapLimits, function (keyFee, limits) {
                                                j$.each($scope.EX.mapBlock, function (range, item) {
                                                    var key = keyFee;
                                                    var strKey = item.fltMaxW.toString();
                                                    key += strKey.replace('.', '_');
                                                    if(item.fltMaxW > limits.min && item.fltMaxW <= limits.max){
                                                        debugger;
                                                        if(!getLabel(key, $scope.EX.mapBlock)){
                                                            $scope.EX.mapBlock[key] = {
                                                                strLabel : keyFee
                                                                , fltMaxW : item.fltMaxW
                                                                , fltVolW : 0
                                                                , fltVolWeight: 0
                                                                , blnSameCost : false
                                                                , ranges : {}
                                                            };
                                                        }
                                                            $scope.listBlocksByMaxW.push({key:key, value: item.fltMaxW});
                                                            j$.each($scope.EX.listRange, function (keyRange, strRange) {  
                                                                if(!getLabel(keyRange, $scope.EX.mapBlock[key].ranges)){
                                                                    $scope.EX.mapBlock[key].ranges[keyRange] = {
                                                                        fltCost : 0
                                                                    };
                                                                }
                                                            });
                                                        
                                                        
                                                    }
                                                });
                                            });
                                        } else {
                                            var key = '';
                                            key = keyFee.replace('_', '');
                                            $scope.EX.mapBlock[key].ranges[strDestiny] = {
                                                fltCost : 0
                                            }
                                            $scope.EX.OWFrecc[keyFee].ranges[strDestiny] = {
                                                intFrecuency : 0
                                                , fltBaseFee : 0
                                                , fltBaseFeeP : 0
                                                , fltFullFee : 0
                                                , fltFullFeeP : 0
                                                , fltRAD : 0
                                                , fltRADP : 0
                                                , fltEAD : 0
                                                , fltEADP : 0
                                                , fltACK : 0
                                                , fltACKP : 0
                                                , fltSEG : 0
                                                , fltTotalNormal : 0
                                                , fltTotalNormalP : 0
                                                , fltAVGVol : $scope.EX.mapBlock[key].fltMaxV
                                                , fltAVGWeight : $scope.EX.mapBlock[key].fltMaxW
                                            };
                                        }
                                        $scope.EX.mapRanges[strDestiny] = {
                                            'PAQ': {fltFrecc: 0, intQTotal:0}
                                            , 'ZP' :{fltFrecc: 0, intQTotal:0}
                                            , 'T7' :{fltFrecc: 0, intQTotal:0}
                                        }
                                        $scope.EX.mapQuotes[keyFee][strDestiny] = {};
                                        if(keyFee !== 'T7' && !keyFee.includes('T7_'))
                                            $scope.EX.mapQuotesZP[keyFee][strDestiny] = {};
                                    });
                                }
                                else
                                    $scope.DestinyErrorMessage = 'Destino no válido!';

                                $scope.$apply();
                                j$.unblockUI();
                            }
                            else {
                                $scope.DML.blnSuccess = false;
                                $scope.DML.listErrors.push(logErrorMessage(event.message.split(',')));
                                $scope.$apply();
                                j$.unblockUI();
                            }
                        },
                        {escape: false, timeout: 120000}
                );
            }

            function dominantFeeServiceDom(fltMinFee, fltAmount) {
                var fltFee = fltAmount * 0.11;
                if(fltMinFee > fltFee)
                    return fltMinFee;
                else
                    return fltFee;
            }

            function getLabel(strId, arrayOptions) {
                var model;
                j$.each(arrayOptions
                        ,function (key, value) {
                            if(key === strId)
                                model = value;
                        }
                );
                return model
            }

            function getModel(strId, arrayOptions) {
                var model;
                j$.each(arrayOptions
                        ,function (key, value) {
                            if(value.id === strId)
                                model = value;
                        }
                );
                return model
            }

            function getId(strLabel, arrayOptions) {
                var model;
                j$.each(arrayOptions
                        ,function (key, value) {
                            if(value === strLabel)
                                model = key;
                        }
                );
                return model
            }

            function getNum(strNum) {
                if(notEmpty(strNum))
                    if(strNum.length > 3 && strNum.indexOf(',') !== -1)
                        strNum = strNum.replace(',', '');
                    if(isNaN(strNum))
                        return 0;
                    else
                        return parseFloat(strNum);
            }

            function getNumFromCurrency(strNum) {
                var subStr = '';
                if(notEmpty(strNum)){
                    if(strNum.indexOf('$') !== -1)
                        subStr = strNum.substring(1, strNum.length);
                    else
                        subStr = strNum;
                    if(subStr.length > 3 && strNum.indexOf(',') !== -1)
                        subStr = subStr.replace(',', '');
                    if(isNaN(subStr))
                        return 0;
                    else
                        return parseFloat(subStr);
                } else
                    return 0;
            }

            function getNumFromPercent(str) {
                var strNum = '';
                var index = str.indexOf("%");
                strNum = str.slice(0, index);
                /*if (getNum(strNum) > 0)
                    return  getNum(strNum) / 100;
                else
                    return 0;*/
                if (getNum(str) > 0)
                    return  getNum(str) / 100;
                else
                    return 0;
            }

            function getRange(strRange){ //VER (0-400)
                return strRange.substring(5, strRange.length-1);
            }

            function isArrayEmpy(obj){
                for(var key in obj) {
                    if(obj.hasOwnProperty(key))
                        return false;
                }
                return true;
            }

            function isIn(strFee, arrayFee){
                return j$.inArray(strFee, arrayFee) !== -1;
            }

            function notEmpty(str){
                return str !== undefined  && str !== "" && str!== null;
            }

            function logErrorMessage (messages){
                var errorMessage = messages;
                if (errorMessage[1] !== undefined) {
                    errorMessage = errorMessage[1].split(':');
                }
                else {
                    errorMessage = errorMessage[0].split(':');
                }
                return errorMessage[0];
            }
            function ObtieneTarifaLlena(decPesoPred, decExc){
                //29/09/2020 Salvador: Función para obtener el total de tarifa llena para la tarifa T7 ZP
                var decTarifaLlena = 0;
                if (decPesoPred !== 0 && decExc !== 0)
                    decTarifaLlena = 208.5 + ((decPesoPred - 60) * decExc);
                return decTarifaLlena;
            }
            function ObtieneTotalTarifaLlena(intPaq, fltFullFee){
                var fltTarLlena = 0;
                if (fltFullFee !== 0 && intPaq !== 0)
                    fltTarLlena = fltFullFee * intPaq;
                return fltTarLlena;
            }
            function ObtienePesoVolum(fltLargo, fltAncho, fltAlto){
                var fltPesoVol = 0
                if (fltLargo !== 0 && fltAncho !== 0 && fltAlto !== 0)
                    fltPesoVol = (fltLargo * fltAncho * fltAlto) / 5000;
                return fltPesoVol
            }
            function ObtienePesoDominante(decPeso, decPesoVol){
                //29/09/2020 Salvador: Función para obtener el peso dominante para la tarifa T7 ZP
                var decPesoDominante = 0;
                if (decPesoVol > decPeso)
                    decPesoDominante = decPesoVol;
                else decPesoDominante = decPeso;
                return decPesoDominante;
            }
            function ObtieneTarifaPropuesta(fltCostoPropuestoXKg, fltPesoPred){
                return fltCostoPropuestoXKg * fltPesoPred;
            }
        })();
    </script>
</apex:component>
